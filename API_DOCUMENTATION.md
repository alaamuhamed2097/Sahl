# ?? API Documentation - Version Manager

## ?? JavaScript API

### window.VersionManager

?????? ??????? ?????? ?????????.

---

## ?? ?????? ???????

### 1. `VersionManager.init()`
**?????:** ????? ???? ????? ?????????  
**?????????:** ??? ???????? ??? ????? ??????  
**?????????:** ?? ????  
**?????? ???????:** `void`

```javascript
// ??? ????????
VersionManager.init();
```

---

### 2. `VersionManager.checkForUpdates(isInitial)`
**?????:** ??? ???? ??????? ?????  
**?????????:**
- `isInitial` (boolean, optional): ?? ??? ????? ??????? (?????????: false)

**?????? ???????:** `Promise<void>`

```javascript
// ??? ????
await VersionManager.checkForUpdates(false);

// ??? ???? (??? ???????)
await VersionManager.checkForUpdates(true);
```

---

### 3. `VersionManager.manualCheck()`
**?????:** ??? ???? ????????? (????????? ?? UI)  
**?????????:** ?? ????  
**?????? ???????:** `Promise<void>`

```javascript
// ??????? ?? ??
document.getElementById('check-updates-btn').onclick = async () => {
    await VersionManager.manualCheck();
};
```

**???? ?? Blazor:**
```csharp
@inject IJSRuntime JS

private async Task CheckForUpdates()
{
    await JS.InvokeVoidAsync("VersionManager.manualCheck");
}
```

---

### 4. `VersionManager.performUpdate(newVersion, forceUpdate)`
**?????:** ????? ??????? (?????)  
**?????????:**
- `newVersion` (string): ??? ??????? ??????
- `forceUpdate` (boolean): ?? ?? ????? ???????

**?????? ???????:** `Promise<void>`

```javascript
// ????????? ??????? ???
await VersionManager.performUpdate('1.0.1', false);
```

---

## ?? ?????????

### Constants

```javascript
// ???? ????? ?????? (5 ?????)
const VERSION_CHECK_INTERVAL = 300000;

// ????? ????? ???????
const VERSION_STORAGE_KEY = 'app_version';

// ????? ????? ??? ???
const LAST_CHECK_KEY = 'version_last_check';
```

### ????? ?????????:

```javascript
// ?? version-manager.js
const VERSION_CHECK_INTERVAL = 180000; // 3 ?????
```

---

## ?? localStorage API

### ???????

```javascript
// ?????? ??? ??????? ??????
const version = localStorage.getItem('app_version');
console.log('Current version:', version);

// ?????? ??? ??? ??? ???
const lastCheck = localStorage.getItem('version_last_check');
const date = new Date(parseInt(lastCheck));
console.log('Last check:', date);
```

### ???????

```javascript
// ??? ????? ???? (?? ????? ??)
localStorage.setItem('app_version', '1.0.1');

// ??? ??? ?????
localStorage.setItem('version_last_check', Date.now().toString());
```

---

## ?? Events

### Custom Events

?????? ?? ???? events ?????? ??? ????? ???????? ???:

```javascript
// ??? ??? Blazor
window.addEventListener('blazor-started', () => {
    console.log('Blazor started!');
});

// ??? ????? visibility
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        console.log('Tab became visible');
    }
});
```

---

## ??? Utility Functions

### ??? ????? ??????

```javascript
async function clearAllCaches() {
    try {
        // ??? Cache API
        if ('caches' in window) {
            const names = await caches.keys();
            await Promise.all(names.map(name => caches.delete(name)));
        }
        
        // ??? Service Workers
        if ('serviceWorker' in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            for (const reg of regs) {
                await reg.unregister();
            }
        }
        
        console.log('? Cache cleared');
    } catch (error) {
        console.error('? Error:', error);
    }
}
```

### ?????? ??? ??????? ?????

```javascript
async function getCacheInfo() {
    if (!('caches' in window)) {
        return { supported: false };
    }
    
    const info = [];
    const names = await caches.keys();
    
    for (const name of names) {
        const cache = await caches.open(name);
        const keys = await cache.keys();
        info.push({
            name: name,
            itemCount: keys.length,
            urls: keys.map(req => req.url)
        });
    }
    
    return { supported: true, caches: info };
}

// ?????????
const info = await getCacheInfo();
console.log('Cache info:', info);
```

### ??? ????? ???????

```javascript
function forceReload() {
    // Method 1: Hard reload
    location.reload(true);
    
    // Method 2: With cache bust
    const url = location.href.split('?')[0];
    location.href = url + '?refresh=' + Date.now();
}
```

---

## ?? Debugging

### Console Commands

```javascript
// 1. ??? ??????? ??????
localStorage.getItem('app_version')

// 2. ??? ???? ?????????
await VersionManager.manualCheck()

// 3. ??? ???? ?????? localStorage
Object.keys(localStorage)

// 4. ??? ?? ??? ?????? ???????
localStorage.clear();
sessionStorage.clear();
caches.keys().then(n => Promise.all(n.map(k => caches.delete(k))));
location.reload(true);

// 5. ?????? ????? ????
localStorage.setItem('app_version', '0.0.1');
await VersionManager.checkForUpdates();
```

### DevTools Inspection

```javascript
// Application Tab ? Local Storage
// Application Tab ? Cache Storage
// Application Tab ? Service Workers
// Network Tab ? ????? version.json
```

---

## ?? Use Cases

### 1. ?? "??? ?????????" ?? ?????????

```html
<button onclick="checkForUpdates()">
    ??? ?????????
</button>

<script>
async function checkForUpdates() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '???? ?????...';
    
    try {
        await VersionManager.manualCheck();
        // ??? ?? ??? reload? ?????? ?? ???? ?????
        btn.textContent = '? ????';
        setTimeout(() => {
            btn.textContent = '??? ?????????';
            btn.disabled = false;
        }, 2000);
    } catch (error) {
        btn.textContent = '? ???';
        console.error(error);
    }
}
</script>
```

### 2. ??? ??????? ?? Footer

```html
<footer>
    <span id="app-version">???? ???????...</span>
</footer>

<script>
const version = localStorage.getItem('app_version') || '??? ?????';
document.getElementById('app-version').textContent = `???????: ${version}`;
</script>
```

### 3. ????? ??? ???????

```javascript
// ????? ?????????
const originalPerformUpdate = VersionManager.performUpdate;
VersionManager.performUpdate = async function(newVersion, forceUpdate) {
    console.log(`?? Updating to ${newVersion}`);
    
    // ??? ??? ???? ???
    if (typeof gtag !== 'undefined') {
        gtag('event', 'app_updated', { version: newVersion });
    }
    
    // ??? ??????? ??????
    return originalPerformUpdate.call(this, newVersion, forceUpdate);
};
```

---

## ?? Best Practices

### ? ????:

```javascript
// 1. ?????? VersionManager.manualCheck() ????? ??????
await VersionManager.manualCheck();

// 2. ???? ?? ????? ??? ??????? APIs
if ('caches' in window) {
    // ?????? Cache API
}

// 3. ????? ?? ???????
try {
    await VersionManager.checkForUpdates();
} catch (error) {
    console.error('Update check failed:', error);
}
```

### ? ?? ????:

```javascript
// 1. ?? ????? version.json ??????
// ?????? update-version.ps1 ????? ?? ???

// 2. ?? ?????? performUpdate ??????
// await VersionManager.performUpdate('1.0.1', false); // ?

// 3. ?? ???? localStorage ???? ??????
// localStorage.clear(); // ? ????? ???????? ???????
```

---

## ?? Integration Examples

### ?? Blazor Component

```razor
@inject IJSRuntime JS

<div class="version-check">
    <button class="btn btn-primary" @onclick="CheckVersion">
        ??? ?????????
    </button>
    @if (updateStatus != null)
    {
        <div class="alert @alertClass">@updateStatus</div>
    }
</div>

@code {
    private string? updateStatus;
    private string alertClass = "alert-info";

    private async Task CheckVersion()
    {
        updateStatus = "???? ?????...";
        alertClass = "alert-info";
        StateHasChanged();

        try
        {
            await JS.InvokeVoidAsync("VersionManager.manualCheck");
            
            // ??? ?? ???? reload? ?????? ?? ???? ?????
            await Task.Delay(2000);
            updateStatus = "? ??????? ????";
            alertClass = "alert-success";
        }
        catch (Exception ex)
        {
            updateStatus = $"? ???: {ex.Message}";
            alertClass = "alert-danger";
        }
        
        StateHasChanged();
    }
}
```

### ?? SignalR

```javascript
// ????? ?????????? ???????? ??? SignalR
connection.on("NewVersionAvailable", (version) => {
    console.log(`?? New version available: ${version}`);
    
    // ????? version.json ?? ???????
    fetch('/version.json', { cache: 'reload' })
        .then(() => VersionManager.manualCheck());
});
```

---

## ?? Monitoring & Analytics

### ???? ?????????

```javascript
// ????? ???? Google Analytics
const originalPerformUpdate = VersionManager.performUpdate;
VersionManager.performUpdate = async function(newVersion, forceUpdate) {
    // ???? event
    if (typeof gtag !== 'undefined') {
        gtag('event', 'version_update', {
            'event_category': 'App',
            'event_label': newVersion,
            'force_update': forceUpdate
        });
    }
    
    return originalPerformUpdate.call(this, newVersion, forceUpdate);
};
```

### ????? ???????

```javascript
const originalCheckForUpdates = VersionManager.checkForUpdates;
VersionManager.checkForUpdates = async function(isInitial) {
    try {
        return await originalCheckForUpdates.call(this, isInitial);
    } catch (error) {
        // ???? ??? error tracking service
        if (typeof Sentry !== 'undefined') {
            Sentry.captureException(error);
        }
        throw error;
    }
};
```

---

## ?? Security Considerations

### ?????? ?? ???????

```javascript
// ?? ?????? (API)
[HttpGet("version")]
public IActionResult GetVersion()
{
    var version = new {
        version = "1.0.1",
        buildDate = DateTime.UtcNow,
        forceUpdate = false,
        // ????? signature ??????
        signature = ComputeSignature("1.0.1")
    };
    
    return Ok(version);
}
```

### ??? Cache Poisoning

```javascript
// ?? version-manager.js
const response = await fetch('/version.json?t=' + Date.now(), {
    cache: 'no-cache',
    headers: {
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache'
    },
    // ????? integrity check ??? ??? ?????
    integrity: 'sha256-...'
});
```

---

**?? ?????? ?? ???????? ????:**
- `CACHE_UPDATE_SYSTEM.md` - ?????? ??????
- `QUICK_START.md` - ???? ????? ??????
- `EXAMPLE_VERSION_SETTINGS.html` - ????? UI

---

**???????:** 1.0.0  
**??? ?????:** 2024
