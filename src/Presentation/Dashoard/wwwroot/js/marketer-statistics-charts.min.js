function initializeChartsWithData(n,t){try{if(typeof Highcharts=="undefined")throw new Error("Highcharts is not available after loading");const i=initializeCommissionChart(n),r=initializeReferralChart(t);if(i&&r)return console.log("Both charts initialized successfully"),!0;throw new Error("One or more charts failed to initialize");}catch(i){console.error("Error initializing marketer charts:",i);showChartErrorIndicators("Error initializing charts: "+i.message)}}function showChartLoadingIndicators(){const n=`
        <div class="text-center text-muted p-4">
            <div class="spinner-border spinner-border-sm mb-2" role="status" aria-hidden="true"></div>
            <p class="mb-0">Loading charts...</p>
            <small class="text-muted">This may take a moment</small>
        </div>
    `,t=document.getElementById("commissionChart"),i=document.getElementById("referralChart");t&&(t.innerHTML=n);i&&(i.innerHTML=n)}function showChartErrorIndicators(n){const t=`
        <div class="text-center text-muted p-4">
            <i class="fas fa-exclamation-triangle fa-2x mb-2 text-warning" aria-hidden="true"></i>
            <p class="mb-2">${n}</p>
            <button class="btn btn-sm btn-outline-primary" onclick="retryChartLoading()" type="button">
                <i class="fas fa-redo" aria-hidden="true"></i> Retry
            </button>
            <br><small class="text-muted mt-2 d-block">Check your internet connection</small>
        </div>
    `,i=document.getElementById("commissionChart"),r=document.getElementById("referralChart");i&&(i.innerHTML=t);r&&(r.innerHTML=t)}function initializeCommissionChart(n){try{if(console.log("Initializing commission chart with data:",n),typeof Highcharts=="undefined")throw new Error("Highcharts is not available");Array.isArray(n)&&n.length!==0||(console.warn("No commission data provided, showing empty chart"),n=[{period:"No Data",amount:0}]);const i=n.map(n=>n.period||"Unknown"),r=n.map(n=>parseFloat(n.amount)||0),t=Highcharts.charts.find(n=>n&&n.container&&n.container.id==="commissionChart");t&&t.destroy();const u=Highcharts.chart("commissionChart",{chart:{type:"column",backgroundColor:"transparent",height:300},title:{text:null},xAxis:{categories:i,gridLineWidth:0},yAxis:{title:{text:"Amount"},min:0},tooltip:{pointFormat:"<b>{point.y:.2f}<\/b>"},legend:{enabled:!1},plotOptions:{column:{dataLabels:{enabled:!0,format:"{point.y:.0f}"}}},series:[{name:"Commissions",data:r,color:"#13bd8a"}],credits:{enabled:!1}});if(u)return console.log("Commission chart initialized successfully"),!0;throw new Error("Chart creation returned null");}catch(t){console.error("Error initializing commission chart:",t);const n=document.getElementById("commissionChart");return n&&(n.innerHTML=`<div class="text-center text-muted p-4">
                    <i class="fas fa-chart-bar fa-2x mb-2" aria-hidden="true"></i>
                    <p>Unable to load commission chart</p>
                    <small class="text-danger">${t.message}</small>
                </div>`),!1}}function initializeReferralChart(n){try{if(console.log("Initializing referral chart with data:",n),typeof Highcharts=="undefined")throw new Error("Highcharts is not available");Array.isArray(n)&&n.length!==0||(console.warn("No referral data provided, showing empty chart"),n=[{period:"No Data",count:0}]);const i=n.map(n=>n.period||"Unknown"),r=n.map(n=>parseInt(n.count)||0),t=Highcharts.charts.find(n=>n&&n.container&&n.container.id==="referralChart");t&&t.destroy();const u=Highcharts.chart("referralChart",{chart:{type:"line",backgroundColor:"transparent",height:300},title:{text:null},xAxis:{categories:i,gridLineWidth:0},yAxis:{title:{text:"Count"},min:0},tooltip:{pointFormat:"<b>{point.y}<\/b> referrals"},legend:{enabled:!1},plotOptions:{line:{dataLabels:{enabled:!0},marker:{enabled:!0,radius:4}}},series:[{name:"Referrals",data:r,color:"#19bcbf",lineWidth:3}],credits:{enabled:!1}});if(u)return console.log("Referral chart initialized successfully"),!0;throw new Error("Chart creation returned null");}catch(t){console.error("Error initializing referral chart:",t);const n=document.getElementById("referralChart");return n&&(n.innerHTML=`<div class="text-center text-muted p-4">
                    <i class="fas fa-chart-line fa-2x mb-2" aria-hidden="true"></i>
                    <p>Unable to load referral chart</p>
                    <small class="text-danger">${t.message}</small>
                </div>`),!1}}function renderDetailedCommissionChartInternal(n){try{if(!Array.isArray(n)||n.length===0)throw new Error("No data provided for detailed commission chart");const i=n.map(n=>[new Date(n.date).getTime(),parseFloat(n.amount)||0]),t=Highcharts.charts.find(n=>n&&n.container&&n.container.id==="commissionChart");t&&t.destroy();const r=Highcharts.chart("commissionChart",{chart:{type:"areaspline",backgroundColor:"transparent",height:300},title:{text:null},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%e %b",week:"%e %b",month:"%b '%y"}},yAxis:{title:{text:"Commission Amount"},min:0},tooltip:{shared:!0,formatter:function(){return"<b>"+Highcharts.dateFormat("%e %B %Y",this.x)+"<\/b><br/>Commission: <b>"+this.y.toFixed(2)+"<\/b>"}},legend:{enabled:!1},plotOptions:{areaspline:{fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#13bd8a"],[1,Highcharts.color("#13bd8a").setOpacity(0).get("rgba")]]}}},series:[{name:"Commission",data:i,color:"#13bd8a"}],credits:{enabled:!1}});return r!==null}catch(t){return console.error("Error rendering detailed commission chart:",t),!1}}function renderDetailedReferralChartInternal(n){try{if(!Array.isArray(n)||n.length===0)throw new Error("No data provided for detailed referral chart");const i=n.map(n=>[new Date(n.date).getTime(),parseInt(n.count)||0]),t=Highcharts.charts.find(n=>n&&n.container&&n.container.id==="referralChart");t&&t.destroy();const r=Highcharts.chart("referralChart",{chart:{type:"spline",backgroundColor:"transparent",height:300},title:{text:null},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%e %b",week:"%e %b",month:"%b '%y"}},yAxis:{title:{text:"Referral Count"},min:0},tooltip:{shared:!0,formatter:function(){return"<b>"+Highcharts.dateFormat("%e %B %Y",this.x)+"<\/b><br/>New Referrals: <b>"+this.y+"<\/b>"}},legend:{enabled:!1},series:[{name:"Referrals",data:i,color:"#19bcbf",lineWidth:3,marker:{enabled:!0,radius:4}}],credits:{enabled:!1}});return r!==null}catch(t){return console.error("Error rendering detailed referral chart:",t),!1}}function renderPVTrendChartInternal(n){try{if(!Array.isArray(n)||n.length===0)throw new Error("No data provided for PV trend chart");const i=n.map(n=>[new Date(n.date).getTime(),parseInt(n.pvs)||0]),t=Highcharts.charts.find(n=>n&&n.container&&n.container.id==="pvChart");t&&t.destroy();const r=Highcharts.chart("pvChart",{chart:{type:"area",backgroundColor:"transparent",height:300},title:{text:null},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%e %b",week:"%e %b",month:"%b '%y"}},yAxis:{title:{text:"PV Points"},min:0},tooltip:{shared:!0,formatter:function(){return"<b>"+Highcharts.dateFormat("%e %B %Y",this.x)+"<\/b><br/>PV Points: <b>"+this.y+"<\/b>"}},legend:{enabled:!1},plotOptions:{area:{fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#FF9764"],[1,Highcharts.color("#FF9764").setOpacity(0).get("rgba")]]}}},series:[{name:"PV Points",data:i,color:"#FF9764"}],credits:{enabled:!1}});if(r)return console.log("PV trend chart initialized successfully"),!0;throw new Error("Chart creation returned null");}catch(t){console.error("Error rendering PV trend chart:",t);const n=document.getElementById("pvChart");return n&&(n.innerHTML=`<div class="text-center text-muted p-4">
                    <i class="fas fa-chart-area fa-2x mb-2 text-warning" aria-hidden="true"></i>
                    <p>Unable to load PV trend chart</p>
                    <small class="text-danger">${t.message}</small>
                </div>`),!1}}window.initializeMarketerCharts=function(n,t){return console.log("Initializing marketer charts with data:",{commissionData:n,referralData:t}),window.lastChartData={commissionData:n,referralData:t},window.ScriptLoader.isHighchartsLoaded()?Promise.resolve(initializeChartsWithData(n,t)):(console.log("Highcharts not loaded, loading on demand..."),showChartLoadingIndicators(),window.ScriptLoader.loadHighcharts().then(()=>(console.log("Highcharts loaded successfully, initializing charts..."),initializeChartsWithData(n,t))).catch(n=>(console.error("Failed to load Highcharts:",n),showChartErrorIndicators("Failed to load chart library: "+n.message),Promise.reject(n))))};window.retryChartLoading=function(){if(console.log("Retrying chart loading..."),showChartLoadingIndicators(),typeof Highcharts!="undefined")try{["commissionChart","referralChart","pvChart"].forEach(n=>{const t=Highcharts.charts.find(t=>t&&t.container&&t.container.id===n);t&&t.destroy()})}catch(t){console.warn("Error cleaning up existing charts:",t)}const n=window.lastChartData||{commissionData:[],referralData:[]};window.ScriptLoader.loadHighcharts().then(()=>(console.log("Charts ready for retry, reinitializing..."),initializeChartsWithData(n.commissionData,n.referralData))).catch(n=>{console.error("Retry failed:",n),showChartErrorIndicators("Retry failed: "+n.message)})};window.renderDetailedCommissionChart=function(n){return window.ScriptLoader.isHighchartsLoaded()?Promise.resolve(renderDetailedCommissionChartInternal(n)):window.ScriptLoader.loadHighcharts().then(()=>renderDetailedCommissionChartInternal(n)).catch(n=>{console.error("Failed to load Highcharts for detailed commission chart:",n);throw n;})};window.renderDetailedReferralChart=function(n){return window.ScriptLoader.isHighchartsLoaded()?Promise.resolve(renderDetailedReferralChartInternal(n)):window.ScriptLoader.loadHighcharts().then(()=>renderDetailedReferralChartInternal(n)).catch(n=>{console.error("Failed to load Highcharts for detailed referral chart:",n);throw n;})};window.renderPVTrendChart=function(n){if(window.ScriptLoader.isHighchartsLoaded())return Promise.resolve(renderPVTrendChartInternal(n));else{const t=document.getElementById("pvChart");return t&&(t.innerHTML=`<div class="text-center text-muted p-4">
                    <div class="spinner-border spinner-border-sm mb-2" role="status" aria-hidden="true"></div>
                    <p>Loading chart library...</p>
                </div>`),window.ScriptLoader.loadHighcharts().then(()=>renderPVTrendChartInternal(n)).catch(n=>{console.error("Failed to load Highcharts for PV trend chart:",n);t&&(t.innerHTML=`<div class="text-center text-muted p-4">
                            <i class="fas fa-chart-area fa-2x mb-2 text-warning" aria-hidden="true"></i>
                            <p>Failed to load chart library</p>
                            <small class="text-danger">${n.message}</small>
                        </div>`);throw n;})}};window.disposeMarketerCharts=function(){try{return["commissionChart","referralChart","pvChart"].forEach(n=>{if(typeof Highcharts!="undefined"&&Highcharts.charts){const t=Highcharts.charts.find(t=>t&&t.container&&t.container.id===n);t&&(t.destroy(),console.log(`Chart ${n} destroyed`))}}),delete window.lastChartData,console.log("Marketer charts disposed successfully"),!0}catch(n){return console.error("Error disposing marketer charts:",n),!1}};window.renderCommissionChart=function(n){return window.initializeMarketerCharts(n,[])};window.renderReferralChart=function(n){return window.initializeMarketerCharts([],n)};window.debugChartState=function(){return{highchartsLoaded:typeof Highcharts!="undefined",scriptLoaderInfo:window.ScriptLoader.getEnvironmentInfo(),activeCharts:typeof Highcharts!="undefined"?Highcharts.charts.filter(n=>n).map(n=>({id:n.container.id,type:n.options.chart.type})):[],lastData:window.lastChartData}};