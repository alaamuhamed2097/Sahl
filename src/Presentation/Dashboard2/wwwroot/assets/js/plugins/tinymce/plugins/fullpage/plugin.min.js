(function(n){"use strict";function wt(){c.add("fullpage",function(n){var t=f(""),i=f("");ft.register(n,t);pt.register(n);vt.setup(n,t,i)})}var f=function(n){var t=n,i=function(){return t},r=function(n){t=n},u=function(){return f(i())};return{get:i,set:r,clone:u}},c=tinymce.util.Tools.resolve("tinymce.PluginManager"),u=function(){return u=Object.assign||function(n){for(var t,r,i=1,u=arguments.length;i<u;i++){t=arguments[i];for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n},u.apply(this,arguments)},t=tinymce.util.Tools.resolve("tinymce.util.Tools"),l=tinymce.util.Tools.resolve("tinymce.html.DomParser"),r=tinymce.util.Tools.resolve("tinymce.html.Node"),a=tinymce.util.Tools.resolve("tinymce.html.Serializer"),v=function(n){return n.getParam("fullpage_hide_in_source_view")},y=function(n){return n.getParam("fullpage_default_xml_pi")},p=function(n){return n.getParam("fullpage_default_encoding")},w=function(n){return n.getParam("fullpage_default_font_family")},b=function(n){return n.getParam("fullpage_default_font_size")},k=function(n){return n.getParam("fullpage_default_text_color")},d=function(n){return n.getParam("fullpage_default_title")},g=function(n){return n.getParam("fullpage_default_doctype","<!DOCTYPE html>")},i={shouldHideInSourceView:v,getDefaultXmlPi:y,getDefaultEncoding:p,getDefaultFontFamily:w,getDefaultFontSize:b,getDefaultTextColor:k,getDefaultTitle:d,getDefaultDocType:g},e=function(n){return l({validate:!1,root_name:"#document"}).parse(n,{format:"xhtml"})},nt=function(n,r){function s(n,t){var i=n.attr(t);return i||""}var o=e(r),f={},u,h;return f.fontface=i.getDefaultFontFamily(n),f.fontsize=i.getDefaultFontSize(n),u=o.firstChild,u.type===7&&(f.xml_pi=!0,h=/encoding="([^"]+)"/.exec(u.value),h&&(f.docencoding=h[1])),u=o.getAll("#doctype")[0],u&&(f.doctype="<!DOCTYPE"+u.value+">"),u=o.getAll("title")[0],u&&u.firstChild&&(f.title=u.firstChild.value),t.each(o.getAll("meta"),function(n){var i=n.attr("name"),r=n.attr("http-equiv"),t;i?f[i.toLowerCase()]=n.attr("content"):r==="Content-Type"&&(t=/charset\s*=\s*(.*)\s*/gi.exec(n.attr("content")),t&&(f.docencoding=t[1]))}),u=o.getAll("html")[0],u&&(f.langcode=s(u,"lang")||s(u,"xml:lang")),f.stylesheets=[],t.each(o.getAll("link"),function(n){n.attr("rel")==="stylesheet"&&f.stylesheets.push(n.attr("href"))}),u=o.getAll("body")[0],u&&(f.langdir=s(u,"dir"),f.style=s(u,"style"),f.visited_color=s(u,"vlink"),f.link_color=s(u,"link"),f.active_color=s(u,"alink")),f},tt=function(n,i,u){function h(n,t,i){n.attr(t,i?i:undefined)}function c(n){s.firstChild?s.insert(n,s.firstChild):s.append(n)}var o,s,v,f,y,p=n.dom,l;return o=e(u),s=o.getAll("head")[0],s||(f=o.getAll("html")[0],s=new r("head",1),f.firstChild?f.insert(s,f.firstChild,!0):f.append(s)),f=o.firstChild,i.xml_pi?(y='version="1.0"',i.docencoding&&(y+=' encoding="'+i.docencoding+'"'),f.type!==7&&(f=new r("xml",7),o.insert(f,o.firstChild,!0)),f.value=y):f&&f.type===7&&f.remove(),f=o.getAll("#doctype")[0],i.doctype?(f||(f=new r("#doctype",10),i.xml_pi?o.insert(f,o.firstChild):c(f)),f.value=i.doctype.substring(9,i.doctype.length-1)):f&&f.remove(),f=null,t.each(o.getAll("meta"),function(n){n.attr("http-equiv")==="Content-Type"&&(f=n)}),i.docencoding?(f||(f=new r("meta",1),f.attr("http-equiv","Content-Type"),f.shortEnded=!0,c(f)),f.attr("content","text/html; charset="+i.docencoding)):f&&f.remove(),f=o.getAll("title")[0],i.title?(f?f.empty():(f=new r("title",1),c(f)),f.append(new r("#text",3)).value=i.title):f&&f.remove(),t.each("keywords,description,author,copyright,robots".split(","),function(n){for(var s=o.getAll("meta"),u,e=i[n],t=0;t<s.length;t++)if(u=s[t],u.attr("name")===n){e?u.attr("content",e):u.remove();return}e&&(f=new r("meta",1),f.attr("name",n),f.attr("content",e),f.shortEnded=!0,c(f))}),l={},t.each(o.getAll("link"),function(n){n.attr("rel")==="stylesheet"&&(l[n.attr("href")]=n)}),t.each(i.stylesheets,function(n){l[n]||(f=new r("link",1),f.attr({rel:"stylesheet",text:"text/css",href:n}),f.shortEnded=!0,c(f));delete l[n]}),t.each(l,function(n){n.remove()}),f=o.getAll("body")[0],f&&(h(f,"dir",i.langdir),h(f,"style",i.style),h(f,"vlink",i.visited_color),h(f,"link",i.link_color),h(f,"alink",i.active_color),p.setAttribs(n.getBody(),{style:i.style,dir:i.dir,vLink:i.visited_color,link:i.link_color,aLink:i.active_color})),f=o.getAll("html")[0],f&&(h(f,"lang",i.langcode),h(f,"xml:lang",i.langcode)),s.firstChild||s.remove(),v=a({validate:!1,indent:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(o),v.substring(0,v.indexOf("<\/body>"))},o={parseHeader:e,htmlToData:nt,dataToHtml:tt},it=function(n,i){var r=o.htmlToData(n,i.get()),f=u(u({},{title:"",keywords:"",description:"",robots:"",author:"",docencoding:""}),r);n.windowManager.open({title:"Metadata and Document Properties",size:"normal",body:{type:"panel",items:[{name:"title",type:"input",label:"Title"},{name:"keywords",type:"input",label:"Keywords"},{name:"description",type:"input",label:"Description"},{name:"robots",type:"input",label:"Robots"},{name:"author",type:"input",label:"Author"},{name:"docencoding",type:"input",label:"Encoding"}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:f,onSubmit:function(u){var f=u.getData(),e=o.dataToHtml(n,t.extend(r,f),i.get());i.set(e);u.close()}})},rt={open:it},ut=function(n,t){n.addCommand("mceFullPageProperties",function(){rt.open(n,t)})},ft={register:ut},et=function(n,i){return t.each(n,function(n){i=i.replace(n,function(n){return"<!--mce:protected "+escape(n)+"-->"})}),i},ot=function(n){return n.replace(/<!--mce:protected ([\s\S]*?)-->/g,function(n,t){return unescape(t)})},s={protectHtml:et,unprotectHtml:ot},st=t.each,h=function(n){return n.replace(/<\/?[A-Z]+/g,function(n){return n.toLowerCase()})},ht=function(r,u,f,e){var l,v,c,p,k="",w=r.dom,a,b,d,y;e.selection||(c=s.protectHtml(r.settings.protect,e.content),e.format==="raw"&&u.get())||e.source_view&&i.shouldHideInSourceView(r)||(c.length!==0||e.source_view||(c=t.trim(u.get())+"\n"+t.trim(c)+"\n"+t.trim(f.get())),c=c.replace(/<(\/?)BODY/gi,"<$1body"),l=c.indexOf("<body"),l!==-1?(l=c.indexOf(">",l),u.set(h(c.substring(0,l+1))),v=c.indexOf("<\/body",l),v===-1&&(v=c.length),e.content=t.trim(c.substring(l+1,v)),f.set(h(c.substring(v)))):(u.set(ct(r)),f.set("\n<\/body>\n<\/html>")),p=o.parseHeader(u.get()),st(p.getAll("style"),function(n){n.firstChild&&(k+=n.firstChild.value)}),a=p.getAll("body")[0],a&&w.setAttribs(r.getBody(),{style:a.attr("style")||"",dir:a.attr("dir")||"",vLink:a.attr("vlink")||"",link:a.attr("link")||"",aLink:a.attr("alink")||""}),w.remove("fullpage_styles"),b=r.getDoc().getElementsByTagName("head")[0],k&&(d=w.add(b,"style",{id:"fullpage_styles"}),d.appendChild(n.document.createTextNode(k))),y={},t.each(b.getElementsByTagName("link"),function(n){n.rel==="stylesheet"&&n.getAttribute("data-mce-fullpage")&&(y[n.href]=n)}),t.each(p.getAll("link"),function(n){var t=n.attr("href");if(!t)return!0;y[t]||n.attr("rel")!=="stylesheet"||w.add(b,"link",{rel:"stylesheet",text:"text/css",href:t,"data-mce-fullpage":"1"});delete y[t]}),t.each(y,function(n){n.parentNode.removeChild(n)}))},ct=function(n){var r="",t,u="",f;return i.getDefaultXmlPi(n)&&(f=i.getDefaultEncoding(n),r+='<?xml version="1.0" encoding="'+(f?f:"ISO-8859-1")+'" ?>\n'),r+=i.getDefaultDocType(n),r+="\n<html>\n<head>\n",(t=i.getDefaultTitle(n))&&(r+="<title>"+t+"<\/title>\n"),(t=i.getDefaultEncoding(n))&&(r+='<meta http-equiv="Content-Type" content="text/html; charset='+t+'" />\n'),(t=i.getDefaultFontFamily(n))&&(u+="font-family: "+t+";"),(t=i.getDefaultFontSize(n))&&(u+="font-size: "+t+";"),(t=i.getDefaultTextColor(n))&&(u+="color: "+t+";"),r+("<\/head>\n<body"+(u?' style="'+u+'"':"")+">\n")},lt=function(n,r,u,f){f.selection||f.source_view&&i.shouldHideInSourceView(n)||(f.content=s.unprotectHtml(t.trim(r)+"\n"+t.trim(f.content)+"\n"+t.trim(u)))},at=function(n,t,i){n.on("BeforeSetContent",function(r){ht(n,t,i,r)});n.on("GetContent",function(r){lt(n,t.get(),i.get(),r)})},vt={setup:at},yt=function(n){n.ui.registry.addButton("fullpage",{tooltip:"Metadata and document properties",icon:"document-properties",onAction:function(){n.execCommand("mceFullPageProperties")}});n.ui.registry.addMenuItem("fullpage",{text:"Metadata and document properties",icon:"document-properties",onAction:function(){n.execCommand("mceFullPageProperties")}})},pt={register:yt};wt()})(window);