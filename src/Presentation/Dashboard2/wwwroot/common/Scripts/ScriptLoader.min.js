window.ScriptLoader={loadedScripts:new Set,loadingPromises:new Map,config:{retryAttempts:3,retryDelay:1e3,timeout:3e4,fallbackToLocal:!0},loadScript:function(n,t={}){const r={...this.config,...t};if(this.loadingPromises.has(n))return this.loadingPromises.get(n);if(this.loadedScripts.has(n))return console.log(`Script ${n} already loaded`),Promise.resolve();const i=this.loadScriptWithRetry(n,r);return this.loadingPromises.set(n,i),i},loadScriptWithRetry:function(n,t,i=1){return new Promise((r,u)=>{if(document.querySelector(`script[src="${n}"]`)){this.loadedScripts.add(n);r();return}const f=document.createElement("script");f.type="text/javascript";f.src=n;const e=setTimeout(()=>{f.onload=f.onerror=null;try{document.head.removeChild(f)}catch(e){}i<t.retryAttempts?(console.warn(`Script load timeout for ${n}, retrying... (attempt ${i+1})`),setTimeout(()=>{this.loadScriptWithRetry(n,t,i+1).then(r).catch(u)},t.retryDelay)):(this.loadingPromises.delete(n),u(new Error(`Script load timeout after ${t.retryAttempts} attempts: ${n}`)))},t.timeout);f.onload=()=>{clearTimeout(e),console.log(`Script loaded successfully: ${n}`),this.loadedScripts.add(n),this.loadingPromises.delete(n),r()};f.onerror=f=>{clearTimeout(e),console.error(`Error loading script: ${n}`,f),i<t.retryAttempts?(console.warn(`Retrying script load for ${n}... (attempt ${i+1})`),setTimeout(()=>{this.loadScriptWithRetry(n,t,i+1).then(r).catch(u)},t.retryDelay)):(this.loadingPromises.delete(n),u(new Error(`Failed to load script after ${t.retryAttempts} attempts: ${n}`)))};try{document.head.appendChild(f)}catch(o){clearTimeout(e);this.loadingPromises.delete(n);u(new Error(`DOM error adding script: ${o.message}`))}})},loadScriptsSequential:function(n){const t=Array.isArray(n)?n:[].slice.call(arguments);return t.reduce((n,t)=>n.then(()=>this.loadScript(t)),Promise.resolve())},loadScriptsParallel:function(n){const t=Array.isArray(n)?n:[].slice.call(arguments),i=t.map(n=>this.loadScript(n));return Promise.all(i)},loadHighcharts:function(){return console.log("Loading Highcharts library..."),this.loadScriptsSequential(["https://code.highcharts.com/highcharts.js","https://code.highcharts.com/modules/exporting.js","https://code.highcharts.com/modules/export-data.js","https://code.highcharts.com/modules/accessibility.js"]).then(()=>(console.log("Highcharts library loaded successfully"),this.waitForGlobal("Highcharts",5e3))).then(()=>(console.log("Highcharts verified and ready"),!0)).catch(n=>(console.error("Failed to load Highcharts:",n),this.tryHighchartsFallback().then(()=>(console.log("Highcharts loaded via fallback"),!0)).catch(t=>{console.error("Highcharts fallback also failed:",t);throw new Error(`Complete Highcharts loading failure: ${n.message}`);})))},tryHighchartsFallback:function(){return console.log("Trying Highcharts fallback URLs..."),this.loadScriptsSequential(["https://cdn.jsdelivr.net/npm/highcharts@latest/highcharts.js","https://cdn.jsdelivr.net/npm/highcharts@latest/modules/exporting.js","https://cdn.jsdelivr.net/npm/highcharts@latest/modules/export-data.js","https://cdn.jsdelivr.net/npm/highcharts@latest/modules/accessibility.js"]).then(()=>this.waitForGlobal("Highcharts",5e3))},waitForGlobal:function(n,t=5e3){return new Promise((i,r)=>{if(typeof window[n]!="undefined"){i(window[n]);return}let u=0;const f=100,e=setInterval(()=>{u+=f,typeof window[n]!="undefined"?(clearInterval(e),i(window[n])):u>=t&&(clearInterval(e),r(new Error(`Global variable '${n}' not available after ${t}ms`)))},f)})},loadTinyMCE:function(){return console.log("Loading TinyMCE core library..."),this.loadScript("assets/js/plugins/tinymce/tinymce.min.js").then(()=>(console.log("TinyMCE core loaded successfully"),this.waitForGlobal("tinymce",5e3))).then(()=>(console.log("TinyMCE core verified and ready"),!0)).catch(n=>{console.error("Failed to load TinyMCE core:",n);throw n;})},isLoaded:function(n){return this.loadedScripts.has(n)},isHighchartsLoaded:function(){return typeof Highcharts!="undefined"&&(this.loadedScripts.has("https://code.highcharts.com/highcharts.js")||this.loadedScripts.has("https://cdn.jsdelivr.net/npm/highcharts@latest/highcharts.js"))},isTinyMCELoaded:function(){return typeof tinymce!="undefined"&&this.loadedScripts.has("assets/js/plugins/tinymce/tinymce.min.js")},removeScript:function(n){const t=document.querySelector(`script[src="${n}"]`);return t?(t.parentNode.removeChild(t),this.loadedScripts.delete(n),console.log(`Script removed: ${n}`),!0):!1},clear:function(){this.loadedScripts.clear();this.loadingPromises.clear()},getEnvironmentInfo:function(){return{isProduction:!window.location.hostname.includes("localhost"),origin:window.location.origin,userAgent:navigator.userAgent,loadedScripts:Array.from(this.loadedScripts)}}};window.loadHighchartsIfNeeded=function(){return window.ScriptLoader.loadHighcharts()};window.isHighchartsAvailable=function(){return window.ScriptLoader.isHighchartsLoaded()};window.loadTinyMCEIfNeeded=function(){return window.ScriptLoader.loadTinyMCE()};window.isTinyMCEAvailable=function(){return window.ScriptLoader.isTinyMCELoaded()};window.getScriptLoaderInfo=function(){return window.ScriptLoader.getEnvironmentInfo()};