@page "/couponcode/{Id:guid}"
@page "/couponcode"
@attribute [Authorize(Roles = nameof(UserRole.Admin))]
@using Common.Enumerations
@using Common.Enumerations.Order
@using Common.Enumerations.User
@using Shared.DTOs.Merchandising.PromoCode
@using Shared.DTOs.Order.CouponCode

<PageTitle>@CouponCodeResources.PromoCode - @(Id != Guid.Empty ? ActionsResources.Edit : ActionsResources.Create)</PageTitle>

<div class="container-fluid p-0">
    <div class="card shadow-sm border-0">
        <div class="card-header d-flex bg-primary justify-content-between align-items-center">
            <h4 class="modal-title text-white">
                🏷️ @CouponCodeResources.PromoCode - @(Id != Guid.Empty ? ActionsResources.Edit : ActionsResources.Create)
            </h4>
            <button type="button" class="btn btn-light btn-sm" @onclick="() => GoBack()">
                <i class="fas fa-arrow-left me-1"></i> @ActionsResources.Back
            </button>
        </div>

        <div class="card-body p-4">
            @if (Model == null)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">@GeneralResources.Loading</span>
                    </div>
                </div>
            }
            else
            {
                <EditForm Model="Model" OnSubmit="@(async () => await Save())">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <!-- Basic Information Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="titleAr" class="form-label fw-bold">@CouponCodeResources.ArabicTitle</label>
                                <InputText id="titleAr" @bind-Value="Model.TitleAr" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="titleEn" class="form-label fw-bold">@CouponCodeResources.EnglishTitle</label>
                                <InputText id="titleEn" @bind-Value="Model.TitleEn" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <!-- Code Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="code" class="form-label fw-bold">@CouponCodeResources.Code <span class="text-danger">*</span></label>
                                <InputText id="code" @bind-Value="Model.Code" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="status" class="form-label fw-bold">@CouponCodeResources.Status</label>
                                <div class="form-check form-switch">
                                    <InputCheckbox id="status" @bind-Value="Model.IsActive" class="form-check-input" />
                                    <label class="form-check-label" for="status">
                                        @(Model.IsActive ? CouponCodeResources.Active : CouponCodeResources.InActive)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coupon Type Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="promoType" class="form-label fw-bold">@CouponCodeResources.Type</label>
                                <InputSelect id="promoType" @bind-Value="Model.PromoType" class="form-select">
                                    <option value="@(CouponCodeType.General)">@CouponCodeResources.GeneralCoupon</option>
                                    <option value="@(CouponCodeType.CategoryBased)">@CouponCodeResources.CategoryBasedCoupon</option>
                                    <option value="@(CouponCodeType.ItemBased)">@CouponCodeResources.ItemBasedCoupon</option>
                                </InputSelect>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="discountType" class="form-label fw-bold">@CouponCodeResources.DiscountType</label>
                                <InputSelect id="discountType" @bind-Value="Model.DiscountType" class="form-select">
                                    <option value="@(DiscountType.Percentage)">@CouponCodeResources.PercentageDiscount</option>
                                    <option value="@(DiscountType.FixedAmount)">@CouponCodeResources.FixedAmountDiscount</option>
                                </InputSelect>
                            </div>
                        </div>
                    </div>

                    <!-- Discount Value Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="discountValue" class="form-label fw-bold">
                                    @CouponCodeResources.Value
                                    @(Model.DiscountType == DiscountType.Percentage ? "(%)" : "(LE)")
                                </label>
                                <InputNumber id="discountValue" @bind-Value="Model.DiscountValue" class="form-control" />
                            </div>
                        </div>
                        @if (Model.DiscountType == DiscountType.Percentage)
                        {
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="maxDiscountAmount" class="form-label fw-bold">@CouponCodeResources.MaxDiscountAmount (@ECommerceResources.CurrencySymbol)</label>
                                    <InputNumber id="maxDiscountAmount" @bind-Value="Model.MaxDiscountAmount" class="form-control" />
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Category Selector Section (for CategoryBased coupons) -->
                    @if (Model.PromoType == CouponCodeType.CategoryBased)
                    {
                        <div class="row mb-4">
                            <div class="col-12">
                                <Dashboard.Pages.Merchandising.CouponCode.Components.CouponCategoriesSelector 
                                    SelectedCategories="@SelectedCategories"
                                    SelectedCategoriesChanged="@OnSelectedCategoriesChanged" />
                            </div>
                        </div>
                    }

                    <!-- Item Selector Section (for ItemBased coupons) -->
                    @if (Model.PromoType == CouponCodeType.ItemBased)
                    {
                        <div class="row mb-4">
                            <div class="col-12">
                                <Dashboard.Pages.Merchandising.CouponCode.Components.CouponItemsSelector 
                                    SelectedItems="@SelectedItems"
                                    SelectedItemsChanged="@OnSelectedItemsChanged" />
                            </div>
                        </div>
                    }

                    <!-- Dates Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="startDate" class="form-label fw-bold">@CouponCodeResources.StartDate</label>
                                <InputDate id="startDate" @bind-Value="Model.StartDate" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="expiryDate" class="form-label fw-bold">@CouponCodeResources.EndDate</label>
                                <InputDate id="expiryDate" @bind-Value="Model.ExpiryDate" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <!-- Usage Limits Section -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="usageLimit" class="form-label fw-bold">@CouponCodeResources.UsageLimit</label>
                                <InputNumber id="usageLimit" @bind-Value="Model.UsageLimit" class="form-control" placeholder="∞" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="usageLimitPerUser" class="form-label fw-bold">@CouponCodeResources.UsageLimitPerUser</label>
                                <InputNumber id="usageLimitPerUser" @bind-Value="Model.UsageLimitPerUser" class="form-control" placeholder="∞" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="minimumOrderAmount" class="form-label fw-bold">@CouponCodeResources.MinimumOrderAmount</label>
                                <InputNumber id="minimumOrderAmount" @bind-Value="Model.MinimumOrderAmount" class="form-control" placeholder="0" />
                            </div>
                        </div>
                    </div>

                    <!-- Additional Options -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check">
                                <InputCheckbox id="isFirstOrderOnly" @bind-Value="Model.IsFirstOrderOnly" class="form-check-input" />
                                <label class="form-check-label" for="isFirstOrderOnly">
                                    @CouponCodeResources.IsFirstOrderOnly
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="card-footer bg-light py-3 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" @onclick="() => GoBack()">
                            <i class="fas fa-times me-1"></i> @ActionsResources.Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" disabled="@_isSaving">
                            <i class="fas fa-save me-1"></i> 
                            @if (_isSaving)
                            {
                                <span>@ActionsResources.Update</span>
                            }
                            else
                            {
                                <span>@ActionsResources.Save</span>
                            }
                        </button>
                    </div>
                </EditForm>

                @if (Id != Guid.Empty)
                {
                    <hr class="my-4" />
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold">@CouponCodeResources.PromoCodeParticipations</h6>
                            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="@(async () => await LoadParticipationRequestsAsync())">
                                <i class="fas fa-sync-alt me-1"></i> @ActionsResources.Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            @if (_isLoadingParticipation)
                            {
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </div>
                            }
                            else if (ParticipationRequests?.Items != null && ParticipationRequests.Items.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover text-center mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="min-width: 160px;">@CouponCodeResources.Vendor</th>
                                                <th style="min-width: 120px;">@CouponCodeResources.Code</th>
                                                <th style="min-width: 130px;">@FormResources.Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var req in ParticipationRequests.Items)
                                            {
                                                <tr>
                                                    <td>@(req.VendorName ?? "-")</td>
                                                    <td><span class="badge bg-primary">@req.PromoCodeValue</span></td>
                                                    <td>@req.SubmittedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                            }
                            else
                            {
                                <div class="text-center py-4 text-muted">
                                    @NotifiAndAlertsResources.NoDataFound
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>
