@page "/products/requests"

@using Common.Enumerations
@using Common.Enumerations.FieldType
@using Common.Enumerations.User
@using Shared.DTOs.Catalog.Item
@using Shared.DTOs.ECommerce
@using Shared.DTOs.User
@inherits BaseListPage<ItemDto>

@attribute [Authorize(Roles = nameof(UserRole.Admin))]

<PageTitle>@ECommerceResources.NewProductRequests</PageTitle>

<div class="container-fluid p-0">
	<div class="card shadow-sm border-0">
		<div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
			<h5 class="mb-0 fw-semibold text-white">🛍️ @ECommerceResources.NewProductRequests</h5>
		</div>
		<div class="card-body">
			<div class="dt-responsive table-responsive">
				<!-- Filtration start -->
				<ul class="navbar-nav d-flex flex-row align-items-center mx-2 gap-3 mb-2 px-0 w-100">
					<li class="nav-item col-md-6 w-auto d-flex flex-row align-items-center gap-3">
						<EditForm Model="searchModel" OnSubmit="@Search">
							<!-- Search Box -->
							<div class="search-container">
								<div class="input-group search-box">
									<input type="text"
										   @bind="searchModel.SearchTerm"
										   id="searchInput"
										   class="form-control search-input"
										   placeholder="@ActionsResources.Search" />
									<button type="submit"
											class="btn btn-search">
										<i class="fas fa-search"></i>
									</button>
								</div>
							</div>
						</EditForm>
						<!-- Page Size -->
						<div class="d-flex align-items-center gap-2">
							<select class="form-select rounded-3 shadow-sm border-light text-primary fw-bold text-center custom-dropdown"
									style="width: 130px; height: 40px; padding-right: 30px;"
									@onchange="OnPageSizeChanged">
								<option value="10" selected="@(searchModel.PageSize == 10)">10</option>
								<option value="15" selected="@(searchModel.PageSize == 15)">15</option>
								<option value="20" selected="@(searchModel.PageSize == 20)">20</option>
								<option value="30" selected="@(searchModel.PageSize == 30)">30</option>
							</select>
						</div>
					</li>
					<li class="nav-item ms-auto d-flex flex-row align-items-center gap-2">
						<!-- Go to Products List -->
						<button class="btn btn-primary" @onclick="GoToMainList">
							<i class="fas fa-boxes me-2"></i>
							<span class="fw-bold">@ECommerceResources.Products</span>
						</button>
						<!-- Export Buttons -->
						<div class="dropdown">
							<button class="btn btn-info" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
								<i class="fas fa-file-export me-2"></i>
								<span class="fw-bold">@ActionsResources.Export</span>
							</button>
							<ul class="dropdown-menu" aria-labelledby="exportDropdown">
								<li><a class="dropdown-item" href="javascript:void(0)" @onclick="ExportToExcel"><i class="far fa-file-excel mx-2"></i>Excel</a></li>
								<li><a class="dropdown-item" href="javascript:void(0)" @onclick="ExportToPrint"><i class="fas fa-print mx-2"></i>Print</a></li>
							</ul>
						</div>
					</li>
				</ul>
				<!-- Responsive Table Container -->
				<div class="table-responsive full-height-card border rounded-3 overflow-hidden">
					<table class="table table-hover mb-0 d-none d-md-table">
						<thead class="bg-light">
							<tr>
								<th class="text-center align-middle">@FormResources.Image</th>
								<th class="text-center  align-middle">@FormResources.Title</th>
								<th class="text-center align-middle">@FormResources.Price</th>
								<th class="text-center align-middle" style="width: 200px;">@ECommerceResources.Actions</th>
							</tr>
						</thead>
						<tbody>
							@if (items != null && items.Count() != 0)
							{
								@foreach (var item in items)
								{
									<tr class="align-middle">
										<td class="text-center align-middle">
											<div class="d-flex justify-content-center">
												@if (!string.IsNullOrEmpty(item.ThumbnailImage))
												{
													<img src="@baseUrl/@item.ThumbnailImage"
														 class="rounded-2 object-fit-cover border"
														 style="width: 70px; height: 70px;"
														 alt="Product image" />
												}
												else
												{
													<div class="d-flex align-items-center justify-content-center rounded-2 bg-light border"
														 style="width: 70px; height: 70px;">
														<i class="feather icon-image text-muted" style="font-size: 1.5rem;"></i>
													</div>
												}
											</div>
										</td>
										<td class="text-center align-middle fw-semibold">
											@(ResourceManager.CurrentLanguage == Language.Arabic ? item.TitleAr : item.TitleEn)
										</td>
										<td class="text-center align-middle">
											<span class="fw-bold text-success" dir="ltr">
												@(item.BasePrice != null ? $"{item.BasePrice?.ToString("F2")} EGP" : "N/A")
											</span>
										</td>
										<td class="d-flex gap-1 justify-content-center align-items-center">
											<div class="d-flex justify-content-center gap-2 my-2 pt-2">
												
												<!-- Accept -->
												<button class="btn btn-success" @onclick="() => Accept(item.Id)">
													<i class="fas fa-check me-2"></i>
													@ActionsResources.Accept
												</button>

												<!-- Reject -->
												<button class="btn btn-outline-danger" @onclick="() => Reject(item.Id)">
													<i class="fas fa-times me-2"></i>
													@ActionsResources.Reject
												</button>

												<!-- Edit -->
												<button class="btn btn-primary" @onclick="() => Edit(item)">
													<i class="fas fa-pencil-alt mx-1 ms-2"></i>
													@ActionsResources.Edit
												</button>
												<!-- Delete -->
												<button class="btn btn-danger" @onclick="() => Delete(item.Id)">
													<i class="feather icon-trash-2 mx-1 ms-2"></i>
													@ActionsResources.Delete
												</button>
											</div>
										</td>
									</tr>
								}
							}
							else
							{
								<tr>
									<td colspan="5" class="p-0 no-data-container">
										<div class=" d-flex flex-column justify-content-center align-items-center text-center" style="height: 60vh;">
											<i class="fas fa-database text-muted" style="font-size: 60px;"></i>

											<p class="text-muted mt-3" style="font-size: 18px;">
												@NotifiAndAlertsResources.NoDataFound
											</p>
										</div>
									</td>
								</tr>

							}
						</tbody>
					</table>


				</div>

				<!-- Pagination -->
				<div class="pagination-wrapper d-flex flex-column justify-content-end flex-grow-1">
					<div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mt-4 pagination-container" dir="ltr">

						<!-- النص الإحصائي -->
						<div class="text-muted small">
							@string.Format(
							ActionsResources.ShowingEntries,
														((currentPage - 1) * searchModel.PageSize + 1),
														Math.Min(currentPage * searchModel.PageSize, totalRecords),
														totalRecords
														)
						</div>

						<!-- الباجينيشن -->
						<nav aria-label="Pagination">
							<ul class="pagination pagination-sm mb-0 shadow-sm rounded-3 overflow-hidden">

								<!-- أول صفحة -->
								<li class="page-item @(currentPage == 1 ? "disabled" : "")">
									<a class="page-link" @onclick="() => GoToPage(1)" title="@ActionsResources.First">
										<i class="fas fa-angle-double-left"></i>
									</a>
								</li>

								<!-- السابقة -->
								<li class="page-item @(currentPage == 1 ? "disabled" : "")">
									<a class="page-link" @onclick="() => GoToPage(currentPage - 1)">
										<i class="fas fa-angle-left"></i>
									</a>
								</li>


								@{
																const int maxVisiblePages = 5;
								int startPage = Math.Max(1, currentPage - 2);
								int endPage = Math.Min(totalPages, startPage + maxVisiblePages - 1);
								if (endPage - startPage + 1 < maxVisiblePages)
								{
									startPage = Math.Max(1, endPage - maxVisiblePages + 1);
								}
																}

								@if (startPage > 1)
								{
									<li class="page-item disabled"><span class="page-link">...</span></li>
								}

								@for (int pag = startPage; pag <= endPage; pag++)
								{
									int pageNumber = pag;
									<li class="page-item @(pag == currentPage ? "active" : "")">
										<a class="page-link fw-bold" @onclick="() => GoToPage(pageNumber)">@pag</a>
									</li>
								}

								@if (endPage < totalPages)
								{
									<li class="page-item disabled"><span class="page-link">...</span></li>
								}

								<!-- التالية -->
								<li class="page-item @(currentPage == totalPages ? "disabled" : "")">
									<a class="page-link" @onclick="() => GoToPage(currentPage + 1)">
										<i class="fas fa-angle-right"></i>
									</a>
								</li>

								<!-- آخر صفحة -->
								<li class="page-item @(currentPage == totalPages ? "disabled" : "")">
									<a class="page-link" @onclick="() => GoToPage(totalPages)" title="@ActionsResources.Last">
										<i class="fas fa-angle-double-right"></i>
									</a>
								</li>
							</ul>
						</nav>
					</div>
				</div>

			</div>
		</div>
	</div>
</div>