@page "/vendor-items/import"
@using Shared.DTOs.ECommerce
@using Shared.DTOs.ECommerce.Category
@using Shared.DTOs.Brand
@using Shared.DTOs.ECommerce.Unit
@using Shared.DTOs.ECommerce.Item
@using Dashboard.Services
@using Dashboard.Contracts.ECommerce.Category
@using Dashboard.Contracts.Brand
@using Dashboard.Contracts.ECommerce.Item
@using Dashboard.Contracts.General
@using Microsoft.AspNetCore.Components.Forms
@using Resources
@using System.Text.Json

@inject ICategoryService CategoryService
@inject IBrandService BrandService
@inject IUnitService UnitService
@inject IAttributeService AttributeService
@inject IItemService ItemService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject IResourceLoaderService ResourceLoaderService

<PageTitle>@ECommerceResources.ImportProducts</PageTitle>

<div class="container-fluid p-0">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white py-3">
            <h5 class="mb-0 fw-semibold text-white">?? @ECommerceResources.ImportProducts</h5>
        </div>
        <div class="card-body">
            
            @if (currentStep == ImportStep.SelectCategory)
            {
                <!-- Step 1: Select Category -->
                <div class="row">
                    <div class="col-md-8 mx-auto">
                        <h6 class="text-primary mb-3">@ECommerceResources.Step1SelectCategory</h6>
                        <p class="text-muted">@ECommerceResources.SelectCategoryInstructions</p>
                        
                        <div class="mb-3">
                            <label class="form-label">@ECommerceResources.Category *</label>
                            <select class="form-select" @onchange="OnCategorySelected">
                                <option value="">-- @ActionsResources.Select @ECommerceResources.Category --</option>
                                @foreach (var category in categories.Where(c => c.IsFinal))
                                {
                                    <option value="@category.Id">@category.Title</option>
                                }
                            </select>
                        </div>

                        @if (selectedCategoryId != Guid.Empty)
                        {
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>@ECommerceResources.SelectedCategory:</strong> @selectedCategoryName
                            </div>

                            <div class="d-flex gap-2 flex-wrap">
                                <!-- Download Template with Data -->
                                <button class="btn btn-primary" @onclick="GenerateTemplateWithData" disabled="@isGeneratingTemplate">
                                    @if (isGeneratingTemplate)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="fas fa-download me-2"></i>
                                    @ECommerceResources.DownloadTemplateWithData
                                </button>

                                <!-- Download Empty Template -->
                                <button class="btn btn-outline-primary" @onclick="GenerateEmptyTemplate" disabled="@isGeneratingTemplate">
                                    @if (isGeneratingTemplate)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="fas fa-file-excel me-2"></i>
                                    @ECommerceResources.DownloadEmptyTemplate
                                </button>
                            </div>

                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>@GeneralResources.ImportantNotes:</strong>
                                <ul class="mb-0 mt-2">
                                    <li><strong>@ECommerceResources.TemplateWithReferenceData:</strong> @ECommerceResources.TemplateWithDataDescription</li>
                                    <li><strong>@ECommerceResources.EmptyTemplate:</strong> @ECommerceResources.EmptyTemplateDescription</li>
                                    <li>@ECommerceResources.DeleteExampleRow</li>
                                    <li>@ECommerceResources.AllFieldsMarkedRequired</li>
                                    <li>@ECommerceResources.SelectFromDropdown</li>
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (currentStep == ImportStep.UploadFile)
            {
                <!-- Step 2: Upload Excel File -->
                <div class="row">
                    <div class="col-md-8 mx-auto">
                        <h6 class="text-primary mb-3">@ECommerceResources.Step2UploadFile</h6>
                        <p class="text-muted">@ECommerceResources.UploadFileInstructions</p>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>@ECommerceResources.SelectedCategory:</strong> @selectedCategoryName
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@ECommerceResources.ExcelFile * (.xlsx only)</label>
                            <InputFile class="form-control" OnChange="HandleFileUpload" accept=".xlsx" />
                            @if (!string.IsNullOrEmpty(uploadError))
                            {
                                <div class="alert alert-danger mt-2">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    @uploadError
                                </div>
                            }
                            @if (uploadedFile != null)
                            {
                                <div class="alert alert-success mt-2">
                                    <i class="fas fa-check-circle me-2"></i>
                                    @GeneralResources.FileSelected: <strong>@uploadedFile.Name</strong> (@((uploadedFile.Size / 1024.0).ToString("F2")) KB)
                                </div>
                            }
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-secondary" @onclick="BackToSelectCategory">
                                <i class="fas fa-arrow-left me-2"></i>
                                @ActionsResources.Back
                            </button>
                            <button class="btn btn-primary" @onclick="ParseExcelFile" disabled="@(uploadedFile == null || isProcessing)">
                                @if (isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <text>@GeneralResources.Processing</text>
                                }
                                else
                                {
                                    <i class="fas fa-check me-2"></i>
                                    <text>@ECommerceResources.ParseAndReviewData</text>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            }
            else if (currentStep == ImportStep.ReviewData)
            {
                <!-- Step 3: Review Parsed Data -->
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">Step 3: Review Parsed Products</h6>
                        <p class="text-muted">Review the products parsed from Excel. Fix any validation errors before importing.</p>
                        
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Successfully parsed <strong>@importedProducts.Count</strong> products
                        </div>

                        @if (validationErrors.Any())
                        {
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-times-circle me-2"></i>Validation Errors Found:</h6>
                                <p class="mb-2">Please fix these errors before importing:</p>
                                <ul class="mb-0">
                                    @foreach (var error in validationErrors.Take(20))
                                    {
                                        <li>@error</li>
                                    }
                                </ul>
                                @if (validationErrors.Count > 20)
                                {
                                    <p class="mb-0 mt-2 text-muted">... and @(validationErrors.Count - 20) more errors</p>
                                }
                            </div>
                        }

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px">#</th>
                                        <th>Title (EN)</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Stock</th>
                                        <th>Attributes</th>
                                        <th>Pricing Combos</th>
                                        <th>Status</th>
                                        <th style="width: 100px">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var product in importedProducts)
                                    {
                                        var rowErrors = GetRowValidationErrors(product);
                                        var hasErrors = rowErrors.Any();
                                        <tr class="@(hasErrors ? "table-danger" : "")">
                                            <td>@product.RowNumber</td>
                                            <td>
                                                @product.TitleEn
                                                @if (string.IsNullOrWhiteSpace(product.TitleEn))
                                                {
                                                    <span class="badge bg-danger">Missing</span>
                                                }
                                            </td>
                                            <td>
                                                @if (product.CategoryId != Guid.Empty)
                                                {
                                                    var cat = categories.FirstOrDefault(c => c.Id == product.CategoryId);
                                                    <text>@(cat?.Title ?? "Unknown")</text>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">Invalid</span>
                                                }
                                            </td>
                                            <td>@product.Price.ToString("C")</td>
                                            <td>
                                                @product.Quantity
                                                @if (product.Quantity < 0)
                                                {
                                                    <span class="badge bg-danger">Invalid</span>
                                                }
                                            </td>
                                            <td>
                                                @if (product.StockStatus)
                                                {
                                                    <span class="badge bg-success">In Stock</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">Out of Stock</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge bg-info">@product.AttributeValues.Count attrs</span>
                                            </td>
                                            <td>
                                                @{
                                                    var comboCount = GetCombinationCount(product.PricingAttributeValues);
                                                }
                                                @if (comboCount > 0)
                                                {
                                                    <span class="badge bg-warning text-dark">@comboCount combinations</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @if (hasErrors)
                                                {
                                                    <span class="badge bg-danger" title="@string.Join(", ", rowErrors)">
                                                        <i class="fas fa-times me-1"></i>
                                                        @rowErrors.Count errors
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check"></i>
                                                        Valid
                                                    </span>
                                                }
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-danger" @onclick="() => RemoveProduct(product)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }else{
                                        <tr>
                                            <td colspan="10" class="text-center text-muted">
                                                No products to display.
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-secondary" @onclick="BackToUpload">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back
                            </button>
                            <button class="btn btn-success" 
                                    @onclick="ImportProducts" 
                                    disabled="@(isImporting || importedProducts.Count == 0 || validationErrors.Any())">
                                @if (isImporting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <text>Importing @importProgress%</text>
                                }
                                else
                                {
                                    <i class="fas fa-upload me-2"></i>
                                    <text>Import @importedProducts.Count Products</text>
                                }
                            </button>
                        </div>

                        @if (validationErrors.Any())
                        {
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Cannot import:</strong> Please fix all validation errors first or remove invalid rows.
                            </div>
                        }
                    </div>
                </div>
            }
            else if (currentStep == ImportStep.Complete)
            {
                <!-- Step 4: Import Complete -->
                <div class="row">
                    <div class="col-md-8 mx-auto text-center">
                        <div class="mb-4">
                            <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
                        </div>
                        <h4 class="text-success mb-3">Import Completed!</h4>
                        <p class="text-muted mb-4">
                            Successfully imported <strong class="text-success">@successCount</strong> products.
                            @if (failedCount > 0)
                            {
                                <br/><span class="text-danger">@failedCount products failed to import.</span>
                            }
                        </p>

                        @if (importResults.Any())
                        {
                            <div class="alert alert-info text-start">
                                <h6>Import Summary:</h6>
                                <ul class="mb-0">
                                    @foreach (var result in importResults.Take(10))
                                    {
                                        <li class="@(result.Success ? "text-success" : "text-danger")">
                                            <i class="fas @(result.Success ? "fa-check-circle" : "fa-times-circle") me-1"></i>
                                            Row @result.RowNumber: @result.Message
                                        </li>
                                    }
                                </ul>
                                @if (importResults.Count > 10)
                                {
                                    <p class="mb-0 mt-2">... and @(importResults.Count - 10) more results</p>
                                }
                            </div>
                        }

                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-primary" @onclick="GoToProducts">
                                <i class="fas fa-box me-2"></i>
                                View Products
                            </button>
                            <button class="btn btn-secondary" @onclick="StartNewImport">
                                <i class="fas fa-redo me-2"></i>
                                Import More Products
                            </button>
                        </div>
                    </div>
                </div>
            }

        </div>
    </div>
</div>


