// ManualAttributeCombinations.razor
@using Common.Enumerations
@using Common.Enumerations.FieldType
@using Common.Enumerations.Pricing
@using Common.Enumerations.User
@using Resources
@using Shared.DTOs.ECommerce
@using Shared.DTOs.ECommerce.Item
@using Shared.DTOs.User
@attribute [Authorize(Roles = nameof(UserRole.Admin))]

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-primary">@ECommerceResources.AttributeCombinations</h5>
        <button type="button" class="btn btn-primary btn-sm" @onclick="AddNewCombination">
            <i class="fas fa-plus me-1"></i> @ActionsResources.Add Combination
        </button>
    </div>
    <div class="card-body">
        @if (Combinations.Any())
        {
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>@ECommerceResources.Attributes</th>
                            <th>Barcode</th>
                            <th>SKU</th>
                            <th>BasePrice <span class="text-danger">*</span></th>
                            <th>Is Default</th>
                            <th>@FormResources.Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var combination in Combinations)
                        {
                            <tr>
                                <td>
                                    @GetCombinationAttributesDisplay(combination)
                                </td>
                                <td>
                                    <InputText class="form-control"
                                               @bind-Value="combination.Barcode" />
                                </td>
                                <td>
                                    <InputText class="form-control"
                                               @bind-Value="combination.SKU" />
                                </td>
                                <td>
                                    <InputNumber class="form-control"
                                                 @bind-Value="combination.BasePrice"
                                                 min="0.01"
                                                 step="0.01" />
                                </td>
                                <td>
                                    <InputCheckbox class="form-check-input"
                                                   @bind-Value="combination.IsDefault" />
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-danger"
                                            @onclick="() => RemoveCombination(combination)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-4 text-muted">
                <i class="fas fa-list-alt fa-3x mb-3"></i>
                <p>@NotifiAndAlertsResources.NoAttributeCombinations</p>
            </div>
        }
    </div>
</div>

<!-- Add/Edit Combination Modal -->
<div class="modal fade" id="combinationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(EditingCombination == null ? ActionsResources.Add : ActionsResources.Edit) Combination
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label>Barcode</label>
                        <InputText class="form-control" @bind-Value="TempCombination.Barcode" />
                    </div>
                    <div class="col-md-6">
                        <label>SKU</label>
                        <InputText class="form-control" @bind-Value="TempCombination.SKU" />
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label>BasePrice <span class="text-danger">*</span></label>
                        <InputNumber class="form-control"
                                     @bind-Value="TempCombination.BasePrice"
                                     min="0.01" step="0.01" />
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mt-4">
                            <InputCheckbox class="form-check-input"
                                           @bind-Value="TempCombination.IsDefault" />
                            <label class="form-check-label">Is Default</label>
                        </div>
                    </div>
                </div>

                <h6 class="text-primary mb-3">@ECommerceResources.Attributes</h6>

                @if (CategoryAttributes.Any())
                {
                    <div class="mb-3">
                        <label>Select Attribute</label>
                        <InputSelect class="form-select" @bind-Value="SelectedAttributeId">
                            <option value="">@FormResources.Select</option>
                            @foreach (var attr in CategoryAttributes)
                            {
                                <option value="@attr.Id">@attr.Title</option>
                            }
                        </InputSelect>
                    </div>

                    if (!string.IsNullOrEmpty(SelectedAttributeId))
                    {
                        var selectedAttr = CategoryAttributes.FirstOrDefault(a => a.Id == Guid.Parse(SelectedAttributeId));
                        if (selectedAttr != null)
                        {
                            <div class="mb-3">
                                <label>@selectedAttr.Title Value</label>
                                @if (selectedAttr.FieldType == FieldType.List || selectedAttr.FieldType == FieldType.MultiSelectList)
                                {
                                    <InputSelect class="form-select" @bind-Value="SelectedAttributeValue">
                                        <option value="">@FormResources.Select</option>
                                        @if (selectedAttr.AttributeOptions != null)
                                        {
                                            @foreach (var option in selectedAttr.AttributeOptions)
                                            {
                                                <option value="@option.Id">@option.Title</option>
                                            }
                                        }
                                    </InputSelect>
                                }
                                else
                                {
                                    <InputText class="form-control" @bind-Value="SelectedAttributeValue"
                                               placeholder="@($"Enter {selectedAttr.Title} value")" />
                                }
                            </div>

                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Price Modifier</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Modifier Type</label>
                                            <InputSelect class="form-select" @bind-Value="TempModifier.ModifierType">
                                                @foreach (PriceModifierType type in Enum.GetValues(typeof(PriceModifierType)))
                                                {
                                                    <option value="@type">@type</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-6">
                                            <label>Modifier Category</label>
                                            <InputSelect class="form-select" @bind-Value="TempModifier.PriceModifierCategory">
                                                @foreach (PriceModifierCategory category in Enum.GetValues(typeof(PriceModifierCategory)))
                                                {
                                                    <option value="@category">@category</option>
                                                }
                                            </InputSelect>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <label>Modifier Value</label>
                                            <InputNumber class="form-control" @bind-Value="TempModifier.ModifierValue"
                                                         min="0" step="0.01" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn btn-success btn-sm" @onclick="AddAttributeToCombination">
                                <i class="fas fa-plus me-1"></i> Add Attribute
                            </button>
                        }
                    }

                    if (TempCombination.CombinationAttributes.Any())
                    {
                        <div class="mt-4">
                            <h6 class="text-primary mb-3">Selected Attributes</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Attribute</th>
                                            <th>Value</th>
                                            <th>Modifier Type</th>
                                            <th>Modifier Category</th>
                                            <th>Modifier Value</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var attr in TempCombination.CombinationAttributes)
                                        {
                                            @foreach (var val in attr.combinationAttributeValueDtos)
                                            {
                                                var categoryAttr = CategoryAttributes.FirstOrDefault(a => a.Id == val.AttributeId);
                                                <tr>
                                                    <td>@categoryAttr?.Title</td>
                                                    <td>@val.Value</td>
                                                    <td>@val.AttributeValuePriceModifiers.FirstOrDefault()?.ModifierType</td>
                                                    <td>@val.AttributeValuePriceModifiers.FirstOrDefault()?.PriceModifierCategory</td>
                                                    <td>@val.AttributeValuePriceModifiers.FirstOrDefault()?.ModifierValue</td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-danger"
                                                                @onclick="() => RemoveAttributeFromCombination(attr, val)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No attributes available for combinations
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@ActionsResources.Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="SaveCombination">@ActionsResources.Save</button>
            </div>
        </div>
    </div>
</div>