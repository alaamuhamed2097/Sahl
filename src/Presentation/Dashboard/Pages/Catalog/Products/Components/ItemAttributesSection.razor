@using Common.Enumerations
@using Common.Enumerations.FieldType
@using Common.Enumerations.User
@using Resources
@using Shared.DTOs.ECommerce
@using Shared.DTOs.ECommerce.Category
@using Shared.DTOs.ECommerce.Item
@attribute [Authorize(Roles = nameof(UserRole.Admin))]

@if (CategoryAttributes != null && CategoryAttributes.Any())
{
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0 text-primary">@ECommerceResources.ItemAttributes</h5>
            <small class="text-muted">???? ??? ????? ??????</small>
        </div>
        <div class="card-body">
            @foreach (var _attribute in CategoryAttributes)
            {
                // FIX: Use AttributeId instead of Id for matching
                var attributeEntry = ItemAttributes.FirstOrDefault(a => a.AttributeId == _attribute.AttributeId);
                if (attributeEntry == null)
                {
                    attributeEntry = new ItemAttributeDto
                    {
                        AttributeId = _attribute.AttributeId,
                        Value = string.Empty
                    };
                    ItemAttributes.Add(attributeEntry);
                }

                <div class="row align-items-start mb-4 pb-3 border-bottom">
                    <div class="col-md-10">
                        <label class="form-label fw-bold">
                            @_attribute.Title
                            @if (_attribute.IsRequired)
                            {
                                <span class="text-danger">*</span>
                            }
                            @if (_attribute.AffectsPricing)
                            {
                                <span class="badge bg-info text-white ms-2">@ECommerceResources.IsAffectPrice</span>
                            }
                        </label>
                        
                        <div>
                            @if (_attribute.IsRangeFieldType)
                            {
                                <!-- Range Input (From - To) -->
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label small">From</label>
                                        @{
                                            var rangeValues = (attributeEntry.Value ?? "").Split('-');
                                            var fromValue = rangeValues.Length > 0 ? rangeValues[0] : "";
                                        }
                                        @if (_attribute.FieldType == FieldType.IntegerNumber)
                                        {
                                            int? fromInt = int.TryParse(fromValue, out var val) ? val : null;
                                            <InputNumber TValue="int?" class="form-control"
                                                         Value="fromInt"
                                                         ValueChanged="@(async (int? v) => { 
                                                             var toValue = rangeValues.Length > 1 ? rangeValues[1] : "";
                                                             attributeEntry.Value = $"{v}-{toValue}"; 
                                                             await OnAttributeValueChanged.InvokeAsync(); 
                                                         })"
                                                         ValueExpression="@(() => fromInt)"
                                                         placeholder="From" />
                                        }
                                        else
                                        {
                                            decimal? fromDec = decimal.TryParse(fromValue, out var val) ? val : null;
                                            <InputNumber TValue="decimal?" class="form-control"
                                                         step="0.01"
                                                         Value="fromDec"
                                                         ValueChanged="@(async (decimal? v) => { 
                                                             var toValue = rangeValues.Length > 1 ? rangeValues[1] : "";
                                                             attributeEntry.Value = $"{v}-{toValue}"; 
                                                             await OnAttributeValueChanged.InvokeAsync(); 
                                                         })"
                                                         ValueExpression="@(() => fromDec)"
                                                         placeholder="From" />
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small">To</label>
                                        @{
                                            var toValue = rangeValues.Length > 1 ? rangeValues[1] : "";
                                        }
                                        @if (_attribute.FieldType == FieldType.IntegerNumber)
                                        {
                                            int? toInt = int.TryParse(toValue, out var val) ? val : null;
                                            <InputNumber TValue="int?" class="form-control"
                                                         Value="toInt"
                                                         ValueChanged="@(async (int? v) => { 
                                                             var fromValue = rangeValues.Length > 0 ? rangeValues[0] : "";
                                                             attributeEntry.Value = $"{fromValue}-{v}"; 
                                                             await OnAttributeValueChanged.InvokeAsync(); 
                                                         })"
                                                         ValueExpression="@(() => toInt)"
                                                         placeholder="To" />
                                        }
                                        else
                                        {
                                            decimal? toDec = decimal.TryParse(toValue, out var val) ? val : null;
                                            <InputNumber TValue="decimal?" class="form-control"
                                                         step="0.01"
                                                         Value="toDec"
                                                         ValueChanged="@(async (decimal? v) => { 
                                                             var fromValue = rangeValues.Length > 0 ? rangeValues[0] : "";
                                                             attributeEntry.Value = $"{fromValue}-{v}"; 
                                                             await OnAttributeValueChanged.InvokeAsync(); 
                                                         })"
                                                         ValueExpression="@(() => toDec)"
                                                         placeholder="To" />
                                        }
                                    </div>
                                </div>
                                @if (_attribute.IsRequired && string.IsNullOrWhiteSpace(attributeEntry.Value))
                                {
                                    <div class="text-danger small mt-1">@ValidationResources.FieldRequired</div>
                                }
                            }
                            else if (_attribute.FieldType == FieldType.Text)
                            {
                                @if (_attribute.AffectsPricing)
                                {
                                    var valueList = GetMultiValueList(_attribute.Id, attributeEntry.Value);
                                    <div class="border rounded p-3" style="background-color: #f8f9fa;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <small class="text-muted d-flex align-items-center">
                                                <i class="fas fa-info-circle me-2"></i>
                                                ??? ??? ?????? ???????? ???????
                                            </small>
                                            <button type="button" class="btn btn-sm btn-success d-flex align-items-center" @onclick="() => AddNewValue(_attribute.Id)">
                                                <i class="fas fa-plus me-1"></i> ????? ????
                                            </button>
                                        </div>
                                        @for (int i = 0; i < valueList.Count; i++)
                                        {
                                            var index = i;
                                            var currentValue = valueList[index];
                                            <div class="input-group mb-2">
                                                <span class="input-group-text">#@(index + 1)</span>
                                                <input type="text" class="form-control"
                                                       value="@currentValue"
                                                       @onchange="@(async (ChangeEventArgs e) => await OnMultiValueChanged(_attribute.Id, index, e.Value?.ToString(), attributeEntry))"
                                                       maxlength="@(_attribute.MaxLength ?? 255)"
                                                       placeholder="@($"Enter value {index + 1}")" />
                                                @if (valueList.Count > 1)
                                                {
                                                    <button type="button" class="btn btn-outline-danger" @onclick="async () => await RemoveValue(_attribute.Id, index, attributeEntry)" title="Remove">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <InputText class="form-control"
                                               @bind-Value="attributeEntry.Value"
                                               @bind-Value:after="() => HandlePricingAttributeValueChanged(attributeEntry)"
                                               maxlength="@(_attribute.MaxLength ?? 255)"
                                               placeholder="@($"{FormResources.Write} {_attribute.Title}")" />
                                }
                                @if (_attribute.IsRequired && string.IsNullOrWhiteSpace(attributeEntry.Value))
                                {
                                    <div class="text-danger small mt-1">@ValidationResources.FieldRequired</div>
                                }
                            }
                            else if (_attribute.FieldType == FieldType.IntegerNumber)
                            {
                                @if (_attribute.AffectsPricing)
                                {
                                    var valueList = GetMultiValueList(_attribute.Id, attributeEntry.Value);
                                    <div class="border rounded p-3" style="background-color: #f8f9fa;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <small class="text-muted d-flex align-items-center">
                                                <i class="fas fa-info-circle me-2"></i>
                                                ??? ??? ?????? ???????? ???????
                                            </small>
                                            <button type="button" class="btn btn-sm btn-success d-flex align-items-center" @onclick="() => AddNewValue(_attribute.Id)">
                                                <i class="fas fa-plus me-1"></i> ????? ????
                                            </button>
                                        </div>
                                        @for (int i = 0; i < valueList.Count; i++)
                                        {
                                            var index = i;
                                            var currentValue = valueList[index];
                                            int? intValue = int.TryParse(currentValue, out var val) ? val : null;
                                            <div class="input-group mb-2">
                                                <span class="input-group-text">#@(index + 1)</span>
                                                <input type="number" class="form-control"
                                                       value="@intValue"
                                                       @onchange="@(async (ChangeEventArgs e) => await OnMultiValueChanged(_attribute.Id, index, e.Value?.ToString(), attributeEntry))"
                                                       placeholder="@($"Enter value {index + 1}")" />
                                                @if (valueList.Count > 1)
                                                {
                                                    <button type="button" class="btn btn-outline-danger" @onclick="async () => await RemoveValue(_attribute.Id, index, attributeEntry)" title="Remove">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    int? intValue = int.TryParse(attributeEntry.Value, out var val) ? val : null;
                                    <InputNumber TValue="int?" class="form-control"
                                                 Value="intValue"
                                                 ValueChanged="@(async (int? v) => { attributeEntry.Value = v?.ToString() ?? ""; await HandlePricingAttributeValueChanged(attributeEntry); })"
                                                 ValueExpression="@(() => intValue)"
                                                 placeholder="@($"{FormResources.Write} {_attribute.Title}")" />
                                }
                                @if (_attribute.IsRequired && string.IsNullOrWhiteSpace(attributeEntry.Value))
                                {
                                    <div class="text-danger small mt-1">@ValidationResources.FieldRequired</div>
                                }
                            }
                            else if (_attribute.FieldType == FieldType.DecimalNumber)
                            {
                                @if (_attribute.AffectsPricing)
                                {
                                    var valueList = GetMultiValueList(_attribute.Id, attributeEntry.Value);
                                    <div class="border rounded p-3" style="background-color: #f8f9fa;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <small class="text-muted d-flex align-items-center">
                                                <i class="fas fa-info-circle me-2"></i>
                                                ??? ??? ?????? ???????? ???????
                                            </small>
                                            <button type="button" class="btn btn-sm btn-success d-flex align-items-center" @onclick="() => AddNewValue(_attribute.Id)">
                                                <i class="fas fa-plus me-1"></i> ????? ????
                                            </button>
                                        </div>
                                        @for (int i = 0; i < valueList.Count; i++)
                                        {
                                            var index = i;
                                            var currentValue = valueList[index];
                                            decimal? decValue = decimal.TryParse(currentValue, out var val) ? val : null;
                                            <div class="input-group mb-2">
                                                <span class="input-group-text">#@(index + 1)</span>
                                                <input type="number" step="0.01" class="form-control"
                                                       value="@decValue"
                                                       @onchange="@(async (ChangeEventArgs e) => await OnMultiValueChanged(_attribute.Id, index, e.Value?.ToString(), attributeEntry))"
                                                       placeholder="@($"Enter value {index + 1}")" />
                                                @if (valueList.Count > 1)
                                                {
                                                    <button type="button" class="btn btn-outline-danger" @onclick="async () => await RemoveValue(_attribute.Id, index, attributeEntry)" title="Remove">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    decimal? decValue = decimal.TryParse(attributeEntry.Value, out var val) ? val : null;
                                    <InputNumber TValue="decimal?" class="form-control"
                                                 step="0.01"
                                                 Value="decValue"
                                                 ValueChanged="@(async (decimal? v) => { attributeEntry.Value = v?.ToString() ?? ""; await HandlePricingAttributeValueChanged(attributeEntry); })"
                                                 ValueExpression="@(() => decValue)"
                                                 placeholder="@($"{FormResources.Write} {_attribute.Title}")" />
                                }
                                @if (_attribute.IsRequired && string.IsNullOrWhiteSpace(attributeEntry.Value))
                                {
                                    <div class="text-danger small mt-1">@ValidationResources.FieldRequired</div>
                                }
                            }
                            else if (_attribute.FieldType == FieldType.Date)
                            {
                                @if (_attribute.AffectsPricing)
                                {
                                    var valueList = GetMultiValueList(_attribute.Id, attributeEntry.Value);
                                    <div class="border rounded p-3" style="background-color: #f8f9fa;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <small class="text-muted d-flex align-items-center">
                                                <i class="fas fa-info-circle me-2"></i>
                                                ??? ??? ?????? ???????? ???????
                                            </small>
                                            <button type="button" class="btn btn-sm btn-success d-flex align-items-center" @onclick="() => AddNewValue(_attribute.Id)">
                                                <i class="fas fa-plus me-1"></i> ????? ????
                                            </button>
                                        </div>
                                        @for (int i = 0; i < valueList.Count; i++)
                                        {
                                            var index = i;
                                            var currentValue = valueList[index];
                                            DateTime? dateValue = DateTime.TryParse(currentValue, out var val) ? val : null;
                                            <div class="input-group mb-2">
                                                <span class="input-group-text">#@(index + 1)</span>
                                                <input type="date" class="form-control"
                                                       value="@(dateValue?.ToString("yyyy-MM-dd"))"
                                                       @onchange="@(async (ChangeEventArgs e) => await OnMultiValueChanged(_attribute.Id, index, e.Value?.ToString(), attributeEntry))"
                                                       placeholder="@($"Enter value {index + 1}")" />
                                                @if (valueList.Count > 1)
                                                {
                                                    <button type="button" class="btn btn-outline-danger" @onclick="async () => await RemoveValue(_attribute.Id, index, attributeEntry)" title="Remove">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    DateTime? dateVal = DateTime.TryParse(attributeEntry.Value, out var val) ? val : null;
                                    <InputDate TValue="DateTime?" class="form-control"
                                               Value="dateVal"
                                               ValueChanged="@(async (DateTime? v) => { attributeEntry.Value = v?.ToString("yyyy-MM-dd") ?? ""; await HandlePricingAttributeValueChanged(attributeEntry); })"
                                               ValueExpression="@(() => dateVal)"
                                               placeholder="@($"{FormResources.Write} {_attribute.Title}")" />
                                }
                                @if (_attribute.IsRequired && string.IsNullOrWhiteSpace(attributeEntry.Value))
                                {
                                    <div class="text-danger small mt-1">@ValidationResources.FieldRequired</div>
                                }
                            }
                            else if (_attribute.FieldType == FieldType.CheckBox)
                            {
                                bool isChecked = bool.TryParse(attributeEntry.Value, out var val) && val;
                                var checkboxId = $"check_{_attribute.Id}";
                                <div class="form-check form-switch">
                                    <InputCheckbox class="form-check-input"
                                                   Value="isChecked"
                                                   ValueChanged="@(async (bool v) => { attributeEntry.Value = v.ToString(); await OnAttributeValueChanged.InvokeAsync(); })"
                                                   ValueExpression="@(() => isChecked)" 
                                                   id="@checkboxId" />
                                    <label class="form-check-label" for="@checkboxId">@_attribute.Title</label>
                                </div>
                            }
                            else if (_attribute.FieldType == FieldType.List)
                            {
                                @if (_attribute.AttributeOptions != null && _attribute.AttributeOptions.Any())
                                {
                                    <!-- Single Select for non-pricing or Multi-select for pricing -->
                                    @if (_attribute.AffectsPricing)
                                    {
                                        <!-- Multi-select for price-affecting attributes -->
                                        <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto; background-color: #f8f9fa;">
                                            <small class="text-muted d-block mb-2">???? ?????? ?????? ???????</small>
                                            @foreach (var option in _attribute.AttributeOptions.OrderBy(o => o.DisplayOrder))
                                            {
                                                var selectedOptions = (attributeEntry.Value ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries).ToList();
                                                var isSelected = selectedOptions.Contains(option.Id.ToString());
                                                var optionId = $"option_{option.Id}";

                                                <div class="form-check mb-2">
                                                    <input type="checkbox" class="form-check-input"
                                                           id="@optionId"
                                                           checked="@isSelected"
                                                           @onchange="@(async () => { await ToggleOption(attributeEntry, option.Id); })" />
                                                    <label class="form-check-label" for="@optionId">
                                                        @option.Title
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                        @if (_attribute.IsRequired && string.IsNullOrWhiteSpace(attributeEntry.Value))
                                        {
                                            <div class="text-danger small mt-1">@ValidationResources.FieldRequired</div>
                                        }
                                    }
                                    else
                                    {
                                        <!-- Single Select Dropdown -->
                                        <InputSelect class="form-select"
                                                     @bind-Value="attributeEntry.Value"
                                                     @bind-Value:after="() => OnAttributeValueChanged.InvokeAsync()">
                                            <option value="">@FormResources.Select</option>
                                            @foreach (var option in _attribute.AttributeOptions.OrderBy(o => o.DisplayOrder))
                                            {
                                                <option value="@option.Id">@option.Title</option>
                                            }
                                        </InputSelect>
                                        @if (_attribute.IsRequired && string.IsNullOrWhiteSpace(attributeEntry.Value))
                                        {
                                            <div class="text-danger small mt-1">@ValidationResources.FieldRequired</div>
                                        }
                                    }
                                }
                                else
                                {
                                    <div class="alert alert-warning mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        ?? ??? ????? ?????? ???? ???????
                                    </div>
                                }
                            }
                            else if (_attribute.FieldType == FieldType.MultiSelectList)
                            {
                                @if (_attribute.AttributeOptions != null && _attribute.AttributeOptions.Any())
                                {
                                    <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto; background-color: #f8f9fa;">
                                        <small class="text-muted d-block mb-2">???? ?????? ??????</small>
                                        @foreach (var option in _attribute.AttributeOptions.OrderBy(o => o.DisplayOrder))
                                        {
                                            var selectedOptions = (attributeEntry.Value ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries).ToList();
                                            var isSelected = selectedOptions.Contains(option.Id.ToString());
                                            var optionId = $"option_{option.Id}";

                                            <div class="form-check mb-2">
                                                <input type="checkbox" class="form-check-input"
                                                       id="@optionId"
                                                       checked="@isSelected"
                                                       @onchange="@(async () => { await ToggleOption(attributeEntry, option.Id); })" />
                                                <label class="form-check-label" for="@optionId">
                                                    @option.Title
                                                </label>
                                            </div>
                                        }
                                    </div>
                                    @if (_attribute.IsRequired && string.IsNullOrWhiteSpace(attributeEntry.Value))
                                    {
                                        <div class="text-danger small mt-1">@ValidationResources.FieldRequired</div>
                                    }
                                }
                                else
                                {
                                    <div class="alert alert-warning mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        @ECommerceResources.NoOptionsConfigured
                                    </div>
                                }
                            }
                        </div>
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm mt-4"
                                @onclick="() => RemoveAttribute(_attribute.Id)"
                                title="@ActionsResources.Delete @ECommerceResources.Attribute">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Auto-generate combinations info -->
    @if (CategoryAttributes.Any(ca => ca.AffectsPricing))
    {
        <div class="alert alert-info d-flex align-items-center mb-3">
            <i class="fas fa-info-circle me-3 fs-5"></i>
            <div>
                <strong>??????? ???????? ???????? ??????:</strong>
                <p class="mb-0 small">???? ????? ??????? ?????? ???????? ??? ????? ??? ?????? ??????? ??? ?????</p>
            </div>
        </div>
    }
}
else
{
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        ?? ???? ????? ??????? ???? ????? ???
    </div>
}
