// Local Storage Helper for Blazor WebAssembly
// Provides utility functions for localStorage operations

window.localStorageHelper = window.localStorageHelper || {};

// Get auto-load preference (used for statistics dashboard)
window.getAutoLoadPreference = function () {
    try {
        const value = localStorage.getItem('autoLoadPreference');
        return value === 'true' || value === null; // Default to true if not set
    } catch (e) {
        console.error('Error reading autoLoadPreference from localStorage:', e);
        return true; // Default to true on error
    }
};

// Set auto-load preference
window.setAutoLoadPreference = function (value) {
    try {
        localStorage.setItem('autoLoadPreference', value.toString());
        return true;
    } catch (e) {
        console.error('Error writing autoLoadPreference to localStorage:', e);
        return false;
    }
};

// Generic localStorage helper functions
window.localStorageHelper = {
    // Get an item from localStorage
    getItem: function (key) {
        try {
            return localStorage.getItem(key);
        } catch (e) {
            console.error(`Error reading ${key} from localStorage:`, e);
            return null;
        }
    },

    // Set an item in localStorage
    setItem: function (key, value) {
        try {
            localStorage.setItem(key, value);
            return true;
        } catch (e) {
            console.error(`Error writing ${key} to localStorage:`, e);
            return false;
        }
    },

    // Remove an item from localStorage
    removeItem: function (key) {
        try {
            localStorage.removeItem(key);
            return true;
        } catch (e) {
            console.error(`Error removing ${key} from localStorage:`, e);
            return false;
        }
    },

    // Clear all localStorage
    clear: function () {
        try {
            localStorage.clear();
            return true;
        } catch (e) {
            console.error('Error clearing localStorage:', e);
            return false;
        }
    },

    // Check if a key exists in localStorage
    hasKey: function (key) {
        try {
            return localStorage.getItem(key) !== null;
        } catch (e) {
            console.error(`Error checking ${key} in localStorage:`, e);
            return false;
        }
    },

    // Get item as JSON
    getItemAsJson: function (key) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
        } catch (e) {
            console.error(`Error parsing ${key} from localStorage:`, e);
            return null;
        }
    },

    // Set item as JSON
    setItemAsJson: function (key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch (e) {
            console.error(`Error writing ${key} to localStorage as JSON:`, e);
            return false;
        }
    }
};

// Export functions for module systems if needed
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        getAutoLoadPreference: window.getAutoLoadPreference,
        setAutoLoadPreference: window.setAutoLoadPreference,
        localStorageHelper: window.localStorageHelper
    };
}

// HTTP Client Helper for Cookie-based Authentication in Blazor WebAssembly
// This ensures cookies AND Bearer tokens are sent with every request

window.httpClientHelper = {
    // ? Get auth token from localStorage
    getAuthToken: function () {
        try {
            const token = localStorage.getItem('authToken');
            return token;
        } catch (error) {
            console.error('[HttpClientHelper] Error getting auth token:', error);
            return null;
        }
    },

    // Fetch with credentials to ensure cookies are sent
    fetchWithCredentials: async function (url, method, body, headers) {
        try {
            // ? Get token from localStorage
            const token = this.getAuthToken();
            
            const options = {
                method: method || 'GET',
                credentials: 'include', // ? CRITICAL: This ensures cookies are sent with requests
                mode: 'cors', // ? IMPORTANT: Enable CORS mode
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...headers
                }
            };

            // ? Add Bearer token if available
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }

            // Add body if provided (for POST, PUT, etc.)
            if (body && method !== 'GET' && method !== 'HEAD') {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(url, options);
            const responseText = await response.text();

            // ? Check if we got set-cookie headers (for debugging - won't work with HttpOnly cookies)
            const setCookieHeader = response.headers.get('set-cookie');

            return {
                ok: response.ok,
                status: response.status,
                statusText: response.statusText,
                body: responseText
            };
        } catch (error) {
            console.error('[HttpClientHelper] Error:', error);
            return {
                ok: false,
                status: 0,
                statusText: error.message || 'Network error',
                body: ''
            };
        }
    },

    // ? Check if a specific cookie exists
    // Note: HttpOnly cookies cannot be read by JavaScript for security
    // So we check localStorage for auth state flag instead
    hasCookie: function (cookieName) {
        try {
            // ? For HttpOnly cookies, we can't check document.cookie
            // Instead, we check localStorage for auth state flag
            const hasAuthState = localStorage.getItem('isAuthenticated') === 'true';
            
            return hasAuthState;
        } catch (error) {
            console.error('[HttpClientHelper] Error checking cookie:', error);
            return false;
        }
    },

    // Check all cookies (for debugging)
    checkCookies: function () {
        return document.cookie;
    },

    // ? Set a flag in localStorage when user logs in
    setAuthState: function (isAuthenticated) {
        try {
            if (isAuthenticated) {
                localStorage.setItem('isAuthenticated', 'true');
            } else {
                localStorage.removeItem('isAuthenticated');
            }
        } catch (error) {
            console.error('[HttpClientHelper] Error setting auth state:', error);
        }
    },

    // ? Check auth state from localStorage
    checkAuthState: function () {
        try {
            const isAuth = localStorage.getItem('isAuthenticated') === 'true';
            return isAuth;
        } catch (error) {
            console.error('[HttpClientHelper] Error checking auth state:', error);
            return false;
        }
    },

    // ? Clear all auth-related data
    clearAuthData: function () {
        try {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('authToken'); // ? Also clear token
        } catch (error) {
            console.error('[HttpClientHelper] Error clearing auth data:', error);
        }
    }
};
