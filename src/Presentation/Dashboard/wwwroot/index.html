<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <base href="/" />
    <title>لوحة التحكم الذكية</title>

    <link rel="icon" type="image/x-icon" href="/assets/images/favicon.svg" />

    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <!-- fontawesome icon -->
    <link rel="stylesheet"
          href="assets/fonts/fontawesome/css/fontawesome-all.min.css" />

    <!-- animation css -->
    <link rel="stylesheet"
          href="assets/plugins/animation/css/animate.min.css" />

    <!-- material icon -->
    <link rel="stylesheet"
          href="assets/fonts/material/css/materialdesignicons.min.css" />

    <link href="css/app.css" rel="stylesheet" />

    <!-- vendor css -->
    <link rel="stylesheet" href="assets/css/style.css" />
    <!-- Add Select2 CSS and JS references-->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <link href="css/select2-bootstrap5.css" rel="stylesheet" />
</head>

<body>
    <div id="app">
    </div>

    <script src="Common/language/localization.js"></script>

    <script src="_framework/blazor.webassembly.js"></script>

    <!-- Required Js -->
    <script src="assets/js/vendor-all.min.js"></script>
    <script src="assets/plugins/bootstrap/js/popper.min.js"></script>
    <script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script defer src="assets/js/pcoded.min.js"></script>

    <script src="Common/Scripts/ScriptLoader.js"></script>
    <!-- sweet alert Js -->
    <script src="assets/plugins/sweetalert/js/sweetalert.min.js"></script>
    <script src="assets/js/pages/ac-alert.js"></script>
    <script src="assets/js/plugins/jquery.repeater.min.js"></script>

    <script>
        function initializePcodedMenu() {
            initIcoded();
        }
    </script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="js/select2Helper.js"></script>

    <script>
        // Enhanced menu toggle for Blazor WebAssembly - works for both mobile and desktop
        $(document).ready(function () {
            setTimeout(function () {
                // Don't remove all handlers - instead, add our enhanced handler with higher priority
                // Use event delegation to work with dynamically rendered Blazor content
                $(document).off('click.blazor-enhanced').on('click.blazor-enhanced', '#mobile-collapse, #mobile-collapse1, .mobile-menu', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    var vw = window.innerWidth || document.documentElement.clientWidth;

                    if (vw < 992) {
                        // Mobile behavior - toggle mob-open class
                        var $navbar = $(".pcoded-navbar");
                        var isOpen = $navbar.hasClass('mob-open');

                        if (isOpen) {
                            $navbar.removeClass('mob-open');
                            $(this).removeClass('on');
                            $(".mobile-menu").removeClass('on');
                            $("#mobile-collapse, #mobile-collapse1").removeClass('on');
                        } else {
                            $navbar.addClass('mob-open');
                            $(this).addClass('on');
                            $(".mobile-menu").addClass('on');
                            $("#mobile-collapse, #mobile-collapse1").addClass('on');
                        }
                    }
                });

                // Close mobile menu when clicking outside (mobile only)
                $(document).off('click.blazor-outside').on('click.blazor-outside', function (e) {
                    var vw = window.innerWidth || document.documentElement.clientWidth;

                    if (vw < 992) {
                        var $target = $(e.target);
                        var isMenuClick = $target.closest('.pcoded-navbar, #mobile-collapse, #mobile-collapse1, .mobile-menu').length > 0;

                        if (!isMenuClick && $(".pcoded-navbar").hasClass("mob-open")) {
                            $(".pcoded-navbar").removeClass('mob-open');
                            $("#mobile-collapse, #mobile-collapse1, .mobile-menu").removeClass('on');
                        }
                    }
                });

                // Prevent navbar content clicks from closing menu
                $(document).off('click.blazor-prevent').on('click.blazor-prevent', '.pcoded-navbar', function (e) {
                    e.stopPropagation();
                });

                // Handle window resize - reset menu states appropriately
                $(window).off('resize.blazor-enhanced').on('resize.blazor-enhanced', function () {
                    var vw = window.innerWidth || document.documentElement.clientWidth;
                    var $navbar = $(".pcoded-navbar");

                    if (vw >= 992) {
                        // Desktop view - remove mobile classes and apply desktop logic
                        $navbar.removeClass('mob-open');
                        $("#mobile-collapse, #mobile-collapse1, .mobile-menu").removeClass('on');

                        // Apply desktop menu logic based on screen size
                        if (vw <= 1200 && vw >= 992) {
                            $navbar.addClass('navbar-collapsed');
                        }
                    } else {
                        // Mobile view - remove desktop classes
                        $navbar.removeClass('navbar-collapsed');
                    }

                    console.log('Window resized. New width:', vw, 'Navbar classes:', $navbar[0]?.className);
                });

                // Initialize proper menu state based on current viewport
                var currentVw = window.innerWidth || document.documentElement.clientWidth;
                var $navbar = $(".pcoded-navbar");

                if (currentVw >= 992 && currentVw <= 1200) {
                    // Desktop - should be collapsed by default
                    $navbar.addClass('navbar-collapsed');
                } else if (currentVw >= 1200) {
                    // Large desktop - expanded by default
                    $navbar.removeClass('navbar-collapsed');
                } else {
                    // Mobile - ensure no desktop classes
                    $navbar.removeClass('navbar-collapsed');
                }

                console.log('Enhanced menu system initialized! Current viewport:', currentVw);

            }, 1000); // Wait for Blazor to render

            // Retry mechanism for late-rendered elements
            setTimeout(function () {
                var foundElements = $('#mobile-collapse, #mobile-collapse1, .mobile-menu').length;
                console.log('Menu elements found after 3 seconds:', foundElements);

                if (foundElements === 0) {
                    console.warn('Mobile menu buttons still not found. Check your NavMenu component for correct IDs/classes.');
                }
            }, 3000);
        });

        // Helper functions
        function setActiveMenuItems() {
            if (typeof $ === 'undefined') return;

            try {
                $(".pcoded-navbar .pcoded-inner-navbar a").each(function () {
                    var pageUrl = window.location.href.split(/[?#]/)[0];
                    if (this.href == pageUrl && $(this).attr('href') != "") {
                        $(this).parent('li').addClass("active");
                        if (!$('.pcoded-navbar').hasClass('theme-horizontal')) {
                            $(this).parent('li').parent().parent('.pcoded-hasmenu').addClass("active").addClass("pcoded-trigger");
                            $(this).parent('li').parent().parent('.pcoded-hasmenu').parent().parent('.pcoded-hasmenu').addClass("active").addClass("pcoded-trigger");
                        }
                    }
                });
            } catch (error) {
                console.error('Error setting active menu items:', error);
            }
        }

        function initializePerfectScrollbar(selector) {
            if (typeof PerfectScrollbar === 'undefined') return;

            try {
                var element = document.querySelector('.' + selector);
                if (element) {
                    new PerfectScrollbar('.' + selector, {
                        wheelSpeed: 0.5,
                        swipeEasing: 0,
                        suppressScrollX: true,
                        wheelPropagation: 1,
                        minScrollbarLength: 40,
                    });
                }
            } catch (error) {
                console.error('Error initializing perfect scrollbar:', error);
            }
        }

        // Initialize menu after a delay to ensure everything is loaded
        setTimeout(function () {
            if (typeof setActiveMenuItems === 'function') {
                setActiveMenuItems();
            }
        }, 1500);
    </script>

    <script>
        // Navigation scrollbar initialization
        window.initializeNavScrollbar = () => {
            setTimeout(() => {
                if (document.querySelector('.navbar-content') && typeof PerfectScrollbar !== 'undefined') {
                    // Destroy existing scrollbar if any
                    if (window.navScrollbar) {
                        window.navScrollbar.destroy();
                    }

                    // Initialize new scrollbar
                    window.navScrollbar = new PerfectScrollbar('.navbar-content', {
                        wheelSpeed: 0.5,
                        swipeEasing: 0,
                        suppressScrollX: true,
                        wheelPropagation: 1,
                        minScrollbarLength: 40,
                    });
                }
            }, 100);
        };

        // Initialize scrollbar when DOM is ready
        $(document).ready(function () {
            // Wait for elements to be rendered, then initialize scrollbar
            setTimeout(function () {
                window.initializeNavScrollbar();
            }, 1500); // Give time for Blazor to render
        });
    </script>
</body>

</html>
