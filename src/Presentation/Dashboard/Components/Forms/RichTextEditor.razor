@* @namespace Dashboard.Components.Forms
@implements IAsyncDisposable

<div class="rich-text-editor-container @Class" data-theme="@Theme">
    @if (!_isInitialized && _isRendered)
    {
        <!-- Loading State -->
        <div class="editor-loading-container" style="height: @(Height)px;">
            <textarea id="@_elementId" placeholder="@Placeholder" style="display: none;"></textarea>
            <div class="editor-loading-indicator">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="text-muted">Loading text editor...</span>
            </div>
        </div>
    }
    else if (!_isRendered)
    {
        <!-- Initial render placeholder -->
        <div class="editor-placeholder" style="height: @(Height)px;">
            <textarea id="@_elementId" 
                      class="form-control" 
                      placeholder="@Placeholder" 
                      readonly="@Readonly"
                      style="height: 100%; resize: vertical;">@Value</textarea>
        </div>
    }
    else
    {
        <!-- Normal Editor -->
        <div class="editor-wrapper">
            <textarea id="@_elementId" 
                      class="form-control rich-text-editor" 
                      placeholder="@Placeholder"
                      readonly="@Readonly"
                      style="height: @(Height)px;">@Value</textarea>
        </div>
    }
    
    @if ((EnableWordCount || EnableCharCount) && _isInitialized)
    {
        <div class="editor-stats mt-2 small text-muted d-flex justify-content-between align-items-center">
            <div>
                @if (EnableWordCount)
                {
                    <span class="me-3">Words: <span id="@(_elementId)_wordcount">0</span></span>
                }
                @if (EnableCharCount)
                {
                    <span>Characters: <span id="@(_elementId)_charcount">0</span></span>
                }
            </div>
            
            @if (MaxCharCount > 0)
            {
                <div class="text-end">
                    <span class="@(MaxCharCount > 0 ? "text-warning" : "")">
                        @if (MaxCharCount > 0)
                        {
                            <text>/ @MaxCharCount max</text>
                        }
                    </span>
                </div>
            }
        </div>
    }
</div>

<!-- Load external CSS file for advanced styles -->
<link href="css/rich-text-editor.css" rel="stylesheet" />

@code {
    // The code-behind logic is handled in RichTextEditor.razor.cs
    // This ensures separation of concerns and better maintainability
} *@


@using Microsoft.JSInterop
@implements IAsyncDisposable

<div>
    <div id="@EditorId" style="background-color: white;"></div>
</div>

@code {
    [Parameter] public string Value { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Start typing...";
    [Parameter] public int Height { get; set; } = 300;
    [Parameter] public string Language { get; set; } = "en";

    // Parameters for additional features (optional)
    [Parameter] public bool EnableImageUpload { get; set; } = true;
    [Parameter] public bool EnableVideoEmbed { get; set; } = true;
    [Parameter] public bool EnableCodeEditor { get; set; } = true;
    [Parameter] public bool EnableSpellCheck { get; set; } = true;
    [Parameter] public bool EnableWordCount { get; set; } = true;
    [Parameter] public bool EnableCharCount { get; set; } = true;
    [Parameter] public bool EnablePreview { get; set; } = true;
    [Parameter] public bool EnableFullscreen { get; set; } = true;
    [Parameter] public string Theme { get; set; } = "snow";
    [Parameter] public int MaxCharCount { get; set; } = 10000;

    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;

    private string EditorId = $"quill-editor-{Guid.NewGuid():N}";
    private DotNetObjectReference<RichTextEditor>? dotNetReference;
    private bool isInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                dotNetReference = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("initQuillEditor",
                    EditorId,
                    dotNetReference,
                    Value,
                    Placeholder,
                    Height);
                isInitialized = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing Quill: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task UpdateValue(string newValue)
    {
        if (Value != newValue)
        {
            Value = newValue;
            await ValueChanged.InvokeAsync(Value);
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (isInitialized)
            {
                await JSRuntime.InvokeVoidAsync("destroyQuillEditor", EditorId);
            }
            dotNetReference?.Dispose();
        }
        catch (Exception)
        {
            // Ignore errors during disposal
        }
    }
}