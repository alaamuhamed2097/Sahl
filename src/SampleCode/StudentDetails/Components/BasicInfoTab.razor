@namespace Dashboard.Pages.User.UserDetails.Components
@using Common.Enumeration.User
@using Resources

<PageTitle>@FormResources.BasicInformation</PageTitle>

<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-user"></i>
            <span>@FormResources.BasicInformation</span>
        </div>
        <div>
            <button class="btn btn-primary" @onclick="OpenEditPopup">
                <i class="fas fa-edit"></i>
                <span>@AdminResources.EditUser</span>
            </button>
        </div>
    </div>
    <div class="card-content" id="primarySpecsContent">
        <div class="user-details-layout">
            <div class="user-photo-section">
                <img src="@ProfileImage" alt="@($"{student?.FristName} {student?.LastName}")" class="user-photo">
                <div class="user-basic-info ">
                    <h2>@student?.FristName @student?.LastName</h2>
                    <p class="user-email">
                        <i class="fas fa-envelope" style="margin-right: 8px;"></i>@student?.Email
                    </p>
                    <p class="user-phone"> <i class="fas fa-phone" style="margin-right: 8px;"></i>@($"{student?.CountryCode}{student?.PhoneNumber}")</p>
                </div>
            </div>

            <div class="user-info-gridtap">
                <div class="info-box"><span class="info-label">@AdminResources.Courses</span><span class="info-value">@student?.CoursesCount</span></div>
                <div class="info-box"><span class="info-label">@AdminResources.Diplomas</span><span class="info-value">@student?.DiplomasCount</span></div>
                <div class="info-box"><span class="info-label">@AdminResources.ConfirmationCode</span><span class="info-value">@(student?.ConfirmationCode == null ? "None" : student?.ConfirmationCode)</span></div>
                <div class="info-box"><span class="info-label">@GeneralResources.LastLogin</span><span class="info-value">@student?.LastLoginDate?.ToString("yyyy-MM-dd hh:mm tt")</span></div>
                <div class="info-box"><span class="info-label">@AdminResources.Activity</span><span class="info-value text-success">@student?.IsActiveText</span></div>
                <div class="info-box"><span class="info-label">@AdminResources.Status</span><span class="info-value text-primary">@student?.CurrentStateText</span></div>
            </div>

            <div class="user-actions">
                <div class="dropdown">
                    <button class="dropbtn">Actions</button>
                    <div class="dropdown-content">
                        @if (student.CurrentState != (int)UserState.Deleted)
                        {
                            <button class="btn btn-danger" @onclick="() => Delete(new Guid(student.UserId))">@ActionsResources.Delete</button>
                        }

                        @if (student.CurrentState != (int)UserState.Blocked)
                        {
                            <button class="btn btn-warning" @onclick="() => Block(new Guid(student.UserId))">@ActionsResources.Block</button>
                        }

                        @if (student.CurrentState == (int)UserState.Deleted || student.CurrentState == (int)UserState.Blocked)
                        {
                            <button class="btn btn-success" @onclick="() => ReActive(new Guid(student.UserId))">@ActionsResources.Activate</button>
                        }
                        
                        <button class="btn btn-primary" @onclick="OpenChangePasswordPopup">@ActionsResources.ChangePassword</button>
                        <button class="btn btn-success" @onclick="OpenSendEmailPopup">@ActionsResources.SendEmail</button>
                        <button class="btn btn-info" @onclick="SendActivationEmail">@ActionsResources.SendActivationEmail</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- User Edit Popup -->
@if (showEditPopup)
{
    <div class="popup-overlay active" @onclick="CloseEditPopup">
        <div class="popup-content" @onclick:stopPropagation="true">
            <div class="popup-header">
                <h2><i class="fas fa-edit"></i> تعديل بيانات المستخدم</h2>
                <button class="close-btn" @onclick="CloseEditPopup">×</button>
            </div>

            <div class="userEditContainer">
                <EditForm Model="userForm" OnValidSubmit="SaveUserEdits">
                    <DataAnnotationsValidator />

                    <div class="user-edit-popup-layout">
                        <!-- صورة المستخدم -->
                        <div class="user-photo-section">
                            <div class="image-preview-container mb-3" style="width: 180px; height: 180px; border: 1px dashed #cbd5e1; border-radius: 50%; background: #f8fafc; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                @if (!string.IsNullOrEmpty(imagePreview))
                                {
                                    <img src="@imagePreview" alt="Image Preview" class="user-photo-large" style="width: 100%; height: 100%; object-fit: cover;" />
                                }
                                else if (!string.IsNullOrEmpty(originalImage))
                                {
                                    <img src="@GetImageSrc(originalImage)" alt="@userForm.FristName" class="user-photo-large" style="width: 100%; height: 100%; object-fit: cover;" />
                                }
                                else
                                {
                                    <i class="fas fa-user fa-3x" style="color:#94a3b8;"></i>
                                }
                            </div>
                            <label class="upload-btn">
                                <i class="fas fa-camera"></i> تغيير الصورة
                                <InputFile OnChange="HandleFileSelected" accept="image/*" hidden />
                            </label>
                        </div>

                        <!-- حقول البيانات -->
                        <div class="user-form-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>@FormResources.LastName</label>
                                    <InputText @bind-Value="userForm.LastName" class="form-control" />
                                    <ValidationMessage For="@(() => userForm.LastName)" />
                                </div>
                                <div class="form-group">
                                    <label>@FormResources.Email</label>
                                    <InputText @bind-Value="userForm.Email" type="email" class="form-control" />
                                    <ValidationMessage For="@(() => userForm.Email)" />
                                </div>
                                <div class="form-group">
                                    <label>@FormResources.PhoneNumber</label>
                                    <InputText @bind-Value="userForm.PhoneNumber" class="form-control" />
                                    <ValidationMessage For="@(() => userForm.PhoneNumber)" />
                                </div>
                                <div class="form-group">
                                    <label>@FormResources.CountryCode</label>
                                    <InputText @bind-Value="userForm.CountryCode" class="form-control" />
                                    <ValidationMessage For="@(() => userForm.CountryCode)" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="popup-footer">
                        @if (isSaving)
                        {
                            <button type="submit" class="btn btn-success" disabled>
                                <span class="spinner-border" role="status" aria-hidden="true"></span>
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="btn btn-success" @onclick="SaveUserEdits">
                                <i class="fas fa-save"></i> @ActionsResources.Save
                            </button>
                        }

                        <button type="button" class="btn btn-secondary" @onclick="CloseEditPopup">
                            <i class="fas fa-times"></i> @ActionsResources.Cancel
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}


<!-- Send Email Popup -->
@if (showSendEmailPopup)
{
    <div class="popup-overlay active" @onclick="CloseSendEmailPopup">
        <div class="popup-content" @onclick:stopPropagation="true">
            <div class="popup-header">
                <h2><i class="fas fa-envelope"></i> @ActionsResources.SendEmail</h2>
                <button class="close-btn" @onclick="CloseSendEmailPopup">×</button>
            </div>

            <div class="userEditContainer">
                <EditForm Model="sendEmailForm" OnValidSubmit="SubmitSendEmail">
                    <DataAnnotationsValidator />

                    <div class="user-form-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>@GeneralResources.Subject</label>
                                <InputText @bind-Value="sendEmailForm.Subject" class="form-control" />
                                <ValidationMessage For="@(() => sendEmailForm.Subject)" />
                            </div>
                            <div class="form-group">
                                <label>@GeneralResources.Title</label>
                                <InputText @bind-Value="sendEmailForm.Title" class="form-control" />
                                <ValidationMessage For="@(() => sendEmailForm.Title)" />
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>@GeneralResources.Message</label>
                                <InputTextArea @bind-Value="sendEmailForm.Message" class="form-control" rows="5" />
                                <ValidationMessage For="@(() => sendEmailForm.Message)" />
                            </div>
                        </div>
                    </div>

                    <div class="popup-footer">
                        @if (isSendingEmail)
                        {
                            <button type="submit" class="btn btn-success" disabled>
                                <span class="spinner-border" role="status" aria-hidden="true"></span>
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> @ActionsResources.Send
                            </button>
                        }

                        <button type="button" class="btn btn-secondary" @onclick="CloseSendEmailPopup">
                            <i class="fas fa-times"></i> @ActionsResources.Cancel
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}


<!-- Change Password Popup -->
@if (showChangePasswordPopup)
{
    <div class="popup-overlay active" @onclick="CloseChangePasswordPopup">
        <div class="popup-content" @onclick:stopPropagation="true">
            <div class="popup-header">
                <h2><i class="fas fa-key"></i> @ActionsResources.ChangePassword</h2>
                <button class="close-btn" @onclick="CloseChangePasswordPopup">×</button>
            </div>

            <div class="userEditContainer">
                <EditForm Model="changePasswordForm" OnValidSubmit="SubmitChangePassword">
                    <DataAnnotationsValidator />

                    <div class="user-form-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>@UserResources.NewPassword</label>
                                <InputText @bind-Value="changePasswordForm.NewPassword" class="form-control" type="password" />
                                <ValidationMessage For="@(() => changePasswordForm.NewPassword)" />
                            </div>
                            <div class="form-group">
                                <label>@UserResources.PasswordConfirmation</label>
                                <InputText @bind-Value="changePasswordForm.PasswordConfirmation" class="form-control" type="password" />
                                <ValidationMessage For="@(() => changePasswordForm.PasswordConfirmation)" />
                            </div>
                        </div>
                    </div>

                    <div class="popup-footer">
                        @if (isChangingPassword)
                        {
                            <button type="submit" class="btn btn-success" disabled>
                                <span class="spinner-border" role="status" aria-hidden="true"></span>
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> @ActionsResources.Save
                            </button>
                        }

                        <button type="button" class="btn btn-secondary" @onclick="CloseChangePasswordPopup">
                            <i class="fas fa-times"></i> @ActionsResources.Cancel
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

