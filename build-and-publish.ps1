# Build and Publish Script - Sahl Project
# Usage: .\build-and-publish.ps1 [-Type patch|minor|major] [-ForceUpdate]

param(
    [ValidateSet('patch', 'minor', 'major')]
    [string]$Type = 'patch',
    
    [switch]$ForceUpdate,
    
    [string]$OutputPath = ".\publish"
)

Write-Host @"
????????????????????????????????????????????????????????????
?          ?? Build & Publish - Sahl Project              ?
????????????????????????????????????????????????????????????
"@ -ForegroundColor Cyan

Write-Host ""

# Step 1: Update Version
Write-Host "1?? ????? ???????..." -ForegroundColor Yellow

$updateParams = @{
    Type = $Type
}

if ($ForceUpdate) {
    $updateParams.Add('ForceUpdate', $true)
}

try {
    & "$PSScriptRoot\update-version.ps1" @updateParams
    Write-Host "   ? ?? ????? ???????" -ForegroundColor Green
} catch {
    Write-Host "   ? ??? ????? ???????: $_" -ForegroundColor Red
    exit 1
}

Write-Host ""

# Step 2: Read new version
$versionFile = Join-Path $PSScriptRoot "src\Presentation\Dashboard\wwwroot\version.json"
$versionData = Get-Content $versionFile | ConvertFrom-Json
$newVersion = $versionData.version

Write-Host "?? ??????? ??????: $newVersion" -ForegroundColor Cyan
Write-Host ""

# Step 3: Build
Write-Host "2?? ??? Build..." -ForegroundColor Yellow

try {
    $buildOutput = dotnet build -c Release 2>&1
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "   ? Build ???!" -ForegroundColor Red
        Write-Host $buildOutput -ForegroundColor Red
        exit 1
    }
    
    Write-Host "   ? Build ???" -ForegroundColor Green
} catch {
    Write-Host "   ? ??? ?? Build: $_" -ForegroundColor Red
    exit 1
}

Write-Host ""

# Step 4: Publish
Write-Host "3?? ??? Publish..." -ForegroundColor Yellow

$dashboardPath = Join-Path $PSScriptRoot "src\Presentation\Dashboard"
$publishPath = Join-Path $dashboardPath $OutputPath

try {
    Push-Location $dashboardPath
    
    $publishOutput = dotnet publish -c Release -o $OutputPath 2>&1
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "   ? Publish ???!" -ForegroundColor Red
        Write-Host $publishOutput -ForegroundColor Red
        Pop-Location
        exit 1
    }
    
    Write-Host "   ? Publish ???" -ForegroundColor Green
    
    Pop-Location
} catch {
    Write-Host "   ? ??? ?? Publish: $_" -ForegroundColor Red
    Pop-Location
    exit 1
}

Write-Host ""

# Step 5: Verify version in publish
Write-Host "4?? ?????? ?? ???????..." -ForegroundColor Yellow

$publishedVersionFile = Join-Path $publishPath "wwwroot\version.json"

if (Test-Path $publishedVersionFile) {
    $publishedVersion = (Get-Content $publishedVersionFile | ConvertFrom-Json).version
    
    if ($publishedVersion -eq $newVersion) {
        Write-Host "   ? ??????? ???? ?? publish: $publishedVersion" -ForegroundColor Green
    } else {
        Write-Host "   ?? ?????: ??????? ?????!" -ForegroundColor Yellow
        Write-Host "   ???????: $newVersion" -ForegroundColor Yellow
        Write-Host "   ???????: $publishedVersion" -ForegroundColor Yellow
    }
} else {
    Write-Host "   ?? ?????: version.json ??? ????? ?? publish!" -ForegroundColor Yellow
}

Write-Host ""

# Summary
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?              ? ????? Build & Publish!                  ?" -ForegroundColor Green
Write-Host "????????????????????????????????????????????????????????????" -ForegroundColor Green

Write-Host ""
Write-Host "?? ???????: $newVersion" -ForegroundColor Cyan
Write-Host "?? ??????: $publishPath" -ForegroundColor Cyan
Write-Host "?? Force Update: $ForceUpdate" -ForegroundColor Cyan

Write-Host ""
Write-Host "?? ??????? ???????:" -ForegroundColor Yellow
Write-Host "   1. ???? ?? ??????? ??: $publishPath" -ForegroundColor Gray
Write-Host "   2. ????? ?????? (dotnet run)" -ForegroundColor Gray
Write-Host "   3. ???? ??????? ???????" -ForegroundColor Gray
Write-Host "   4. ???? ?? Console ?? ???????" -ForegroundColor Gray

Write-Host ""
