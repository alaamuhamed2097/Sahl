# ? ????? ????? Reload ??? ?? ???? - ???? ???????

## ? ??????? ???????

??? ??????? ???? **reload ??? ???????? ??? ???? ?????** ????:

### ????? ??????:

```html
<!-- ?? index.html -->
<script src="js/version-manager.js"></script>
```

**???????:**
- `version-manager.js` ??? ?????? **global** ?? `index.html`
- ??? ?? navigation ???? Blazor? **???? ??? script ?????**
- ??? Blazor **???? ????? ?????** ?? ??? ???????!
- ??? ???? ??? ????? `VersionManager.init()` **??? ????**
- ?? ??? `init()` ????? ?????? `checkForUpdates()`
- ? `checkForUpdates()` ???? reload!

---

## ? ???? ???????

### ????????? ????????:

#### 1. **????? `sessionStorage` ?????? ?? ???????:**
```javascript
const INITIALIZED_KEY = 'version_manager_initialized';

const VersionManager = {
    _hasInitialized: false, // ? Local flag
    
    init: function () {
        // ? ???? ?? ??????? ???????
        if (this._hasInitialized) {
            console.log('? Already initialized, skipping...');
            return;
        }

        // ? ???? ?? sessionStorage
        const sessionInitialized = sessionStorage.getItem(INITIALIZED_KEY);
        if (sessionInitialized) {
            console.log('? Already initialized in this session, skipping...');
            this._hasInitialized = true;
            return;
        }

        console.log('? Initializing...');
        
        // ? Mark as initialized
        this._hasInitialized = true;
        sessionStorage.setItem(INITIALIZED_KEY, 'true');
        
        // ... continue initialization
    }
}
```

#### 2. **??? sessionStorage ??? reload:**
```javascript
reloadApp: function () {
    console.log('?? Reloading application...');
    
    // ? Clear sessionStorage flag before reload
    sessionStorage.removeItem(INITIALIZED_KEY);
    
    localStorage.setItem(RELOAD_LOCK_KEY, Date.now().toString());
    
    setTimeout(() => {
        window.location.reload(true);
    }, 500);
}
```

---

## ? ????? ??? localStorage ? sessionStorage

### localStorage:
- **???? ??? ????? ???????**
- ????? ?????? ??????? (`app_version`)
- ???? ??? ???????

### sessionStorage:
- **???? ??? ????? ???????**
- ????? ????? ??????? (`version_manager_initialized`)
- ???? ??? ?? ?????? ???????

---

## ? ??? ???? ?????

### ??? ??? ?????:
```
? Page Load (First Time)
  ? init() called
    ? Check _hasInitialized: false ?
    ? Check sessionStorage: null ?
    ? Set _hasInitialized = true
    ? Set sessionStorage['version_manager_initialized'] = 'true'
    ? checkForUpdates(true)
    ? startPeriodicCheck()
```

### ??? ???????? ????? ???? (Blazor Navigation):
```
? Navigate to /products
  ? Blazor renders new component
  ? version-manager.js ALREADY LOADED
  ? init() called again (because of DOM ready)
    ? Check _hasInitialized: true ?
    ? ? STOP! (no re-initialization)
```

### ??? update ?reload:
```
? New version detected
  ? performUpdate()
    ? sessionStorage.removeItem('version_manager_initialized')
    ? localStorage.setItem('version_reload_lock', timestamp)
    ? window.location.reload()
  
? Page Load (After Reload)
  ? init() called
    ? Check sessionStorage: null (cleared) ?
    ? Check RELOAD_LOCK: exists ?
    ? Skip checkForUpdates() for 30 seconds
    ? ? NO infinite reload!
```

---

## ? ?????? ???????

### 1. ?????? Navigation:

```javascript
// ?? Console (F12):

// 1. ???? ?????? ????????
// ??? ??? ?? ???:
// - "? Version Manager: Initializing..."
// - "?? Version stored: X.X.X"

// 2. ????? ????? ???? (????? /products)
// ??? ??? ?? ???:
// - "? Version Manager: Already initialized in this session, skipping..."
// - NO "Initializing..." again
// - NO reload

// 3. ????? ????? ????? (????? /categories)
// ??? ??? ?? ???:
// - ??? ??????? "Already initialized..."
// - NO reload

// 4. ???? ?? sessionStorage
sessionStorage.getItem('version_manager_initialized')
// ??? Expected: "true"
```

### 2. ?????? Update:

```javascript
// ?? Console (F12):

// 1. ???? ??????? ???????
localStorage.removeItem('app_version');

// 2. ??? ????? ??????
location.reload();

// ??? Expected:
// - "?? Version stored: X.X.X"
// - ???? ?? ???????
// - NO infinite reload!
// - NO reload ??? navigation
```

### 3. ?????? ??? ?????:

```
1. ???? ???????
2. ????? ??? /products
3. ????? ??? /categories
4. ????? ??? /units
5. ????? ??? /settings
6. ???? ??? /home

??? Expected:
- ?? navigation ???? ??????
- NO reload ?? ?? ????
- init() ???? ??? ????? ???
```

---

## ? ?????? ?? sessionStorage

### ????? 1: Console

```javascript
// ?? Console (F12):

// ???? ?? ??????
sessionStorage.getItem('version_manager_initialized')
// ??? Expected: "true"

// ???? ?? ???? ????????
Object.keys(sessionStorage)
// ??? Expected: Array with "version_manager_initialized"

// ???? ?????? (????????)
sessionStorage.removeItem('version_manager_initialized')

// ???? navigate ????? ????
// ??? ????? ????? init()
```

### ????? 2: DevTools

```
1. ???? DevTools (F12)
2. ???? ??? Application Tab
3. ?? ?????? ??????? ???? ??? Session Storage
4. ???? ????? (?????: https://localhost:XXXX)
5. ???? ??: version_manager_initialized
6. ??? ?????? ??? ?? ????: true
```

---

## ? ?????? ??? ??????

### ? ???? ?????? (???? sessionStorage):
```
? Page Load
  ? init() ?
    ? checkForUpdates() ?
  
? Navigate to /products
  ? init() ? (AGAIN!)
    ? checkForUpdates() ? (AGAIN!)
      ? ? RELOAD! (if version mismatch)
  
? Navigate to /categories
  ? init() ? (AGAIN!)
    ? checkForUpdates() ? (AGAIN!)
      ? ? RELOAD! (AGAIN!)
  
? ? INFINITE LOOP!
```

### ? ???? ?????? (?? sessionStorage):
```
? Page Load
  ? init() ?
    ? sessionStorage.setItem('initialized', 'true')
    ? checkForUpdates() ?
  
? Navigate to /products
  ? init() ?
    ? Check sessionStorage: 'true' ?
    ? ? STOP! (no checkForUpdates)
  
? Navigate to /categories
  ? init() ?
    ? Check sessionStorage: 'true' ?
    ? ? STOP! (no checkForUpdates)
  
? ? NO RELOAD! ?
```

---

## ?? ??????? ????????

### ??????? ????????:
1. ? **Reload ??? ?? ????** - ? ?????
2. ? **init() ???? ??? ????** - ? ?????
3. ? **checkForUpdates() ??? ?? navigation** - ? ?????
4. ? **sessionStorage ????? ???????** - ? ????
5. ? **??? sessionStorage ??? reload** - ? ????

### ???????:
- ? **?? reload ??? navigation**
- ? **init() ???? ??? ????? ??? ?? ?? session**
- ? **checkForUpdates() ???? ???:**
  - ??? ??? ?????
  - ?? 5 ????? (periodic check)
  - ??? ?????? ??????? ??? 5 ?????
- ? **???? ?????**
- ? **????? ?????? ????**

---

## ? ??????? ??????? (????????):

1. `src/Presentation/Dashboard/wwwroot/js/version-manager.js` - ? Updated

### ????????? ????????:
```javascript
// ? NEW:
const INITIALIZED_KEY = 'version_manager_initialized';

// ? NEW:
_hasInitialized: false,

// ? NEW in init():
if (this._hasInitialized || sessionStorage.getItem(INITIALIZED_KEY)) {
    return;
}
sessionStorage.setItem(INITIALIZED_KEY, 'true');

// ? NEW in reloadApp():
sessionStorage.removeItem(INITIALIZED_KEY);
```

---

**? ???? ??????? ?????? ?????!**

**? Build Successful!**

**? No More Reload on Navigation!**

**? Perfect Performance!**

