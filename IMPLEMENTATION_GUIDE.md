# ???? ????? ????????? | Implementation Guide

---

## ?? ??????? ??????? | Quick Start

### ?????? 1: ????? Migration

```bash
# ?? ???? ??????? ???????
cd src\Infrastructure\DAL

# ????? ??? Migration
dotnet ef database update -s "../../Presentation/Api"
```

?? ??? ??? ?????? Package Manager Console ?? Visual Studio:

```powershell
Update-Database -Migration OptimizeItemSearchPerformance
```

### ?????? 2: ?????? ?? ??? Indexes

```sql
-- ?? SQL Server Management Studio (SSMS)
USE [YourDatabaseName]

-- ??? ???? ??? Indexes ??? ???? TbItems
SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('TbItems')

-- ??? ?? ???:
-- IX_TbItems_TitleAr
-- IX_TbItems_TitleEn
-- IX_TbItems_CategoryId_MinPrice
-- IX_TbItems_MinimumPrice
-- IX_TbItems_MaximumPrice
-- IX_TbItems_Price_CreatedDate
-- IX_TbItems_CreatedDateUtc_Desc
-- IX_TbItems_BrandId
```

### ?????? 3: ?????? ??? Stored Procedures

```sql
-- ?????? sp_SearchItemsAdvanced
EXEC sp_SearchItemsAdvanced
    @SearchTerm = 'test',
    @PageNumber = 1,
    @PageSize = 20

-- ?????? sp_SearchItemsFullText
EXEC sp_SearchItemsFullText
    @SearchTerm = 'test',
    @PageNumber = 1,
    @PageSize = 20
```

### ?????? 4: ????? ???? ??????? ?????????

```bash
# ???? ???????
dotnet build

# ????? ??????????
dotnet test

# ????? ???????
dotnet run
```

---

## ?? ????? ?????? ???????

### ??? ?????:
- [ ] Backup ????? ????????
- [ ] ?????? ?? ???? ???????
- [ ] ?????? Migration ?????
- [ ] ?????? ?? ????????? ?? SQL Server

### ????? ???????:
- [ ] ????? Migration
- [ ] ??? ???? ?????
- [ ] ?????? ?? ??? Indexes
- [ ] ?????? ?? ??? Stored Procedures

### ??? ???????:
- [ ] ???? ??????
- [ ] ?????? ?? ?????? ??????
- [ ] ?????? ??? Errors
- [ ] ????? ???????

---

## ?? ?????? ?????? | Performance Testing

### ??? ?????????:

```csharp
// ??? ??? ???????
using System.Diagnostics;

var stopwatch = Stopwatch.StartNew();
var result = await _itemService.GetPageWithFiltersAsync(new ItemFilterDto
{
    SearchTerm = "laptop",
    CategoryIds = new List<Guid> { /* ... */ },
    PageNumber = 1,
    PageSize = 20
});
stopwatch.Stop();

Console.WriteLine($"Time before optimization: {stopwatch.ElapsedMilliseconds}ms");
```

### ??? ?????????:

```csharp
// ???? ???????
// ??? ?? ???? ???? 3-5x

var stopwatch = Stopwatch.StartNew();
var result = await _itemService.GetPageWithFiltersAsync(new ItemFilterDto
{
    SearchTerm = "laptop",
    CategoryIds = new List<Guid> { /* ... */ },
    PageNumber = 1,
    PageSize = 20
});
stopwatch.Stop();

Console.WriteLine($"Time after optimization: {stopwatch.ElapsedMilliseconds}ms");
// Expected: ~2000-2500ms (down from ~8000ms)
```

---

## ?? ??????? ?? ???????? ??????? ?? VwItem

### ??? ??? ?????? SQL View:

```sql
-- ????? ??? View SQL ?????? ?????? ???????
CREATE OR ALTER VIEW VwItem AS
SELECT 
    i.Id,
    i.TitleAr,
    i.TitleEn,
    -- ... ?????? ????????
    
    -- ?????? ???????
    i.BrandId,
    b.NameAr AS BrandNameAr,
    b.NameEn AS BrandNameEn,
    
    -- ?????????
    ISNULL(AVG(r.Rating), 0) AS ItemAverageRating,
    COUNT(r.Id) AS ItemRatingCount,
    
    -- ?????? ?????? (?? ??? Offer ???????)
    o.UserId AS VendorId,
    u.StoreName AS VendorName,
    -- ... ???
FROM TbItems i
LEFT JOIN TbBrand b ON i.BrandId = b.Id
LEFT JOIN TbProductReview r ON i.Id = r.ItemId
LEFT JOIN TbOffers o ON i.Id = o.ItemId AND o.IsDefault = 1
LEFT JOIN AspNetUsers u ON o.UserId = u.Id
```

### ??? ??? ?????? Entity ??????:

???? ?? ?? `VwItem` Entity ????? ??? ???? ?????? ??????? (????? ?????? ?? ?????).

---

## ?? ??????? ???????

### ?????: Migration ????

```
Error: The statement EXEC sp_... is not allowed within a function or trigger
```

**????:**
- ???? ?? ??? ???? ???????? ??????? ?? ??? SQLs
- ???? ?? ??? Permissions
- ???? ????? ???????? ??????? ?? ??? SQL

### ?????: Indexes ?? ?????

```
Error: The specified index does not exist
```

**????:**
```sql
-- ???? ?? ???? ??? Indexes
SELECT name FROM sys.indexes WHERE object_id = OBJECT_ID('TbItems')

-- ??? ?? ????? ?????? ??????
CREATE INDEX IX_TbItems_TitleAr ON TbItems(TitleAr)
CREATE INDEX IX_TbItems_TitleEn ON TbItems(TitleEn)
-- ... ???
```

### ?????: Stored Procedure ??? ?????

```
Error: Could not find stored procedure 'sp_SearchItemsAdvanced'
```

**????:**
```sql
-- ???? ?? ???? ??? Stored Procedures
SELECT * FROM sys.procedures WHERE name LIKE 'sp_Search%'

-- ??? ?? ????? ?????? ?????? (???? ??? ??? Migration)
```

### ?????: ?????? ?? ?????

**??????:**
1. ???? ?? ??? Indexes:
```sql
SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('TbItems')
```

2. ???? ?? ??????? ??? Indexes:
```sql
SELECT * FROM sys.dm_db_index_usage_stats 
WHERE database_id = DB_ID() AND object_id = OBJECT_ID('TbItems')
```

3. ?? ?? rebuild ??? Indexes:
```sql
ALTER INDEX ALL ON TbItems REBUILD
```

---

## ?? ?????? ??????

### ??????? SQL Server Profiler:

1. ???? SQL Server Management Studio
2. ???? ???: Tools ? SQL Server Profiler
3. ???? trace ????
4. ?? ?????? ?? ???????
5. ???? ??? ??? ??????? ???? I/O

### ??????? Query Execution Plans:

```sql
-- ?? SSMS
SET STATISTICS IO ON
SET STATISTICS TIME ON

EXEC sp_SearchItemsAdvanced
    @SearchTerm = 'laptop',
    @PageNumber = 1,
    @PageSize = 20

SET STATISTICS IO OFF
SET STATISTICS TIME OFF
```

### Logging ?? ???????:

```csharp
// ??? logging ??????
_logger.Information(
    "Search took {ElapsedMs}ms for {ResultCount} items",
    stopwatch.ElapsedMilliseconds,
    result.TotalRecords
);
```

---

## ?? ?????? ????????

### ????? ??????????:

```sql
-- ?? ???? ???? ???? (????? ????????)
EXEC sp_updatestats

-- ?? ????? ???????? ?????
UPDATE STATISTICS TbItems
UPDATE STATISTICS TbItems IX_TbItems_TitleAr
```

### ????? ????? ??? Indexes:

```sql
-- ??????
ALTER INDEX ALL ON TbItems REBUILD

-- ?? ??? ??? ??? fragmentation ???? ?? 30%
ALTER INDEX ALL ON TbItems REORGANIZE
```

### ?????? ??? Fragmentation:

```sql
SELECT 
    OBJECT_NAME(ps.object_id) AS TableName,
    i.name AS IndexName,
    ps.avg_fragmentation_in_percent
FROM sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL, NULL, 'LIMITED') ps
INNER JOIN sys.indexes i ON ps.object_id = i.object_id AND ps.index_id = i.index_id
WHERE ps.avg_fragmentation_in_percent > 10
    AND ps.page_count > 1000
```

---

## ?? Rollback (?? ???? ??????)

### ????? Migration:

```bash
# ????? ??? migration
dotnet ef database update -s "../../Presentation/Api" --no-build

# ?? ????? ????? ????
Update-Database -Migration [PreviousMigrationName]
```

### ??? ??? Indexes ??????:

```sql
DROP INDEX IF EXISTS IX_TbItems_TitleAr ON TbItems
DROP INDEX IF EXISTS IX_TbItems_TitleEn ON TbItems
DROP INDEX IF EXISTS IX_TbItems_CategoryId_MinPrice ON TbItems
DROP INDEX IF EXISTS IX_TbItems_MinimumPrice ON TbItems
DROP INDEX IF EXISTS IX_TbItems_MaximumPrice ON TbItems
DROP INDEX IF EXISTS IX_TbItems_Price_CreatedDate ON TbItems
DROP INDEX IF EXISTS IX_TbItems_CreatedDateUtc_Desc ON TbItems
DROP INDEX IF EXISTS IX_TbItems_BrandId ON TbItems
```

### ??? ??? Stored Procedures:

```sql
DROP PROCEDURE IF EXISTS sp_SearchItemsAdvanced
DROP PROCEDURE IF EXISTS sp_SearchItemsFullText
```

---

## ?? ????? ?????

### ??? ????? ?????:

1. **???? ?? ??? Build:**
   ```bash
   dotnet build
   ```

2. **???? ?? ??? Logs:**
   - ???? ??? Application Logs
   - ???? ??? Database Logs

3. **?????? Query Analyzer:**
   - SQL Server Management Studio
   - Redgate SQL Prompt
   - SolarWinds DPA

4. **???? ????????:**
   - ???? ??? PERFORMANCE_AND_FILTERS_ANALYSIS.md
   - ???? ??? IMPLEMENTATION_REPORT_PHASE_1.md
   - ???? ??????? ??????????

---

## ? ????? ????????

### ??? ??????? ??????:
- [ ] Migration ????? ???? ?????
- [ ] Indexes ?????? ?????
- [ ] Stored Procedures ?????? ?????
- [ ] ?????? ????? 3-5x
- [ ] ?? ???? Errors ?? ??? Logs
- [ ] ??????? ??????? ???? ???? ????
- [ ] ??????? ???? ???? ????
- [ ] ??? Pagination ???? ???? ????

---

## ?? ??????? ???????

### EF Core Documentation:
- https://docs.microsoft.com/en-us/ef/core/
- https://docs.microsoft.com/en-us/ef/core/querying/

### SQL Server Performance:
- https://docs.microsoft.com/en-us/sql/relational-databases/indexes/
- https://docs.microsoft.com/en-us/sql/t-sql/statements/

### Best Practices:
- https://github.com/AspNetBoilerplate/aspnetboilerplate
- https://docs.microsoft.com/en-us/dotnet/architecture/

---

## ?? ?????? ???????

??? ??????? ??????:
- ????? ?????? ???? ????
- ??? ???????
- ??? ??????? 2 (Full-Text Search? Compiled Queries? Caching)
- ??? ?????? ?????? ????????
