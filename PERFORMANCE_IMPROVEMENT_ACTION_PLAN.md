# ??? ????? ????? ?????? | Performance Improvement Implementation Plan

---

## ?? ??????? 1: ????? Database Indexes
### Priority: ?? ???? ???? | Critical

#### ??? Migration ????:
```sql
-- File: [Migration]_AddIndexesForItemSearch.cs

ALTER TABLE VwItem ADD INDEX IF NOT EXISTS IX_VwItem_TitleAr (TitleAr);
ALTER TABLE VwItem ADD INDEX IF NOT EXISTS IX_VwItem_TitleEn (TitleEn);
ALTER TABLE VwItem ADD INDEX IF NOT EXISTS IX_VwItem_CategoryId (CategoryId);
ALTER TABLE VwItem ADD INDEX IF NOT EXISTS IX_VwItem_MinPrice (MinimumPrice);
ALTER TABLE VwItem ADD INDEX IF NOT EXISTS IX_VwItem_MaxPrice (MaximumPrice);
ALTER TABLE VwItem ADD INDEX IF NOT EXISTS IX_VwItem_CreatedDate (CreatedDateUtc DESC);

-- Composite Indexes
ALTER TABLE VwItem ADD INDEX IF NOT EXISTS IX_VwItem_Category_MinPrice (CategoryId, MinimumPrice);
ALTER TABLE VwItem ADD INDEX IF NOT EXISTS IX_VwItem_Price_CreatedDate (MinimumPrice, CreatedDateUtc DESC);

-- ??????? ??????? (??? ???? VwItem view)
CREATE INDEX IF NOT EXISTS IX_TbItem_Title_Ar ON TbItems(TitleAr);
CREATE INDEX IF NOT EXISTS IX_TbItem_Title_En ON TbItems(TitleEn);
CREATE INDEX IF NOT EXISTS IX_TbItem_Category ON TbItems(CategoryId);
CREATE INDEX IF NOT EXISTS IX_TbItem_CreatedDate ON TbItems(CreatedDateUtc DESC);
```

---

## ?? ??????? 2: ????? ItemService ???? ToLower()
### Priority: ?? ???? | High

```csharp
// ??????? ?????? GetPageWithFiltersAsync ??????? ?? ???:

public async Task<PaginatedDataModel<VwItemDto>> GetPageWithFiltersAsync(ItemFilterDto filterDto)
{
    if (filterDto == null)
        throw new ArgumentNullException(nameof(filterDto));

    if (filterDto.PageNumber < 1)
        throw new ArgumentOutOfRangeException(nameof(filterDto.PageNumber));

    if (filterDto.PageSize < 1 || filterDto.PageSize > 100)
        throw new ArgumentOutOfRangeException(nameof(filterDto.PageSize));

    // Base query - ? ???? ToLower() 
    IQueryable<VwItem> query = _repository.GetQueryable(); // ????? ??? ??????

    // ????? - ???? ToLower()
    var searchTerm = filterDto.SearchTerm?.Trim();
    if (!string.IsNullOrWhiteSpace(searchTerm))
    {
        query = query.Where(x =>
            EF.Functions.Like(x.TitleAr, $"%{searchTerm}%") ||
            EF.Functions.Like(x.TitleEn, $"%{searchTerm}%") ||
            EF.Functions.Like(x.ShortDescriptionAr, $"%{searchTerm}%") ||
            EF.Functions.Like(x.ShortDescriptionEn, $"%{searchTerm}%")
        );
    }

    // ??????
    if (filterDto.CategoryIds?.Any() == true)
    {
        query = query.Where(x => filterDto.CategoryIds.Contains(x.CategoryId));
    }

    // ????? ??????
    if (filterDto.MinPrice.HasValue)
    {
        query = query.Where(x => x.MinimumPrice >= filterDto.MinPrice.Value);
    }

    // ????? ??????
    if (filterDto.MaxPrice.HasValue)
    {
        query = query.Where(x => x.MaximumPrice <= filterDto.MaxPrice.Value);
    }

    // ???????
    IOrderedQueryable<VwItem> orderedQuery = filterDto.SortBy?.ToLower() switch
    {
        "price_asc" => query.OrderBy(x => x.MinimumPrice),
        "price_desc" => query.OrderByDescending(x => x.MaximumPrice),
        "newest" => query.OrderByDescending(x => x.CreatedDateUtc),
        _ => query.OrderByDescending(x => x.CreatedDateUtc)
    };

    // ??? ??????? ???????? (??? ??? Pagination)
    var totalRecords = await orderedQuery.CountAsync();

    // Pagination - ??????? AsNoTracking() ??????
    var items = await orderedQuery
        .AsNoTracking()
        .Skip((filterDto.PageNumber - 1) * filterDto.PageSize)
        .Take(filterDto.PageSize)
        .ToListAsync();

    var itemsDto = _mapper.MapList<VwItem, VwItemDto>(items);

    return new PaginatedDataModel<VwItemDto>(itemsDto, totalRecords);
}
```

---

## ?? ??????? 3: ????? IRepository ?????? ??? Queryable
### Priority: ?? ????? | Medium

```csharp
// ????? method ??? IRepository

public interface IRepository<T> where T : class
{
    // Methods ????????...
    
    // ?????? ??????? ????????
    IQueryable<T> GetQueryable();
}

// ??????? ?? Repository:

public class Repository<T> : IRepository<T> where T : class
{
    private readonly ApplicationDbContext _context;
    
    public IQueryable<T> GetQueryable()
    {
        return _context.Set<T>();
    }
}
```

---

## ?? ??????? 4: ????? VwItem ?? ???????? ???????
### Priority: ?? ???? ???? | Critical

```csharp
// ???: src\Core\Domains\Views\Item\VwItem.cs

namespace Domains.Views.Item
{
    public class VwItem
    {
        // ? ???????? ???????? ??????
        public Guid Id { get; set; }
        public string TitleAr { get; set; }
        public string TitleEn { get; set; }
        public string ShortDescriptionAr { get; set; }
        public string ShortDescriptionEn { get; set; }
        public string DescriptionAr { get; set; }
        public string DescriptionEn { get; set; }
        public Guid CategoryId { get; set; }
        public string CategoryTitleAr { get; set; }
        public string CategoryTitleEn { get; set; }
        public Guid UnitId { get; set; }
        public string UnitTitleAr { get; set; }
        public string UnitTitleEn { get; set; }
        public string ThumbnailImage { get; set; }
        public decimal? MinimumPrice { get; set; }
        public decimal? MaximumPrice { get; set; }
        public string Barcode { get; set; } = string.Empty;
        public string SKU { get; set; } = string.Empty;
        public DateTime CreatedDateUtc { get; set; }
        public Guid? VideoProviderId { get; set; }
        public string? VideoProviderTitleAr { get; set; }
        public string? VideoProviderTitleEn { get; set; }
        public string? VideoLink { get; set; }
        public bool IsNewArrival { get; set; }
        public Guid? ByBoxOfferId { get; set; }
        public Guid? ByBoxUserId { get; set; }
        public string? ItemImagesJson { get; set; }
        public string? CombinationsJson { get; set; }

        // ? ? ? ???????? ??????? ???????
        
        // ???????
        public Guid? BrandId { get; set; }
        public string BrandNameAr { get; set; }
        public string BrandNameEn { get; set; }

        // ???????
        public decimal ItemAverageRating { get; set; } = 0;    // ????? ????? ?????? (0-5)
        public int ItemRatingCount { get; set; } = 0;          // ??? ?????????

        // ?????? ????? (Offer) - ?????? ??????
        public Guid VendorId { get; set; }                     // ID ??????
        public string VendorNameAr { get; set; }
        public string VendorNameEn { get; set; }
        public decimal VendorAverageRating { get; set; } = 0;  // ????? ????? ??????
        public bool IsVerifiedVendor { get; set; } = false;    // ?? ?????? ?????
        public bool IsPrimeVendor { get; set; } = false;       // ?? ?????? ????

        // ????? ???????
        public decimal OfferPrice { get; set; }                // ??? ????? ??????
        public decimal? OfferOriginalPrice { get; set; }       // ????? ?????? ??? ???????
        public bool IsOnSale { get; set; } = false;            // ?? ????? ??? ???
        public decimal DiscountPercentage { get; set; } = 0;   // ???? ???????

        // ?????? ????????
        public bool IsInStock { get; set; } = true;            // ?? ?????? ?? ??????
        public int AvailableQuantity { get; set; } = 0;        // ?????? ???????
        public StorgeLocation StorgeLocation { get; set; }     // ???? ???????

        // ?????
        public bool IsFreeShipping { get; set; } = false;      // ?? ????? ?????
        public decimal ShippingCost { get; set; } = 0;         // ????? ?????
        public int EstimatedDeliveryDays { get; set; } = 0;    // ???? ??????? ????????
        public int MaxDeliveryDays { get; set; } = 30;         // ???? ???? ???????

        // ?????? ???????
        public Guid? OfferConditionId { get; set; }            // ID ???? ??????
        public string ConditionNameAr { get; set; }            // ??? ?????? ????
        public string ConditionNameEn { get; set; }            // ??? ?????? ???????
        public bool HasWarranty { get; set; } = false;         // ?? ???? ????
        public int WarrantyMonths { get; set; } = 0;           // ??? ?????? ???????

        // Buy Box Winner
        public bool IsBuyBoxWinner { get; set; } = false;      // ?? ?? ?????? ?? Buy Box

        // ??????? ????????
        public int TotalSalesCount { get; set; } = 0;          // ??? ????????
        public decimal TotalRevenue { get; set; } = 0;         // ?????? ?????????
    }
}
```

---

## ?? ??????? 5: ????? Full-Text Search
### Priority: ?? ???? ???? | Critical

### ???? 1: ????? Migration ?? Full-Text Index

```csharp
// ???: [Migration]_AddFullTextSearchIndex.cs

public partial class AddFullTextSearchIndex : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        // ????? Full-Text Index
        migrationBuilder.Sql(
            @"CREATE FULLTEXT CATALOG ft_ItemCatalog;

              CREATE FULLTEXT INDEX ON TbItems 
              (
                  TitleAr,
                  TitleEn,
                  ShortDescriptionAr,
                  ShortDescriptionEn
              )
              KEY INDEX PK_TbItems
              ON ft_ItemCatalog;"
        );
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.Sql(
            @"DROP FULLTEXT INDEX ON TbItems;
              DROP FULLTEXT CATALOG ft_ItemCatalog;"
        );
    }
}
```

### ???? 2: ??????? Full-Text Search ?? ??? Query

```csharp
public async Task<PaginatedDataModel<VwItemDto>> GetPageWithFiltersAsync(ItemFilterDto filterDto)
{
    // ... ????? ??????
    
    // ????? - ??????? Full-Text Search
    var searchTerm = filterDto.SearchTerm?.Trim();
    if (!string.IsNullOrWhiteSpace(searchTerm))
    {
        // ????? 1: CONTAINS (Full-Text)
        // ???? ?? 10-50x ?? LIKE
        query = query.Where(x =>
            EF.Functions.Contains(x.TitleAr, searchTerm) ||
            EF.Functions.Contains(x.TitleEn, searchTerm) ||
            EF.Functions.Contains(x.ShortDescriptionAr, searchTerm) ||
            EF.Functions.Contains(x.ShortDescriptionEn, searchTerm)
        );
    }
    
    // ... ???? ?????
}
```

---

## ?? ??????? 6: ????? ?? ??????? ????????
### Priority: ?? ????? | Medium

```csharp
public async Task<PaginatedDataModel<VwItemDto>> GetPageWithFiltersAsync(ItemFilterDto filterDto)
{
    // ... ??????? ???????? (Search, Category, Price)
    
    // ? ????? ?????:
    
    // 1?? ???????
    if (filterDto.BrandIds?.Any() == true)
    {
        query = query.Where(x => filterDto.BrandIds.Contains(x.BrandId.Value));
    }

    // 2?? ????? ??????
    if (filterDto.MinItemRating.HasValue)
    {
        query = query.Where(x => x.ItemAverageRating >= filterDto.MinItemRating.Value);
    }

    // 3?? ????? ??????
    if (filterDto.MinVendorRating.HasValue)
    {
        query = query.Where(x => x.VendorAverageRating >= filterDto.MinVendorRating.Value);
    }

    // 4?? ??????
    if (filterDto.InStockOnly == true)
    {
        query = query.Where(x => x.IsInStock && x.AvailableQuantity > 0);
    }

    // 5?? ???? ?????? ??????
    if (filterDto.MinAvailableQuantity.HasValue)
    {
        query = query.Where(x => x.AvailableQuantity >= filterDto.MinAvailableQuantity.Value);
    }

    // 6?? ????? ??????? ???
    if (filterDto.FreeShippingOnly == true)
    {
        query = query.Where(x => x.IsFreeShipping);
    }

    // 7?? ???? ???????
    if (filterDto.MaxDeliveryDays.HasValue)
    {
        query = query.Where(x => x.EstimatedDeliveryDays <= filterDto.MaxDeliveryDays.Value);
    }

    // 8?? ????? ???????
    if (filterDto.StorageLocations?.Any() == true)
    {
        query = query.Where(x => filterDto.StorageLocations.Contains(x.StorgeLocation));
    }

    // 9?? ???????? ????????
    if (filterDto.VendorIds?.Any() == true)
    {
        query = query.Where(x => filterDto.VendorIds.Contains(x.VendorId.ToString()));
    }

    // ?? ???????? ?????????
    if (filterDto.VerifiedVendorsOnly == true)
    {
        query = query.Where(x => x.IsVerifiedVendor);
    }

    // 1??1?? ???????? ????????
    if (filterDto.PrimeVendorsOnly == true)
    {
        query = query.Where(x => x.IsPrimeVendor);
    }

    // 1??2?? ???????? ?? ????? ???
    if (filterDto.OnSaleOnly == true)
    {
        query = query.Where(x => x.IsOnSale);
    }

    // 1??3?? ???????? ?? Buy Box
    if (filterDto.BuyBoxWinnersOnly == true)
    {
        query = query.Where(x => x.IsBuyBoxWinner);
    }

    // 1??4?? ???? ??????
    if (filterDto.ConditionIds?.Any() == true)
    {
        query = query.Where(x => filterDto.ConditionIds.Contains(x.OfferConditionId.Value));
    }

    // 1??5?? ?? ?????? ???
    if (filterDto.WithWarrantyOnly == true)
    {
        query = query.Where(x => x.HasWarranty);
    }

    // ... ??????? ???? Pagination
}
```

---

## ?? ??????? 7: ????? Compiled Queries
### Priority: ?? ????? | Medium

```csharp
// ???: src\Core\BL\Service\ECommerce\Item\CompiledItemQueries.cs

public static class CompiledItemQueries
{
    public static readonly Func<ApplicationDbContext, string, IAsyncEnumerable<VwItem>>
        SearchByTitle = EF.CompileAsyncQuery(
            (ApplicationDbContext ctx, string searchTerm) =>
                ctx.VwItems.Where(x =>
                    EF.Functions.Like(x.TitleAr, $"%{searchTerm}%") ||
                    EF.Functions.Like(x.TitleEn, $"%{searchTerm}%")
                )
        );

    public static readonly Func<ApplicationDbContext, Guid, IAsyncEnumerable<VwItem>>
        GetByCategory = EF.CompileAsyncQuery(
            (ApplicationDbContext ctx, Guid categoryId) =>
                ctx.VwItems.Where(x => x.CategoryId == categoryId)
        );

    public static readonly Func<ApplicationDbContext, decimal, decimal, IAsyncEnumerable<VwItem>>
        GetByPriceRange = EF.CompileAsyncQuery(
            (ApplicationDbContext ctx, decimal minPrice, decimal maxPrice) =>
                ctx.VwItems.Where(x =>
                    x.MinimumPrice >= minPrice && x.MaximumPrice <= maxPrice
                )
        );
}
```

---

## ?? ??????? 8: ????? Caching
### Priority: ?? ????? | Low (???????)

```csharp
[HttpPost("search/advanced")]
[AllowAnonymous]
public async Task<IActionResult> SearchWithFilters([FromBody] ItemFilterDto filter)
{
    if (filter == null)
        return BadRequest(CreateErrorResponse(NotifiAndAlertsResources.InvalidInputAlert));

    ValidateAndNormalizeItemFilter(filter);

    // ????? Cache Key
    var cacheKey = CreateCacheKey(filter);

    // ?????? ?? ??? Cache
    if (_memoryCache.TryGetValue(cacheKey, out PaginatedDataModel<VwItemDto> cachedResult))
    {
        return Ok(CreateSuccessResponse(cachedResult, "From Cache"));
    }

    // ?????? ??? ???????
    var result = await _itemService.GetPageWithFiltersAsync(filter);

    // ??? ?? ??? Cache ?? 5 ?????
    var cacheOptions = new MemoryCacheEntryOptions
    {
        AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(5),
        SlidingExpiration = TimeSpan.FromMinutes(1)
    };

    _memoryCache.Set(cacheKey, result, cacheOptions);

    return Ok(CreateSuccessResponse(result, NotifiAndAlertsResources.DataRetrieved));
}

private string CreateCacheKey(ItemFilterDto filter)
{
    var key = new StringBuilder("search_");
    key.Append(filter.SearchTerm ?? "");
    key.Append("_");
    key.Append(string.Join("-", filter.CategoryIds ?? new List<Guid>()));
    key.Append("_");
    key.Append(filter.MinPrice?.ToString() ?? "");
    key.Append("_");
    key.Append(filter.MaxPrice?.ToString() ?? "");
    key.Append("_");
    key.Append(filter.PageNumber);
    key.Append("_");
    key.Append(filter.SortBy ?? "");
    
    return key.ToString();
}
```

---

## ?? ???? ????????? | Summary

| # | ??????? | ???????? | ????? | ??????? | ??????? |
|---|--------|--------|-----|--------|---------|
| 1 | Database Indexes | ?? ???? | 30 ????? | 3-5x | ????? |
| 2 | ????? ToLower() | ?? ???? | 1 ???? | 2x | ????? |
| 3 | IRepository.GetQueryable() | ?? ????? | 30 ????? | ????? | ????? |
| 4 | ????? VwItem | ?? ???? | 2 ???? | 50% | ????? |
| 5 | Full-Text Search | ?? ???? | 2 ???? | 10-20x | ??? ???? |
| 6 | ????? ??????? | ?? ????? | 4 ????? | 100% | ??? |
| 7 | Compiled Queries | ?? ????? | 2 ???? | 1-2x | ??????? |
| 8 | Caching | ?? ????? | 1 ???? | 5-10x | ??????? |

**????? ?????:** 12-14 ???? (??? ???? ?? ?????)
**??????? ??????:** 20-50x ???? ?? ??????

---

## ? ????? ??????? | Implementation Steps

### ??? 1
- [ ] ????? ??????? 1 (Indexes)
- [ ] ????? ??????? 2 (????? ToLower)
- [ ] ????? ??????? 3 (GetQueryable)
- [ ] Testing ??????? ?? ??????

### ??? 2
- [ ] ????? ??????? 4 (????? VwItem)
- [ ] ????? ??????? 5 (Full-Text Search)
- [ ] ????? ??????? 6 (??????? ????????)
- [ ] Testing ??????

### ??? 3 (???????)
- [ ] ????? ??????? 7 (Compiled Queries)
- [ ] ????? ??????? 8 (Caching)
- [ ] Load Testing
- [ ] Documentation

---

## ?? ?????? ?????????

### ??? ????
```csharp
var stopwatch = Stopwatch.StartNew();
var result = await _itemService.GetPageWithFiltersAsync(filter);
stopwatch.Stop();

_logger.Information(
    "Search completed in {ElapsedMilliseconds}ms, " +
    "Found {TotalRecords} items",
    stopwatch.ElapsedMilliseconds,
    result.TotalRecords
);
```

### KPIs ????????
- ?? ????? ??? ?????????
- ?? ??? ??????????? ?? ??????? (Throughput)
- ?? ??????? ???????
- ?? ???? ?????
