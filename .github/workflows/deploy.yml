name: üöÄ CI/CD - Build, Test, Migrate & Deploy to IIS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: Build and Test
  # ============================================
  build-and-test:
    name: üß™ Build & Test
    runs-on: [self-hosted, windows, iis]
    
    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2Ô∏è‚É£ Setup .NET
      - name: Setup .NET
        run: echo "Using preinstalled .NET SDK on server"
      
      # 3Ô∏è‚É£ Restore dependencies
      - name: Restore dependencies
        run: |
          Write-Host "=========================================="
          Write-Host "Restoring NuGet packages..."
          Write-Host "=========================================="
          Write-Host "Current directory: $PWD"
          dotnet restore "$env:GITHUB_WORKSPACE\Sahl.slnx"
      
      # 4Ô∏è‚É£ Build solution
      - name: Build Solution
        run: |
          Write-Host "=========================================="
          Write-Host "Building solution in Release mode..."
          Write-Host "=========================================="
          dotnet build "$env:GITHUB_WORKSPACE\Sahl.slnx" -c Release --no-restore
      
      # 5Ô∏è‚É£ Run Unit Tests
      - name: Run Unit Tests
        run: |
          Write-Host "=========================================="
          Write-Host "Running Unit Tests..."
          Write-Host "=========================================="
          dotnet test "$env:GITHUB_WORKSPACE\tests\UnitTests\UnitTests.csproj" `
            --configuration Release `
            --no-build `
            --verbosity normal `
            --logger "trx;LogFileName=unit-test-results.trx" `
            --logger "console;verbosity=detailed" `
            --collect:"XPlat Code Coverage" `
            --results-directory "$env:TEMP\TestResults\Unit"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Unit tests failed!" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Unit tests passed!" -ForegroundColor Green
      
      # 6Ô∏è‚É£ Run Integration Tests
      - name: Run Integration Tests
        run: |
          Write-Host "=========================================="
          Write-Host "Running Integration Tests..."
          Write-Host "=========================================="
          dotnet test "$env:GITHUB_WORKSPACE\tests\IntegrationTests\IntegrationTests.csproj" `
            --configuration Release `
            --no-build `
            --verbosity normal `
            --logger "trx;LogFileName=integration-test-results.trx" `
            --logger "console;verbosity=detailed" `
            --collect:"XPlat Code Coverage" `
            --results-directory "$env:TEMP\TestResults\Integration"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Integration tests failed!" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Integration tests passed!" -ForegroundColor Green
      
      # 7Ô∏è‚É£ Test Summary
      - name: Test Summary
        if: always()
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "           TEST SUMMARY" -ForegroundColor Cyan
          Write-Host "=========================================="
          
          # Parse Unit Test Results
          if (Test-Path "$env:TEMP\TestResults\Unit\unit-test-results.trx") {
            [xml]$unitResults = Get-Content "$env:TEMP\TestResults\Unit\unit-test-results.trx"
            $unitTotal = $unitResults.TestRun.ResultSummary.Counters.total
            $unitPassed = $unitResults.TestRun.ResultSummary.Counters.passed
            $unitFailed = $unitResults.TestRun.ResultSummary.Counters.failed
            
            Write-Host "Unit Tests:" -ForegroundColor White
            Write-Host "  Total:  $unitTotal" -ForegroundColor White
            Write-Host "  Passed: $unitPassed" -ForegroundColor Green
            Write-Host "  Failed: $unitFailed" -ForegroundColor $(if ($unitFailed -gt 0) { "Red" } else { "Green" })
          }
          
          # Parse Integration Test Results
          if (Test-Path "$env:TEMP\TestResults\Integration\integration-test-results.trx") {
            [xml]$integrationResults = Get-Content "$env:TEMP\TestResults\Integration\integration-test-results.trx"
            $intTotal = $integrationResults.TestRun.ResultSummary.Counters.total
            $intPassed = $integrationResults.TestRun.ResultSummary.Counters.passed
            $intFailed = $integrationResults.TestRun.ResultSummary.Counters.failed
            
            Write-Host ""
            Write-Host "Integration Tests:" -ForegroundColor White
            Write-Host "  Total:  $intTotal" -ForegroundColor White
            Write-Host "  Passed: $intPassed" -ForegroundColor Green
            Write-Host "  Failed: $intFailed" -ForegroundColor $(if ($intFailed -gt 0) { "Red" } else { "Green" })
          }
          
          Write-Host "=========================================="
      
      # 8Ô∏è‚É£ Upload test results as artifacts
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            ${{ runner.temp }}/TestResults/**/*.trx
            ${{ runner.temp }}/TestResults/**/coverage.cobertura.xml
          retention-days: 30

  # ============================================
  # Job 2: Deploy to IIS (only on main branch)
  # ============================================
  deploy:
    name: üöÄ Deploy to IIS
    runs-on: [self-hosted, windows, iis]
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2Ô∏è‚É£ Setup .NET
      - name: Setup .NET
        run: echo "Using preinstalled .NET SDK on server"
      
      # 3Ô∏è‚É£ Restore dependencies
      - name: Restore dependencies
        run: dotnet restore "$env:GITHUB_WORKSPACE\Sahl.slnx"
      
      # 4Ô∏è‚É£ Cache .NET workloads
      - name: Cache .NET workloads
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\.dotnet\workloads
          key: dotnet-workloads-${{ runner.os }}-10.0.100
      
      # 5Ô∏è‚É£ Verify or Install Blazor Workload
      - name: Verify or Install Blazor Workload
        run: |
          Write-Host "Checking Blazor workloads..."
          $wasm = dotnet workload list | Select-String "wasm-tools"
          if (-not $wasm) {
            Write-Host "Installing wasm-tools workload..."
            dotnet workload install wasm-tools --ignore-failed-sources
          } else {
            Write-Host "wasm-tools workload already installed"
          }
          dotnet workload list
      
      # 6Ô∏è‚É£ Build Solution
      - name: Build Solution
        run: dotnet build "$env:GITHUB_WORKSPACE\Sahl.slnx" -c Release --no-restore
      
      # 7Ô∏è‚É£ Install EF Core Tools (for migrations)
      - name: Install EF Core Tools
        run: |
          Write-Host "=========================================="
          Write-Host "Installing/Updating EF Core Tools..."
          Write-Host "=========================================="
          dotnet tool install --global dotnet-ef --version 8.* 2>$null
          if ($LASTEXITCODE -ne 0) {
            dotnet tool update --global dotnet-ef --version 8.*
          }
          dotnet ef --version
      
      # 8Ô∏è‚É£ Backup Database (before migration)
      - name: Backup Database
        run: |
          Write-Host "=========================================="
          Write-Host "Creating Database Backup..."
          Write-Host "=========================================="
          
          $appsettingsPath = "C:\0ALI\WebSites\BasitApi\appsettings.json"
          if (Test-Path $appsettingsPath) {
            $appsettings = Get-Content $appsettingsPath | ConvertFrom-Json
            $connectionString = $appsettings.ConnectionStrings.DefaultConnection
            
            # ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÖŸÜ connection string
            if ($connectionString -match "Server=([^;]+)") { $serverName = $matches[1].Trim() }
            if ($connectionString -match "Database=([^;]+)") { $databaseName = $matches[1].Trim() }
            if ($connectionString -match "user id=([^;]+)") { $userId = $matches[1].Trim() }
            if ($connectionString -match "password=([^;]+)") { $password = $matches[1].Trim() }
            
            if ($serverName -and $databaseName -and $userId -and $password) {
              $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
              $backupPath = "C:\temp\db-backups\${databaseName}_${timestamp}.bak"
              
              if (!(Test-Path "C:\temp\db-backups")) {
                New-Item -ItemType Directory -Force -Path "C:\temp\db-backups" | Out-Null
              }
              
              Write-Host "Database: $databaseName"
              Write-Host "Server: $serverName"
              Write-Host "User: $userId"
              Write-Host "Backup Path: $backupPath"
              
              try {
                $backupQuery = "BACKUP DATABASE [$databaseName] TO DISK = N'$backupPath' WITH FORMAT, INIT, NAME = N'$databaseName-Backup', SKIP, NOREWIND, NOUNLOAD, COMPRESSION, STATS = 10"
                
                # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ SQL Server Authentication
                sqlcmd -S $serverName -U $userId -P $password -Q $backupQuery
                
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "‚úÖ Database backup created successfully!" -ForegroundColor Green
                  Write-Host "Backup saved to: $backupPath" -ForegroundColor Cyan
                  
                  # ÿ≠ŸÅÿ∏ ŸÖÿ≥ÿßÿ± ÿßŸÑŸÄ backup ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÅŸä ÿßŸÑŸÄ rollback
                  echo "DB_BACKUP_PATH=$backupPath" >> $env:GITHUB_ENV
                  echo "DB_SERVER=$serverName" >> $env:GITHUB_ENV
                  echo "DB_NAME=$databaseName" >> $env:GITHUB_ENV
                  echo "DB_USER=$userId" >> $env:GITHUB_ENV
                  echo "DB_PASSWORD=$password" >> $env:GITHUB_ENV
                } else {
                  Write-Host "‚ö†Ô∏è Warning: Database backup failed (Exit code: $LASTEXITCODE)" -ForegroundColor Yellow
                }
              } catch {
                Write-Host "‚ö†Ô∏è Warning: Could not create backup: $($_.Exception.Message)" -ForegroundColor Yellow
              }
              
              # ÿ≠ÿ∞ŸÅ ÿßŸÑŸÄ backups ÿßŸÑŸÇÿØŸäŸÖÿ© (ÿ£ŸÉÿ™ÿ± ŸÖŸÜ 7 ÿ£ŸäÿßŸÖ)
              Write-Host "Cleaning up old backups..."
              Get-ChildItem "C:\temp\db-backups\*.bak" | Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-7) } | Remove-Item -Force
              
            } else {
              Write-Host "‚ö†Ô∏è Could not parse connection string properly" -ForegroundColor Yellow
              Write-Host "Server: $serverName, Database: $databaseName, User: $userId" -ForegroundColor Yellow
            }
          } else {
            Write-Host "‚ö†Ô∏è appsettings.json not found at: $appsettingsPath" -ForegroundColor Yellow
          }

      # 9Ô∏è‚É£ Check for Pending Migrations
      - name: Check Pending Migrations
        id: check-migrations
        run: |
          Write-Host "=========================================="
          Write-Host "Checking for Pending Migrations..."
          Write-Host "=========================================="
          
          $appsettingsPath = "C:\0ALI\WebSites\BasitApi\appsettings.json"
          
          if (Test-Path $appsettingsPath) {
            $appsettings = Get-Content $appsettingsPath | ConvertFrom-Json
            $connectionString = $appsettings.ConnectionStrings.DefaultConnection
            
            Write-Host "Building projects for EF migrations check..."
            
            # ÿπŸÖŸÑ build ŸÑŸÑŸÄ DAL Ÿà Api projects ŸÅŸä Release mode
            dotnet build "$env:GITHUB_WORKSPACE\src\Infrastructure\DAL\DAL.csproj" -c Release --no-restore
            dotnet build "$env:GITHUB_WORKSPACE\src\Presentation\Api\Api.csproj" -c Release --no-restore
            
            Write-Host ""
            Write-Host "Running EF migrations list..."
            
            # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ EF ÿ®ÿØŸàŸÜ --no-build ÿ£Ÿà ŸÖÿπ --configuration Release
            $migrationsOutput = dotnet ef migrations list `
              --project "$env:GITHUB_WORKSPACE\src\Infrastructure\DAL" `
              --startup-project "$env:GITHUB_WORKSPACE\src\Presentation\Api" `
              --connection "$connectionString" `
              --configuration Release `
              2>&1
            
            Write-Host ""
            Write-Host "Migrations output:"
            $migrationsOutput | ForEach-Object { Write-Host $_ }
            
            # ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ pending migrations
            $hasPending = $false
            foreach ($line in $migrationsOutput) {
              if ($line -match "Pending" -or $line -match "\(Pending\)") {
                $hasPending = $true
                Write-Host ""
                Write-Host "‚ö†Ô∏è Found pending migration: $line" -ForegroundColor Yellow
              }
            }
            
            if ($hasPending) {
              Write-Host ""
              Write-Host "‚ö†Ô∏è There are pending migrations to apply" -ForegroundColor Yellow
              echo "HAS_PENDING_MIGRATIONS=true" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host ""
              Write-Host "‚úÖ No pending migrations found" -ForegroundColor Green
              echo "HAS_PENDING_MIGRATIONS=false" >> $env:GITHUB_OUTPUT
            }
          } else {
            Write-Host "‚ö†Ô∏è appsettings.json not found at: $appsettingsPath" -ForegroundColor Yellow
            echo "HAS_PENDING_MIGRATIONS=false" >> $env:GITHUB_OUTPUT
          }
      
      # üîü Apply Database Migrations
      - name: Apply Database Migrations
        if: steps.check-migrations.outputs.HAS_PENDING_MIGRATIONS == 'true'
        id: apply-migrations
        run: |
          Write-Host "=========================================="
          Write-Host "Applying Database Migrations..."
          Write-Host "=========================================="
          
          $appsettingsPath = "C:\0ALI\WebSites\BasitApi\appsettings.json"
          $appsettings = Get-Content $appsettingsPath | ConvertFrom-Json
          $connectionString = $appsettings.ConnectionStrings.DefaultConnection
          
          try {
            Write-Host "Starting database update..."
            Write-Host "Connection: $($connectionString -replace 'password=[^;]+', 'password=***')"
            
            dotnet ef database update `
              --project "$env:GITHUB_WORKSPACE\src\Infrastructure\DAL" `
              --startup-project "$env:GITHUB_WORKSPACE\src\Presentation\Api" `
              --connection "$connectionString" `
              --configuration Release `
              --no-build `
              --verbose
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host ""
              Write-Host "‚úÖ Migrations applied successfully!" -ForegroundColor Green
              echo "MIGRATION_SUCCESS=true" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host ""
              Write-Host "‚ùå Migration failed with exit code: $LASTEXITCODE" -ForegroundColor Red
              echo "MIGRATION_SUCCESS=false" >> $env:GITHUB_OUTPUT
              exit 1
            }
          } catch {
            Write-Host ""
            Write-Host "‚ùå Migration error: $($_.Exception.Message)" -ForegroundColor Red
            echo "MIGRATION_SUCCESS=false" >> $env:GITHUB_OUTPUT
            exit 1
          }
      
      # 1Ô∏è‚É£1Ô∏è‚É£ Publish API
      - name: Publish API
        run: dotnet publish "$env:GITHUB_WORKSPACE\src\Presentation\Api\Api.csproj" -c Release -o "$env:TEMP\publish\api" --no-build
      
      # 1Ô∏è‚É£2Ô∏è‚É£ Deploy API to IIS
      - name: Deploy API to IIS
        run: |
          Write-Host "=========================================="
          Write-Host "Deploying BasitApi..."
          Write-Host "=========================================="
          
          # Backup appsettings files
          Write-Host "Step 1: Backing up appsettings files..."
          if (Test-Path "C:\0ALI\WebSites\BasitApi\appsettings.json") {
            Copy-Item "C:\0ALI\WebSites\BasitApi\appsettings.json" "C:\temp\deployment-backup\api-appsettings.json" -Force
            Write-Host "  - appsettings.json backed up"
          }
          Get-ChildItem "C:\0ALI\WebSites\BasitApi\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "C:\temp\deployment-backup\" -Force
            Write-Host "  - $($_.Name) backed up"
          }
          
          # Backup web.config
          if (Test-Path "C:\0ALI\WebSites\BasitApi\web.config") {
            Copy-Item "C:\0ALI\WebSites\BasitApi\web.config" "C:\temp\deployment-backup\api-web.config" -Force
            Write-Host "  - web.config backed up"
          }
          
          # Backup wwwroot (user files)
          if (Test-Path "C:\0ALI\WebSites\BasitApi\wwwroot") {
            Write-Host "Step 2: Backing up wwwroot (user files)..."
            robocopy "C:\0ALI\WebSites\BasitApi\wwwroot" "C:\temp\deployment-backup\api-wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
            if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
            $global:LASTEXITCODE = 0
            Write-Host "  - wwwroot backed up successfully"
          }
          
          # Enable maintenance mode
          Write-Host "Step 3: Enabling maintenance mode..."
          Copy-Item "$env:GITHUB_WORKSPACE\.github\workflows\maintenance.html" "C:\0ALI\WebSites\BasitApi\app_offline.htm" -Force
          Start-Sleep -Seconds 2
          
          # Deploy new files
          Write-Host "Step 4: Deploying new files..."
          robocopy "$env:TEMP\publish\api" "C:\0ALI\WebSites\BasitApi" /E /R:2 /W:2 /NP
          if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
          $global:LASTEXITCODE = 0
          
          # Restore appsettings files
          Write-Host "Step 5: Restoring appsettings files..."
          if (Test-Path "C:\temp\deployment-backup\api-appsettings.json") {
            Copy-Item "C:\temp\deployment-backup\api-appsettings.json" "C:\0ALI\WebSites\BasitApi\appsettings.json" -Force
            Write-Host "  - appsettings.json restored"
          }
          Get-ChildItem "C:\temp\deployment-backup\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "C:\0ALI\WebSites\BasitApi\" -Force
            Write-Host "  - $($_.Name) restored"
          }
          
          # Restore web.config
          if (Test-Path "C:\temp\deployment-backup\api-web.config") {
            Copy-Item "C:\temp\deployment-backup\api-web.config" "C:\0ALI\WebSites\BasitApi\web.config" -Force
            Write-Host "  - web.config restored"
          }
          
          # Restore wwwroot
          if (Test-Path "C:\temp\deployment-backup\api-wwwroot") {
            Write-Host "Step 6: Restoring wwwroot (user files)..."
            robocopy "C:\temp\deployment-backup\api-wwwroot" "C:\0ALI\WebSites\BasitApi\wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
            if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
            $global:LASTEXITCODE = 0
            Write-Host "  - wwwroot restored successfully"
          }
          
          # Verify critical files
          Write-Host "Step 7: Verifying critical files..."
          $apiCriticalFiles = @(
            "C:\0ALI\WebSites\BasitApi\appsettings.json",
            "C:\0ALI\WebSites\BasitApi\Api.dll"
          )
          foreach ($file in $apiCriticalFiles) {
            if (Test-Path $file) {
              Write-Host "  - VERIFIED: $file exists" -ForegroundColor Green
            } else {
              Write-Host "  - ERROR: $file is missing!" -ForegroundColor Red
              exit 1
            }
          }
          
          # Disable maintenance mode
          Write-Host "Step 8: Disabling maintenance mode..."
          Remove-Item "C:\0ALI\WebSites\BasitApi\app_offline.htm" -ErrorAction SilentlyContinue
          
          Write-Host "=========================================="
          Write-Host "BasitApi deployed successfully!" -ForegroundColor Green
          Write-Host "=========================================="
      
      # 1Ô∏è‚É£3Ô∏è‚É£ Publish Dashboard (FIXED - Remove --no-build flag)
      - name: Publish Dashboard
        run: |
          Write-Host "=========================================="
          Write-Host "Publishing Dashboard..."
          Write-Host "=========================================="
          # Remove --no-build to allow proper trimming and assembly optimization
          dotnet publish "$env:GITHUB_WORKSPACE\src\Presentation\Dashboard\Dashboard.csproj" -c Release -o "$env:TEMP\publish\dashboard"
      
      # 1Ô∏è‚É£4Ô∏è‚É£ Prepare temp directory
      - name: Prepare temp directory
        run: |
          if (!(Test-Path "C:\temp\deployment-backup")) { 
            New-Item -ItemType Directory -Force -Path "C:\temp\deployment-backup" 
          }
          Write-Host "Temp directory ready"
            
      # 1Ô∏è‚É£5Ô∏è‚É£ Deploy Dashboard to IIS
      - name: Deploy Dashboard to IIS
        run: |
          Write-Host "=========================================="
          Write-Host "Deploying BasitDashboard..."
          Write-Host "=========================================="
          
          # Backup web.config
          Write-Host "Step 1: Backing up web.config..."
          if (Test-Path "C:\0ALI\WebSites\BasitDashboard\web.config") {
            Copy-Item "C:\0ALI\WebSites\BasitDashboard\web.config" "C:\temp\deployment-backup\dash-web.config" -Force
            Write-Host "  - web.config backed up"
          }
          
          # Backup appsettings
          Write-Host "Step 2: Backing up appsettings..."
          if (Test-Path "C:\0ALI\WebSites\BasitDashboard\appsettings.json") {
            Copy-Item "C:\0ALI\WebSites\BasitDashboard\appsettings.json" "C:\temp\deployment-backup\dash-appsettings.json" -Force
            Write-Host "  - appsettings.json backed up"
          }
          Get-ChildItem "C:\0ALI\WebSites\BasitDashboard\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "C:\temp\deployment-backup\" -Force
            Write-Host "  - $($_.Name) backed up"
          }
          
          # Enable maintenance mode
          Write-Host "Step 3: Enabling maintenance mode..."
          Copy-Item "$env:GITHUB_WORKSPACE\.github\workflows\maintenance.html" "C:\0ALI\WebSites\BasitDashboard\app_offline.htm" -Force
          Start-Sleep -Seconds 2
          
          # Deploy new files
          Write-Host "Step 4: Deploying new files..."
          robocopy "$env:TEMP\publish\dashboard" "C:\0ALI\WebSites\BasitDashboard" /E /R:2 /W:2 /NP
          if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
          $global:LASTEXITCODE = 0
          
          # Restore configs
          Write-Host "Step 5: Restoring web.config..."
          if (Test-Path "C:\temp\deployment-backup\dash-web.config") {
            Copy-Item "C:\temp\deployment-backup\dash-web.config" "C:\0ALI\WebSites\BasitDashboard\web.config" -Force
            Write-Host "  - web.config restored"
          }
          Write-Host "Step 6: Restoring appsettings..."
          if (Test-Path "C:\temp\deployment-backup\dash-appsettings.json") {
            Copy-Item "C:\temp\deployment-backup\dash-appsettings.json" "C:\0ALI\WebSites\BasitDashboard\appsettings.json" -Force
            Write-Host "  - appsettings.json restored"
          }
          Get-ChildItem "C:\temp\deployment-backup\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            $destPath = "C:\0ALI\WebSites\BasitDashboard\$($_.Name)"
            Copy-Item $_.FullName $destPath -Force
            Write-Host "  - $($_.Name) restored"
          }
          
          # Verify critical files
          Write-Host "Step 7: Verifying critical files..."
          $dashCriticalFiles = @(
            "C:\0ALI\WebSites\BasitDashboard\web.config",
            "C:\0ALI\WebSites\BasitDashboard\Dashboard.dll"
          )
          foreach ($file in $dashCriticalFiles) {
            if (Test-Path $file) {
              Write-Host "  - VERIFIED: $file exists" -ForegroundColor Green
            } else {
              Write-Host "  - ERROR: $file is missing!" -ForegroundColor Red
              exit 1
            }
          }
          
          # Disable maintenance mode
          Write-Host "Step 8: Disabling maintenance mode..."
          Remove-Item "C:\0ALI\WebSites\BasitDashboard\app_offline.htm" -ErrorAction SilentlyContinue
          
          Write-Host "=========================================="
          Write-Host "BasitDashboard deployed successfully!" -ForegroundColor Green
          Write-Host "=========================================="
      
      # 1Ô∏è‚É£6Ô∏è‚É£ Restart Application Pools
      - name: Restart Application Pools
        run: |
          Write-Host "=========================================="
          Write-Host "Restarting Application Pools..."
          Write-Host "=========================================="
          
          $sites = @("BasitApi", "BasitDashboard")
          foreach ($site in $sites) {
            try {
              $appPool = (Get-Website -Name $site).applicationPool
              if ($appPool) {
                Restart-WebAppPool -Name $appPool
                Write-Host "  - Restarted $site (App Pool: $appPool)" -ForegroundColor Green
                Start-Sleep -Seconds 3
              }
            } catch {
              Write-Host "  - Could not auto-detect pool for $site, trying direct restart..." -ForegroundColor Yellow
              try {
                Restart-WebAppPool -Name $site
                Write-Host "  - Restarted pool: $site" -ForegroundColor Green
                Start-Sleep -Seconds 3
              } catch {
                Write-Host "  - Manual restart may be needed for $site" -ForegroundColor Red
              }
            }
          }
      
      # 1Ô∏è‚É£7Ô∏è‚É£ Health Check
      - name: Health Check
        id: health-check
        run: |
          Write-Host "=========================================="
          Write-Host "Performing Health Checks..."
          Write-Host "=========================================="
          
          Start-Sleep -Seconds 5
          
          # Check API health
          $apiHealthy = $false
          try {
            $response = Invoke-WebRequest -Uri "http://localhost/api/health" -UseBasicParsing -TimeoutSec 30 -ErrorAction Stop
            if ($response.StatusCode -eq 200) {
              Write-Host "‚úÖ API is healthy (Status: $($response.StatusCode))" -ForegroundColor Green
              $apiHealthy = $true
            }
          } catch {
            $statusCode = $_.Exception.Response.StatusCode.value__
            Write-Host "‚ùå API health check failed (Status: $statusCode)" -ForegroundColor Red
            Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red
            
            if ($statusCode -eq 500) {
              Write-Host "‚ö†Ô∏è Error 500 detected - possible migration issue!" -ForegroundColor Yellow
              echo "API_HEALTH_FAILED=true" >> $env:GITHUB_OUTPUT
            }
          }
          
          # Check Dashboard health
          try {
            $response = Invoke-WebRequest -Uri "http://localhost/dashboard" -UseBasicParsing -TimeoutSec 30 -ErrorAction Stop
            if ($response.StatusCode -eq 200) {
              Write-Host "‚úÖ Dashboard is healthy (Status: $($response.StatusCode))" -ForegroundColor Green
            }
          } catch {
            Write-Host "‚ö†Ô∏è Dashboard health check failed" -ForegroundColor Yellow
          }
          
          if (-not $apiHealthy) {
            Write-Host ""
            Write-Host "=========================================="
            Write-Host "‚ö†Ô∏è API HEALTH CHECK FAILED!" -ForegroundColor Red
            Write-Host "=========================================="
            exit 1
          }
      
      # 1Ô∏è‚É£8Ô∏è‚É£ Rollback on Failure
      - name: Rollback Database on Failure
        if: failure() && steps.apply-migrations.outputs.MIGRATION_SUCCESS == 'false' && env.DB_BACKUP_PATH != ''
        run: |
          Write-Host "=========================================="
          Write-Host "‚ö†Ô∏è ROLLING BACK DATABASE..." -ForegroundColor Yellow
          Write-Host "=========================================="
          
          $backupPath = $env:DB_BACKUP_PATH
          $serverName = $env:DB_SERVER
          $databaseName = $env:DB_NAME
          $userId = $env:DB_USER
          $password = $env:DB_PASSWORD
          
          if (Test-Path $backupPath) {
            try {
              Write-Host "Restoring database from: $backupPath"
              Write-Host "Server: $serverName"
              Write-Host "Database: $databaseName"
              
              # ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÄ database ŸÑŸÄ single user mode
              Write-Host "Setting database to SINGLE_USER mode..."
              sqlcmd -S $serverName -U $userId -P $password -Q "ALTER DATABASE [$databaseName] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;"
              
              # ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÄ database
              Write-Host "Restoring database..."
              sqlcmd -S $serverName -U $userId -P $password -Q "RESTORE DATABASE [$databaseName] FROM DISK = N'$backupPath' WITH REPLACE, RECOVERY;"
              
              # ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÄ database ŸÑŸÄ multi user mode
              Write-Host "Setting database to MULTI_USER mode..."
              sqlcmd -S $serverName -U $userId -P $password -Q "ALTER DATABASE [$databaseName] SET MULTI_USER;"
              
              if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Database rolled back successfully!" -ForegroundColor Green
              } else {
                Write-Host "‚ùå Database rollback failed (Exit code: $LASTEXITCODE)!" -ForegroundColor Red
              }
            } catch {
              Write-Host "‚ùå Rollback error: $($_.Exception.Message)" -ForegroundColor Red
            }
          } else {
            Write-Host "‚ö†Ô∏è Backup file not found: $backupPath" -ForegroundColor Yellow
          }
      
      # 1Ô∏è‚É£9Ô∏è‚É£ Cleanup
      - name: Cleanup
        if: always()
        run: |
          Write-Host "=========================================="
          Write-Host "Cleaning up..."
          Write-Host "=========================================="
          
          Remove-Item "C:\temp\deployment-backup\*" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$env:TEMP\publish" -Recurse -Force -ErrorAction SilentlyContinue
          
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "   DEPLOYMENT COMPLETED!" -ForegroundColor Green
          Write-Host "=========================================="
          Write-Host "‚úÖ Database Migration: Applied" -ForegroundColor Green
          Write-Host "‚úÖ API Protection:" -ForegroundColor Cyan
          Write-Host "   - appsettings.json: PRESERVED" -ForegroundColor Green
          Write-Host "   - web.config: PRESERVED" -ForegroundColor Green
          Write-Host "   - wwwroot (user files): PRESERVED" -ForegroundColor Green
          Write-Host ""
          Write-Host "‚úÖ Dashboard Protection:" -ForegroundColor Cyan
          Write-Host "   - web.config: PRESERVED" -ForegroundColor Green
          Write-Host "   - appsettings.json: PRESERVED" -ForegroundColor Green
          Write-Host ""
          Write-Host "‚úÖ App Pools: RESTARTED" -ForegroundColor Green
          Write-Host "‚úÖ Health Check: PASSED" -ForegroundColor Green
          Write-Host "=========================================="