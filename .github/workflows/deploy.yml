name: 🚀 Deploy ASP.NET API & Blazor Dashboard to IIS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, windows, iis]
    steps:
      # 1️⃣ تحميل الكود من GitHub
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2️⃣ استخدام الـ .NET المثبت مسبقًا
      - name: Setup .NET
        run: echo "Using preinstalled .NET SDK on server"
      
      # 3️⃣ استرجاع الـ NuGet Packages
      - name: Restore dependencies
        run: dotnet restore

      # 4️⃣ (اختياري) تخزين Workloads في الكاش لتسريع عمليات النشر
      - name: Cache .NET workloads
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\.dotnet\workloads
          key: dotnet-workloads-${{ runner.os }}-10.0.100
      
      # 5️⃣ التحقق أو تثبيت Blazor Workload
      - name: Verify or Install Blazor Workload
        run: |
          Write-Host "Checking Blazor workloads..."
          $wasm = dotnet workload list | Select-String "wasm-tools"
          if (-not $wasm) {
            Write-Host "Installing wasm-tools workload..."
            dotnet workload install wasm-tools --ignore-failed-sources
          } else {
            Write-Host "wasm-tools workload already installed"
          }
          dotnet workload list
      
      # 6️⃣ Publish API (Build + Publish في خطوة واحدة)
      - name: Publish API
        run: dotnet publish ./src/Presentation/Api -c Release -o "$env:TEMP\publish\api" --no-restore
      
      # 7️⃣ Publish Dashboard (Build + Publish في خطوة واحدة)
      - name: Publish Dashboard
        run: dotnet publish ./src/Presentation/Dashboard -c Release -o "$env:TEMP\publish\dashboard" --no-restore
      
      # 8️⃣ تجهيز مجلد مؤقت للـ backup
      - name: Prepare temp directory
        run: |
          if (!(Test-Path "C:\temp\deployment-backup")) { 
            New-Item -ItemType Directory -Force -Path "C:\temp\deployment-backup" 
          }
          Write-Host "Temp directory ready"
      
      # 9️⃣ نشر الـ API مع حماية appsettings + wwwroot
      - name: Deploy API to IIS
        run: |
          Write-Host "=========================================="
          Write-Host "Deploying BasitApi..."
          Write-Host "=========================================="
          
          # Backup appsettings files
          Write-Host "Step 1: Backing up appsettings files..."
          if (Test-Path "C:\0ALI\WebSites\BasitApi\appsettings.json") {
            Copy-Item "C:\0ALI\WebSites\BasitApi\appsettings.json" "C:\temp\deployment-backup\api-appsettings.json" -Force
            Write-Host "  - appsettings.json backed up"
          }
          Get-ChildItem "C:\0ALI\WebSites\BasitApi\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "C:\temp\deployment-backup\" -Force
            Write-Host "  - $($_.Name) backed up"
          }
          
          # Backup web.config
          if (Test-Path "C:\0ALI\WebSites\BasitApi\web.config") {
            Copy-Item "C:\0ALI\WebSites\BasitApi\web.config" "C:\temp\deployment-backup\api-web.config" -Force
            Write-Host "  - web.config backed up"
          }
          
          # Backup wwwroot (user files)
          if (Test-Path "C:\0ALI\WebSites\BasitApi\wwwroot") {
            Write-Host "Step 2: Backing up wwwroot (user files)..."
            robocopy "C:\0ALI\WebSites\BasitApi\wwwroot" "C:\temp\deployment-backup\api-wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
            if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
            $global:LASTEXITCODE = 0
            Write-Host "  - wwwroot backed up successfully"
          }
          
          # Enable maintenance mode
          Write-Host "Step 3: Enabling maintenance mode..."
          Copy-Item ".github/workflows/maintenance.html" "C:\0ALI\WebSites\BasitApi\app_offline.htm" -Force
          Start-Sleep -Seconds 2
          
          # Deploy new files
          Write-Host "Step 4: Deploying new files..."
          robocopy "$env:TEMP\publish\api" "C:\0ALI\WebSites\BasitApi" /E /R:2 /W:2 /NP
          if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
          $global:LASTEXITCODE = 0
          
          # Restore appsettings files
          Write-Host "Step 5: Restoring appsettings files..."
          if (Test-Path "C:\temp\deployment-backup\api-appsettings.json") {
            Copy-Item "C:\temp\deployment-backup\api-appsettings.json" "C:\0ALI\WebSites\BasitApi\appsettings.json" -Force
            Write-Host "  - appsettings.json restored"
          }
          Get-ChildItem "C:\temp\deployment-backup\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "C:\0ALI\WebSites\BasitApi\" -Force
            Write-Host "  - $($_.Name) restored"
          }
          
          # Restore web.config
          if (Test-Path "C:\temp\deployment-backup\api-web.config") {
            Copy-Item "C:\temp\deployment-backup\api-web.config" "C:\0ALI\WebSites\BasitApi\web.config" -Force
            Write-Host "  - web.config restored"
          }
          
          # Restore wwwroot
          if (Test-Path "C:\temp\deployment-backup\api-wwwroot") {
            Write-Host "Step 6: Restoring wwwroot (user files)..."
            robocopy "C:\temp\deployment-backup\api-wwwroot" "C:\0ALI\WebSites\BasitApi\wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
            if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
            $global:LASTEXITCODE = 0
            Write-Host "  - wwwroot restored successfully"
          }
          
          # Verify critical files
          Write-Host "Step 7: Verifying critical files..."
          $apiCriticalFiles = @(
            "C:\0ALI\WebSites\BasitApi\appsettings.json"
          )
          foreach ($file in $apiCriticalFiles) {
            if (Test-Path $file) {
              Write-Host "  - VERIFIED: $file exists" -ForegroundColor Green
            } else {
              Write-Host "  - ERROR: $file is missing!" -ForegroundColor Red
              exit 1
            }
          }
          
          # Disable maintenance mode
          Write-Host "Step 8: Disabling maintenance mode..."
          Remove-Item "C:\0ALI\WebSites\BasitApi\app_offline.htm" -ErrorAction SilentlyContinue
          
          Write-Host "=========================================="
          Write-Host "BasitApi deployed successfully!" -ForegroundColor Green
          Write-Host "=========================================="
      
      # 🔟 نشر الـ Dashboard
      - name: Deploy Dashboard to IIS
        run: |
          Write-Host "=========================================="
          Write-Host "Deploying BasitDashboard..."
          Write-Host "=========================================="
          
          # Backup web.config
          Write-Host "Step 1: Backing up web.config..."
          if (Test-Path "C:\0ALI\WebSites\BasitDashboard\web.config") {
            Copy-Item "C:\0ALI\WebSites\BasitDashboard\web.config" "C:\temp\deployment-backup\dash-web.config" -Force
            Write-Host "  - web.config backed up"
          }
          
          # Backup appsettings
          Write-Host "Step 2: Backing up appsettings..."
          if (Test-Path "C:\0ALI\WebSites\BasitDashboard\appsettings.json") {
            Copy-Item "C:\0ALI\WebSites\BasitDashboard\appsettings.json" "C:\temp\deployment-backup\dash-appsettings.json" -Force
            Write-Host "  - appsettings.json backed up"
          }
          Get-ChildItem "C:\0ALI\WebSites\BasitDashboard\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "C:\temp\deployment-backup\" -Force
            Write-Host "  - $($_.Name) backed up"
          }
          
          # Enable maintenance mode
          Write-Host "Step 3: Enabling maintenance mode..."
          Copy-Item ".github/workflows/maintenance.html" "C:\0ALI\WebSites\BasitDashboard\app_offline.htm" -Force
          Start-Sleep -Seconds 2
          
          # Deploy new files
          Write-Host "Step 4: Deploying new files..."
          robocopy "$env:TEMP\publish\dashboard" "C:\0ALI\WebSites\BasitDashboard" /E /R:2 /W:2 /NP
          if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
          $global:LASTEXITCODE = 0
          
          # Restore configs
          Write-Host "Step 5: Restoring web.config..."
          if (Test-Path "C:\temp\deployment-backup\dash-web.config") {
            Copy-Item "C:\temp\deployment-backup\dash-web.config" "C:\0ALI\WebSites\BasitDashboard\web.config" -Force
            Write-Host "  - web.config restored"
          }
          Write-Host "Step 6: Restoring appsettings..."
          if (Test-Path "C:\temp\deployment-backup\dash-appsettings.json") {
            Copy-Item "C:\temp\deployment-backup\dash-appsettings.json" "C:\0ALI\WebSites\BasitDashboard\appsettings.json" -Force
            Write-Host "  - appsettings.json restored"
          }
          Get-ChildItem "C:\temp\deployment-backup\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            $destPath = "C:\0ALI\WebSites\BasitDashboard\$($_.Name)"
            Copy-Item $_.FullName $destPath -Force
            Write-Host "  - $($_.Name) restored"
          }
          
          # Verify critical files
          Write-Host "Step 7: Verifying critical files..."
          $dashCriticalFiles = @("C:\0ALI\WebSites\BasitDashboard\web.config")
          foreach ($file in $dashCriticalFiles) {
            if (Test-Path $file) {
              Write-Host "  - VERIFIED: $file exists" -ForegroundColor Green
            } else {
              Write-Host "  - ERROR: $file is missing!" -ForegroundColor Red
              exit 1
            }
          }
          
          # Disable maintenance mode
          Write-Host "Step 8: Disabling maintenance mode..."
          Remove-Item "C:\0ALI\WebSites\BasitDashboard\app_offline.htm" -ErrorAction SilentlyContinue
          
          Write-Host "=========================================="
          Write-Host "BasitDashboard deployed successfully!" -ForegroundColor Green
          Write-Host "=========================================="
      
      # 1️⃣1️⃣ إعادة تشغيل Application Pools
      - name: Restart Application Pools
        run: |
          Write-Host "=========================================="
          Write-Host "Restarting Application Pools..."
          Write-Host "=========================================="
          
          $sites = @("BasitApi", "BasitDashboard")
          foreach ($site in $sites) {
            try {
              $appPool = (Get-Website -Name $site).applicationPool
              if ($appPool) {
                Restart-WebAppPool -Name $appPool
                Write-Host "  - Restarted $site (App Pool: $appPool)" -ForegroundColor Green
              }
            } catch {
              Write-Host "  - Could not auto-detect pool for $site, trying direct restart..." -ForegroundColor Yellow
              try {
                Restart-WebAppPool -Name $site
                Write-Host "  - Restarted pool: $site" -ForegroundColor Green
              } catch {
                Write-Host "  - Manual restart may be needed for $site" -ForegroundColor Red
              }
            }
          }
      
      # 1️⃣2️⃣ تنظيف الملفات المؤقتة
      - name: Cleanup
        run: |
          Write-Host "=========================================="
          Write-Host "Cleaning up..."
          Write-Host "=========================================="
          
          Remove-Item "C:\temp\deployment-backup\*" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$env:TEMP\publish" -Recurse -Force -ErrorAction SilentlyContinue
          
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "   DEPLOYMENT COMPLETED SUCCESSFULLY!" -ForegroundColor Green
          Write-Host "=========================================="
          Write-Host "API Protection:" -ForegroundColor Cyan
          Write-Host "  - appsettings.json: PRESERVED" -ForegroundColor Green
          Write-Host "  - web.config: PRESERVED" -ForegroundColor Green
          Write-Host "  - wwwroot (user files): PRESERVED" -ForegroundColor Green
          Write-Host ""
          Write-Host "Dashboard Protection:" -ForegroundColor Cyan
          Write-Host "  - web.config: PRESERVED" -ForegroundColor Green
          Write-Host "  - appsettings.json: PRESERVED" -ForegroundColor Green
          Write-Host "  - wwwroot: REPLACED (updated)" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "App Pools: RESTARTED" -ForegroundColor Green
          Write-Host "Downtime: MINIMAL (maintenance page shown)" -ForegroundColor Green
          Write-Host "=========================================="
