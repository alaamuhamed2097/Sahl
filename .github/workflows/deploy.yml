name: üöÄ CI/CD - Build, Test, Migrate & Deploy to IIS

on:
  push:
    branches:
      - main  # Ÿäÿ¥ÿ™ÿ∫ŸÑ ÿ®ÿ≥ ŸÑŸÖÿß ÿ™ÿπŸÖŸÑ push ÿπŸÑŸâ main ŸÖÿ®ÿßÿ¥ÿ±ÿ©
  pull_request:
    branches:
      - main  # Ÿäÿ¥ÿ™ÿ∫ŸÑ ŸÑŸÖÿß ÿ™ŸÅÿ™ÿ≠ PR ŸÖŸÜ ÿ£Ÿä branch ŸÑŸÄ main
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Ÿäÿ≥ŸÖÿ≠ŸÑŸÉ ÿ™ÿ¥ÿ∫ŸÑŸá ŸäÿØŸàŸä ŸÖŸÜ GitHub Actions

# ŸÖŸÜÿπ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿ£ŸÉÿ™ÿ± ŸÖŸÜ workflow ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸàŸÇÿ™
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Job 1: Build and Test (ÿ®Ÿäÿ¥ÿ™ÿ∫ŸÑ ÿπŸÑŸâ PR Ÿà Push)
  # ============================================
  build-and-test:
    name: üß™ Build & Test
    runs-on: [self-hosted, windows, iis]
    
    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2Ô∏è‚É£ Setup .NET
      - name: Setup .NET
        run: echo "Using preinstalled .NET SDK on server"
      
      # 3Ô∏è‚É£ Restore dependencies
      - name: Restore dependencies
        run: |
          Write-Host "=========================================="
          Write-Host "Restoring NuGet packages..."
          Write-Host "=========================================="
          dotnet restore "$env:GITHUB_WORKSPACE\Sahl.slnx"
      
      # 4Ô∏è‚É£ Build solution
      - name: Build Solution
        run: |
          Write-Host "=========================================="
          Write-Host "Building solution in Release mode..."
          Write-Host "=========================================="
          dotnet build "$env:GITHUB_WORKSPACE\Sahl.slnx" -c Release --no-restore
      
      # 5Ô∏è‚É£ Run Unit Tests
      - name: Run Unit Tests
        run: |
          Write-Host "=========================================="
          Write-Host "Running Unit Tests..."
          Write-Host "=========================================="
          dotnet test "$env:GITHUB_WORKSPACE\tests\UnitTests\UnitTests.csproj" `
            --configuration Release `
            --no-build `
            --verbosity normal `
            --logger "trx;LogFileName=unit-test-results.trx" `
            --logger "console;verbosity=detailed" `
            --collect:"XPlat Code Coverage" `
            --results-directory "$env:TEMP\TestResults\Unit"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Unit tests failed!" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Unit tests passed!" -ForegroundColor Green
      
      # 6Ô∏è‚É£ Run Integration Tests
      - name: Run Integration Tests
        run: |
          Write-Host "=========================================="
          Write-Host "Running Integration Tests..."
          Write-Host "=========================================="
          dotnet test "$env:GITHUB_WORKSPACE\tests\IntegrationTests\IntegrationTests.csproj" `
            --configuration Release `
            --no-build `
            --verbosity normal `
            --logger "trx;LogFileName=integration-test-results.trx" `
            --logger "console;verbosity=detailed" `
            --collect:"XPlat Code Coverage" `
            --results-directory "$env:TEMP\TestResults\Integration"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Integration tests failed!" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Integration tests passed!" -ForegroundColor Green
      
      # 7Ô∏è‚É£ Test Summary
      - name: Test Summary
        if: always()
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "           TEST SUMMARY" -ForegroundColor Cyan
          Write-Host "=========================================="
          
          if (Test-Path "$env:TEMP\TestResults\Unit\unit-test-results.trx") {
            [xml]$unitResults = Get-Content "$env:TEMP\TestResults\Unit\unit-test-results.trx"
            $unitTotal = $unitResults.TestRun.ResultSummary.Counters.total
            $unitPassed = $unitResults.TestRun.ResultSummary.Counters.passed
            $unitFailed = $unitResults.TestRun.ResultSummary.Counters.failed
            
            Write-Host "Unit Tests:" -ForegroundColor White
            Write-Host "  Total:  $unitTotal" -ForegroundColor White
            Write-Host "  Passed: $unitPassed" -ForegroundColor Green
            Write-Host "  Failed: $unitFailed" -ForegroundColor $(if ($unitFailed -gt 0) { "Red" } else { "Green" })
          }
          
          if (Test-Path "$env:TEMP\TestResults\Integration\integration-test-results.trx") {
            [xml]$integrationResults = Get-Content "$env:TEMP\TestResults\Integration\integration-test-results.trx"
            $intTotal = $integrationResults.TestRun.ResultSummary.Counters.total
            $intPassed = $integrationResults.TestRun.ResultSummary.Counters.passed
            $intFailed = $integrationResults.TestRun.ResultSummary.Counters.failed
            
            Write-Host ""
            Write-Host "Integration Tests:" -ForegroundColor White
            Write-Host "  Total:  $intTotal" -ForegroundColor White
            Write-Host "  Passed: $intPassed" -ForegroundColor Green
            Write-Host "  Failed: $intFailed" -ForegroundColor $(if ($intFailed -gt 0) { "Red" } else { "Green" })
          }
          
          Write-Host "=========================================="
      
      # 8Ô∏è‚É£ Upload test results
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            ${{ runner.temp }}/TestResults/**/*.trx
            ${{ runner.temp }}/TestResults/**/coverage.cobertura.xml
          retention-days: 30

  # ============================================
  # Job 2: Deploy to IIS (ŸÅŸÇÿ∑ ÿπŸÑŸâ Push ŸÑŸÄ mainÿå ŸÖÿ¥ PR!)
  # ============================================
  deploy:
    name: üöÄ Deploy to IIS
    runs-on: [self-hosted, windows, iis]
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2Ô∏è‚É£ Setup .NET
      - name: Setup .NET
        run: echo "Using preinstalled .NET SDK on server"
      
      # 3Ô∏è‚É£ Restore dependencies
      - name: Restore dependencies
        run: |
          Write-Host "=========================================="
          Write-Host "Restoring NuGet packages for deployment..."
          Write-Host "=========================================="
          dotnet restore "$env:GITHUB_WORKSPACE\Sahl.slnx"
      
      # 4Ô∏è‚É£ Verify Blazor WASM workload (COMMENTED OUT - Dashboard not being deployed)
      # - name: Verify Blazor Workload
      #   run: |
      #     Write-Host "Checking Blazor workloads..."
      #     $wasm = dotnet workload list | Select-String "wasm-tools"
      #     if (-not $wasm) {
      #       Write-Host "Installing wasm-tools workload..."
      #       dotnet workload install wasm-tools --ignore-failed-sources
      #     } else {
      #       Write-Host "‚úÖ wasm-tools workload already installed"
      #     }
      
      # 5Ô∏è‚É£ Publish API
      - name: Publish API
        run: |
          Write-Host "=========================================="
          Write-Host "Publishing API..."
          Write-Host "=========================================="
          dotnet publish "$env:GITHUB_WORKSPACE\src\Presentation\Api\Api.csproj" `
            -c Release `
            -o "$env:TEMP\publish\api" `
            --no-restore
          
          Write-Host "‚úÖ API published successfully!" -ForegroundColor Green
      
      # 6Ô∏è‚É£ Publish Dashboard (COMMENTED OUT FOR FASTER API-ONLY DEPLOYMENT)
      # - name: Publish Dashboard
      #   run: |
      #     Write-Host "=========================================="
      #     Write-Host "Publishing Blazor WASM Dashboard..."
      #     Write-Host "=========================================="
      #     
      #     dotnet publish "$env:GITHUB_WORKSPACE\src\Presentation\Dashboard\Dashboard.csproj" `
      #       -c Release `
      #       -o "$env:TEMP\publish\dashboard" `
      #       --no-restore
      #     
      #     if ($LASTEXITCODE -ne 0) {
      #       Write-Host "‚ùå Dashboard publish failed!" -ForegroundColor Red
      #       exit 1
      #     }
      #     
      #     # Verify WASM files
      #     Write-Host ""
      #     Write-Host "Verifying WASM files..."
      #     $wasmFiles = Get-ChildItem "$env:TEMP\publish\dashboard\wwwroot\_framework" -Filter "*.wasm" -ErrorAction SilentlyContinue
      #     
      #     if ($wasmFiles.Count -gt 0) {
      #       Write-Host "‚úÖ Found $($wasmFiles.Count) WASM files" -ForegroundColor Green
      #       
      #       # Show key files
      #       $dotnetWasm = $wasmFiles | Where-Object { $_.Name -match "^dotnet\." } | Select-Object -First 1
      #       $dashboardWasm = $wasmFiles | Where-Object { $_.Name -match "^Dashboard\." } | Select-Object -First 1
      #       
      #       if ($dotnetWasm) {
      #         $size = $dotnetWasm.Length / 1MB
      #         Write-Host "  ‚Ä¢ $($dotnetWasm.Name) ($([math]::Round($size, 2)) MB)" -ForegroundColor Cyan
      #       }
      #       if ($dashboardWasm) {
      #         $size = $dashboardWasm.Length / 1MB
      #         Write-Host "  ‚Ä¢ $($dashboardWasm.Name) ($([math]::Round($size, 2)) MB)" -ForegroundColor Cyan
      #       }
      #     } else {
      #       Write-Host "‚ùå No WASM files found!" -ForegroundColor Red
      #       exit 1
      #     }
      #     
      #     Write-Host "‚úÖ Dashboard published successfully!" -ForegroundColor Green
      
      # 7Ô∏è‚É£ Install EF Core Tools (for migrations)
      - name: Install EF Core Tools
        run: |
          Write-Host "=========================================="
          Write-Host "Installing/Updating EF Core Tools..."
          Write-Host "=========================================="
          dotnet tool install --global dotnet-ef --version 8.* 2>$null
          if ($LASTEXITCODE -ne 0) {
            dotnet tool update --global dotnet-ef --version 8.*
          }
          dotnet ef --version
      
      # 8Ô∏è‚É£ Backup Database
      - name: Backup Database
        run: |
          Write-Host "=========================================="
          Write-Host "Creating Database Backup..."
          Write-Host "=========================================="
          
          $appsettingsPath = "C:\0ALI\WebSites\BasitApi\appsettings.json"
          if (Test-Path $appsettingsPath) {
            $appsettings = Get-Content $appsettingsPath | ConvertFrom-Json
            $connectionString = $appsettings.ConnectionStrings.DefaultConnection
            
            if ($connectionString -match "Server=([^;]+)") { $serverName = $matches[1].Trim() }
            if ($connectionString -match "Database=([^;]+)") { $databaseName = $matches[1].Trim() }
            if ($connectionString -match "user id=([^;]+)") { $userId = $matches[1].Trim() }
            if ($connectionString -match "password=([^;]+)") { $password = $matches[1].Trim() }
            
            if ($serverName -and $databaseName -and $userId -and $password) {
              $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
              $backupPath = "C:\temp\db-backups\${databaseName}_${timestamp}.bak"
              
              if (!(Test-Path "C:\temp\db-backups")) {
                New-Item -ItemType Directory -Force -Path "C:\temp\db-backups" | Out-Null
              }
              
              Write-Host "Database: $databaseName"
              Write-Host "Server: $serverName"
              Write-Host "Backup Path: $backupPath"
              
              try {
                $backupQuery = "BACKUP DATABASE [$databaseName] TO DISK = N'$backupPath' WITH FORMAT, INIT, NAME = N'$databaseName-Backup', SKIP, NOREWIND, NOUNLOAD, COMPRESSION, STATS = 10"
                sqlcmd -S $serverName -U $userId -P $password -Q $backupQuery
                
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "‚úÖ Database backup created successfully!" -ForegroundColor Green
                  Write-Host "Backup saved to: $backupPath" -ForegroundColor Cyan
                  
                  echo "DB_BACKUP_PATH=$backupPath" >> $env:GITHUB_ENV
                  echo "DB_SERVER=$serverName" >> $env:GITHUB_ENV
                  echo "DB_NAME=$databaseName" >> $env:GITHUB_ENV
                  echo "DB_USER=$userId" >> $env:GITHUB_ENV
                  echo "DB_PASSWORD=$password" >> $env:GITHUB_ENV
                } else {
                  Write-Host "‚ö†Ô∏è Warning: Database backup failed (Exit code: $LASTEXITCODE)" -ForegroundColor Yellow
                }
              } catch {
                Write-Host "‚ö†Ô∏è Warning: Could not create backup: $($_.Exception.Message)" -ForegroundColor Yellow
              }
              
              # Cleanup old backups (7+ days)
              Write-Host "Cleaning up old backups..."
              Get-ChildItem "C:\temp\db-backups\*.bak" | Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-7) } | Remove-Item -Force
            } else {
              Write-Host "‚ö†Ô∏è Could not parse connection string" -ForegroundColor Yellow
            }
          } else {
            Write-Host "‚ö†Ô∏è appsettings.json not found at: $appsettingsPath" -ForegroundColor Yellow
          }

      # 9Ô∏è‚É£ Check for Pending Migrations
      - name: Check Pending Migrations
        id: check-migrations
        run: |
          Write-Host "=========================================="
          Write-Host "Checking for Pending Migrations..."
          Write-Host "=========================================="
          
          $appsettingsPath = "C:\0ALI\WebSites\BasitApi\appsettings.json"
          
          if (Test-Path $appsettingsPath) {
            $appsettings = Get-Content $appsettingsPath | ConvertFrom-Json
            $connectionString = $appsettings.ConnectionStrings.DefaultConnection
            
            Write-Host "Building projects for EF migrations check..."
            
            dotnet build "$env:GITHUB_WORKSPACE\src\Infrastructure\DAL\DAL.csproj" -c Release
            dotnet build "$env:GITHUB_WORKSPACE\src\Presentation\Api\Api.csproj" -c Release
            
            Write-Host ""
            Write-Host "Running EF migrations list..."
            
            $migrationsOutput = dotnet ef migrations list `
              --project "$env:GITHUB_WORKSPACE\src\Infrastructure\DAL" `
              --startup-project "$env:GITHUB_WORKSPACE\src\Presentation\Api" `
              --connection "$connectionString" `
              --configuration Release `
              2>&1
            
            Write-Host ""
            Write-Host "Migrations output:"
            $migrationsOutput | ForEach-Object { Write-Host $_ }
            
            $hasPending = $false
            foreach ($line in $migrationsOutput) {
              if ($line -match "Pending" -or $line -match "\(Pending\)") {
                $hasPending = $true
                Write-Host ""
                Write-Host "‚ö†Ô∏è Found pending migration: $line" -ForegroundColor Yellow
              }
            }
            
            if ($hasPending) {
              Write-Host ""
              Write-Host "‚ö†Ô∏è There are pending migrations to apply" -ForegroundColor Yellow
              echo "HAS_PENDING_MIGRATIONS=true" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host ""
              Write-Host "‚úÖ No pending migrations found" -ForegroundColor Green
              echo "HAS_PENDING_MIGRATIONS=false" >> $env:GITHUB_OUTPUT
            }
          } else {
            Write-Host "‚ö†Ô∏è appsettings.json not found" -ForegroundColor Yellow
            echo "HAS_PENDING_MIGRATIONS=false" >> $env:GITHUB_OUTPUT
          }
      
      # üîü Apply Database Migrations
      - name: Apply Database Migrations
        if: steps.check-migrations.outputs.HAS_PENDING_MIGRATIONS == 'true'
        id: apply-migrations
        run: |
          Write-Host "=========================================="
          Write-Host "Applying Database Migrations..."
          Write-Host "=========================================="
          
          $appsettingsPath = "C:\0ALI\WebSites\BasitApi\appsettings.json"
          $appsettings = Get-Content $appsettingsPath | ConvertFrom-Json
          $connectionString = $appsettings.ConnectionStrings.DefaultConnection
          
          try {
            Write-Host "Starting database update..."
            Write-Host "Connection: $($connectionString -replace 'password=[^;]+', 'password=***')"
            
            dotnet ef database update `
              --project "$env:GITHUB_WORKSPACE\src\Infrastructure\DAL" `
              --startup-project "$env:GITHUB_WORKSPACE\src\Presentation\Api" `
              --connection "$connectionString" `
              --configuration Release `
              --verbose
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host ""
              Write-Host "‚úÖ Migrations applied successfully!" -ForegroundColor Green
              echo "MIGRATION_SUCCESS=true" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host ""
              Write-Host "‚ùå Migration failed with exit code: $LASTEXITCODE" -ForegroundColor Red
              echo "MIGRATION_SUCCESS=false" >> $env:GITHUB_OUTPUT
              exit 1
            }
          } catch {
            Write-Host ""
            Write-Host "‚ùå Migration error: $($_.Exception.Message)" -ForegroundColor Red
            echo "MIGRATION_SUCCESS=false" >> $env:GITHUB_OUTPUT
            exit 1
          }
      
      # 1Ô∏è‚É£1Ô∏è‚É£ Prepare temp directory
      - name: Prepare temp directory
        run: |
          if (!(Test-Path "C:\temp\deployment-backup")) { 
            New-Item -ItemType Directory -Force -Path "C:\temp\deployment-backup" 
          }
          Write-Host "Temp directory ready"
      
      # 1Ô∏è‚É£2Ô∏è‚É£ Deploy API to IIS
      - name: Deploy API to IIS
        run: |
          Write-Host "=========================================="
          Write-Host "Deploying BasitApi..."
          Write-Host "=========================================="
          
          # Backup appsettings files
          Write-Host "Step 1: Backing up appsettings files..."
          if (Test-Path "C:\0ALI\WebSites\BasitApi\appsettings.json") {
            Copy-Item "C:\0ALI\WebSites\BasitApi\appsettings.json" "C:\temp\deployment-backup\api-appsettings.json" -Force
            Write-Host "  - appsettings.json backed up"
          }
          Get-ChildItem "C:\0ALI\WebSites\BasitApi\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "C:\temp\deployment-backup\" -Force
            Write-Host "  - $($_.Name) backed up"
          }
          
          # Backup web.config
          if (Test-Path "C:\0ALI\WebSites\BasitApi\web.config") {
            Copy-Item "C:\0ALI\WebSites\BasitApi\web.config" "C:\temp\deployment-backup\api-web.config" -Force
            Write-Host "  - web.config backed up"
          }
          
          # Backup wwwroot (user files)
          if (Test-Path "C:\0ALI\WebSites\BasitApi\wwwroot") {
            Write-Host "Step 2: Backing up wwwroot (user files)..."
            robocopy "C:\0ALI\WebSites\BasitApi\wwwroot" "C:\temp\deployment-backup\api-wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
            if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
            $global:LASTEXITCODE = 0
            Write-Host "  - wwwroot backed up successfully"
          }
          
          # Enable maintenance mode
          Write-Host "Step 3: Enabling maintenance mode..."
          Copy-Item "$env:GITHUB_WORKSPACE\.github\workflows\maintenance.html" "C:\0ALI\WebSites\BasitApi\app_offline.htm" -Force
          Start-Sleep -Seconds 2
          
          # Deploy new files
          Write-Host "Step 4: Deploying new files..."
          robocopy "$env:TEMP\publish\api" "C:\0ALI\WebSites\BasitApi" /E /R:2 /W:2 /NP
          if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
          $global:LASTEXITCODE = 0
          
          # Restore appsettings files
          Write-Host "Step 5: Restoring appsettings files..."
          if (Test-Path "C:\temp\deployment-backup\api-appsettings.json") {
            Copy-Item "C:\temp\deployment-backup\api-appsettings.json" "C:\0ALI\WebSites\BasitApi\appsettings.json" -Force
            Write-Host "  - appsettings.json restored"
          }
          Get-ChildItem "C:\temp\deployment-backup\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "C:\0ALI\WebSites\BasitApi\" -Force
            Write-Host "  - $($_.Name) restored"
          }
          
          # Restore web.config
          if (Test-Path "C:\temp\deployment-backup\api-web.config") {
            Copy-Item "C:\temp\deployment-backup\api-web.config" "C:\0ALI\WebSites\BasitApi\web.config" -Force
            Write-Host "  - web.config restored"
          }
          
          # Restore wwwroot
          if (Test-Path "C:\temp\deployment-backup\api-wwwroot") {
            Write-Host "Step 6: Restoring wwwroot (user files)..."
            robocopy "C:\temp\deployment-backup\api-wwwroot" "C:\0ALI\WebSites\BasitApi\wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
            if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
            $global:LASTEXITCODE = 0
            Write-Host "  - wwwroot restored successfully"
          }
          
          # Verify critical files
          Write-Host "Step 7: Verifying critical files..."
          $apiCriticalFiles = @(
            "C:\0ALI\WebSites\BasitApi\appsettings.json",
            "C:\0ALI\WebSites\BasitApi\Api.dll"
          )
          foreach ($file in $apiCriticalFiles) {
            if (Test-Path $file) {
              Write-Host "  - VERIFIED: $file exists" -ForegroundColor Green
            } else {
              Write-Host "  - ERROR: $file is missing!" -ForegroundColor Red
              exit 1
            }
          }
          
          # Disable maintenance mode
          Write-Host "Step 8: Disabling maintenance mode..."
          Remove-Item "C:\0ALI\WebSites\BasitApi\app_offline.htm" -ErrorAction SilentlyContinue
          
          Write-Host "=========================================="
          Write-Host "‚úÖ BasitApi deployed successfully!" -ForegroundColor Green
          Write-Host "=========================================="
      
      # 1Ô∏è‚É£3Ô∏è‚É£ Deploy Dashboard to IIS (COMMENTED OUT FOR FASTER API-ONLY DEPLOYMENT)
      # - name: Deploy Dashboard to IIS
      #   run: |
      #     Write-Host "=========================================="
      #     Write-Host "Deploying BasitDashboard..."
      #     Write-Host "=========================================="
      #     
      #     # Backup web.config
      #     Write-Host "Step 1: Backing up web.config..."
      #     if (Test-Path "C:\0ALI\WebSites\BasitDashboard\web.config") {
      #       Copy-Item "C:\0ALI\WebSites\BasitDashboard\web.config" "C:\temp\deployment-backup\dash-web.config" -Force
      #       Write-Host "  - web.config backed up"
      #     }
      #     
      #     # Backup appsettings
      #     Write-Host "Step 2: Backing up appsettings..."
      #     if (Test-Path "C:\0ALI\WebSites\BasitDashboard\appsettings.json") {
      #       Copy-Item "C:\0ALI\WebSites\BasitDashboard\appsettings.json" "C:\temp\deployment-backup\dash-appsettings.json" -Force
      #       Write-Host "  - appsettings.json backed up"
      #     }
      #     Get-ChildItem "C:\0ALI\WebSites\BasitDashboard\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
      #       Copy-Item $_.FullName "C:\temp\deployment-backup\" -Force
      #       Write-Host "  - $($_.Name) backed up"
      #     }
      #     
      #     # Enable maintenance mode
      #     Write-Host "Step 3: Enabling maintenance mode..."
      #     Copy-Item "$env:GITHUB_WORKSPACE\.github\workflows\maintenance.html" "C:\0ALI\WebSites\BasitDashboard\app_offline.htm" -Force
      #     Start-Sleep -Seconds 2
      #     
      #     # Clean old _framework folder (important for WASM updates)
      #     Write-Host "Step 4: Cleaning old _framework folder..."
      #     if (Test-Path "C:\0ALI\WebSites\BasitDashboard\_framework") {
      #       Remove-Item "C:\0ALI\WebSites\BasitDashboard\_framework" -Recurse -Force
      #       Write-Host "  - Old _framework removed"
      #     }
      #     
      #     # Deploy new files (from wwwroot to root)
      #     Write-Host "Step 5: Deploying Blazor WASM files..."
      #     robocopy "$env:TEMP\publish\dashboard\wwwroot" "C:\0ALI\WebSites\BasitDashboard" /E /R:2 /W:2 /NP
      #     if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
      #     $global:LASTEXITCODE = 0
      #     
      #     # Copy web.config from publish root
      #     if (Test-Path "$env:TEMP\publish\dashboard\web.config") {
      #       Copy-Item "$env:TEMP\publish\dashboard\web.config" "C:\0ALI\WebSites\BasitDashboard\web.config" -Force
      #       Write-Host "  - web.config deployed"
      #     }
      #     
      #     # Restore backed up web.config (if custom settings exist)
      #     Write-Host "Step 6: Restoring custom web.config (if exists)..."
      #     if (Test-Path "C:\temp\deployment-backup\dash-web.config") {
      #       $backupConfig = Get-Content "C:\temp\deployment-backup\dash-web.config" -Raw
      #       if ($backupConfig -match "<!-- CUSTOM CONFIG -->") {
      #         Copy-Item "C:\temp\deployment-backup\dash-web.config" "C:\0ALI\WebSites\BasitDashboard\web.config" -Force
      #         Write-Host "  - Custom web.config restored" -ForegroundColor Cyan
      #       } else {
      #         Write-Host "  - Using default web.config (no custom settings detected)"
      #       }
      #     }
      #     
      #     # Restore custom appsettings folders
      #     Write-Host "Step 7: Restoring appsettings..."
      #     if (Test-Path "C:\temp\deployment-backup\dash-appsettings.json") {
      #       Copy-Item "C:\temp\deployment-backup\dash-appsettings.json" "C:\0ALI\WebSites\BasitDashboard\appsettings.json" -Force
      #       Write-Host "  - appsettings.json restored"
      #     }
      #     Get-ChildItem "C:\temp\deployment-backup\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
      #       $destPath = "C:\0ALI\WebSites\BasitDashboard\$($_.Name)"
      #       Copy-Item $_.FullName $destPath -Force
      #       Write-Host "  - $($_.Name) restored"
      #     }
      #     
      #     # Verify critical Blazor WASM files
      #     Write-Host "Step 8: Verifying critical WASM files..."
      #     $criticalFiles = @(
      #       "C:\0ALI\WebSites\BasitDashboard\index.html",
      #       "C:\0ALI\WebSites\BasitDashboard\_framework\blazor.webassembly.js",
      #       "C:\0ALI\WebSites\BasitDashboard\_framework\blazor.boot.json",
      #       "C:\0ALI\WebSites\BasitDashboard\web.config"
      #     )
      #     
      #     $allFilesExist = $true
      #     foreach ($file in $criticalFiles) {
      #       if (Test-Path $file) {
      #         Write-Host "  - VERIFIED: $(Split-Path $file -Leaf)" -ForegroundColor Green
      #       } else {
      #         Write-Host "  - ERROR: $(Split-Path $file -Leaf) is missing!" -ForegroundColor Red
      #         $allFilesExist = $false
      #       }
      #     }
      #     
      #     # Check WASM files (including hashed names)
      #     $wasmFiles = Get-ChildItem "C:\0ALI\WebSites\BasitDashboard\_framework" -Filter "*.wasm" -ErrorAction SilentlyContinue
      #     if ($wasmFiles.Count -gt 0) {
      #       Write-Host "  - VERIFIED: $($wasmFiles.Count) .wasm files deployed" -ForegroundColor Green
      #       
      #       # Show some key files
      #       $dotnetWasm = $wasmFiles | Where-Object { $_.Name -match "^dotnet\." } | Select-Object -First 1
      #       $dashboardWasm = $wasmFiles | Where-Object { $_.Name -match "^Dashboard\." } | Select-Object -First 1
      #       
      #       if ($dotnetWasm) {
      #         Write-Host "    ‚Ä¢ $($dotnetWasm.Name)" -ForegroundColor Cyan
      #       }
      #       if ($dashboardWasm) {
      #         Write-Host "    ‚Ä¢ $($dashboardWasm.Name)" -ForegroundColor Cyan
      #       }
      #     } else {
      #       Write-Host "  - ERROR: No .wasm files found in _framework!" -ForegroundColor Red
      #       $allFilesExist = $false
      #     }
      #     
      #     if (-not $allFilesExist) {
      #       Write-Host ""
      #       Write-Host "‚ùå Critical Blazor WASM files are missing!" -ForegroundColor Red
      #       Write-Host "Deployed _framework contents:" -ForegroundColor Yellow
      #       Get-ChildItem "C:\0ALI\WebSites\BasitDashboard\_framework" -ErrorAction SilentlyContinue | Select-Object Name | ForEach-Object { Write-Host "  - $($_.Name)" }
      #       exit 1
      #     }
      #     
      #     # Disable maintenance mode
      #     Write-Host "Step 9: Disabling maintenance mode..."
      #     Remove-Item "C:\0ALI\WebSites\BasitDashboard\app_offline.htm" -ErrorAction SilentlyContinue
      #     
      #     Write-Host "=========================================="
      #     Write-Host "‚úÖ BasitDashboard (Blazor WASM) deployed successfully!" -ForegroundColor Green
      #     Write-Host "=========================================="
      
      # 1Ô∏è‚É£4Ô∏è‚É£ Restart Application Pools
      - name: Restart Application Pools
        run: |
          Write-Host "=========================================="
          Write-Host "Restarting Application Pools..."
          Write-Host "=========================================="
          
          # Only restart API app pool (Dashboard commented out)
          $sites = @("BasitApi")
          foreach ($site in $sites) {
            try {
              $appPool = (Get-Website -Name $site).applicationPool
              if ($appPool) {
                Restart-WebAppPool -Name $appPool
                Write-Host "  - Restarted $site (App Pool: $appPool)" -ForegroundColor Green
                Start-Sleep -Seconds 3
              }
            } catch {
              Write-Host "  - Could not auto-detect pool for $site, trying direct restart..." -ForegroundColor Yellow
              try {
                Restart-WebAppPool -Name $site
                Write-Host "  - Restarted pool: $site" -ForegroundColor Green
                Start-Sleep -Seconds 3
              } catch {
                Write-Host "  - Manual restart may be needed for $site" -ForegroundColor Red
              }
            }
          }
          
          Write-Host ""
          Write-Host "‚ö†Ô∏è Note: Dashboard deployment is currently disabled" -ForegroundColor Yellow
      
      # 1Ô∏è‚É£5Ô∏è‚É£ Health Check
      - name: Health Check
        id: health-check
        run: |
          Write-Host "=========================================="
          Write-Host "Performing Health Checks..."
          Write-Host "=========================================="
          
          Start-Sleep -Seconds 5
          
          # Check API health
          $apiHealthy = $false
          try {
            $response = Invoke-WebRequest -Uri "http://localhost/api/health" -UseBasicParsing -TimeoutSec 30 -ErrorAction Stop
            if ($response.StatusCode -eq 200) {
              Write-Host "‚úÖ API is healthy (Status: $($response.StatusCode))" -ForegroundColor Green
              $apiHealthy = $true
            }
          } catch {
            $statusCode = $_.Exception.Response.StatusCode.value__
            Write-Host "‚ùå API health check failed (Status: $statusCode)" -ForegroundColor Red
            Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red
            
            if ($statusCode -eq 500) {
              Write-Host "‚ö†Ô∏è Error 500 detected - possible migration issue!" -ForegroundColor Yellow
              echo "API_HEALTH_FAILED=true" >> $env:GITHUB_OUTPUT
            }
          }
          
          # Dashboard health check COMMENTED OUT
          # try {
          #   $response = Invoke-WebRequest -Uri "http://localhost/dashboard" -UseBasicParsing -TimeoutSec 30 -ErrorAction Stop
          #   if ($response.StatusCode -eq 200) {
          #     # Check if response contains Blazor markers
          #     if ($response.Content -match "blazor|_framework") {
          #       Write-Host "‚úÖ Dashboard is healthy (Status: $($response.StatusCode))" -ForegroundColor Green
          #       Write-Host "   Blazor WASM detected in response" -ForegroundColor Cyan
          #     } else {
          #       Write-Host "‚ö†Ô∏è Dashboard loaded but Blazor markers not found" -ForegroundColor Yellow
          #     }
          #   }
          # } catch {
          #   $statusCode = $_.Exception.Response.StatusCode.value__
          #   Write-Host "‚ö†Ô∏è Dashboard health check failed (Status: $statusCode)" -ForegroundColor Yellow
          #   Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Yellow
          # }
          
          if (-not $apiHealthy) {
            Write-Host ""
            Write-Host "=========================================="
            Write-Host "‚ö†Ô∏è API HEALTH CHECK FAILED!" -ForegroundColor Red
            Write-Host "=========================================="
            exit 1
          }
          
          Write-Host ""
          Write-Host "‚ö†Ô∏è Note: Dashboard health check is currently disabled" -ForegroundColor Yellow
      
      # 1Ô∏è‚É£6Ô∏è‚É£ Rollback on Failure
      - name: Rollback Database on Failure
        if: failure() && steps.apply-migrations.outputs.MIGRATION_SUCCESS == 'false' && env.DB_BACKUP_PATH != ''
        run: |
          Write-Host "=========================================="
          Write-Host "‚ö†Ô∏è ROLLING BACK DATABASE..." -ForegroundColor Yellow
          Write-Host "=========================================="
          
          $backupPath = $env:DB_BACKUP_PATH
          $serverName = $env:DB_SERVER
          $databaseName = $env:DB_NAME
          $userId = $env:DB_USER
          $password = $env:DB_PASSWORD
          
          if (Test-Path $backupPath) {
            try {
              Write-Host "Restoring database from: $backupPath"
              Write-Host "Server: $serverName"
              Write-Host "Database: $databaseName"
              
              # Set database to SINGLE_USER mode
              Write-Host "Setting database to SINGLE_USER mode..."
              sqlcmd -S $serverName -U $userId -P $password -Q "ALTER DATABASE [$databaseName] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;"
              
              # Restore database
              Write-Host "Restoring database..."
              sqlcmd -S $serverName -U $userId -P $password -Q "RESTORE DATABASE [$databaseName] FROM DISK = N'$backupPath' WITH REPLACE, RECOVERY;"
              
              # Set database to MULTI_USER mode
              Write-Host "Setting database to MULTI_USER mode..."
              sqlcmd -S $serverName -U $userId -P $password -Q "ALTER DATABASE [$databaseName] SET MULTI_USER;"
              
              if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Database rolled back successfully!" -ForegroundColor Green
              } else {
                Write-Host "‚ùå Database rollback failed (Exit code: $LASTEXITCODE)!" -ForegroundColor Red
              }
            } catch {
              Write-Host "‚ùå Rollback error: $($_.Exception.Message)" -ForegroundColor Red
            }
          } else {
            Write-Host "‚ö†Ô∏è Backup file not found: $backupPath" -ForegroundColor Yellow
          }
      
      # 1Ô∏è‚É£7Ô∏è‚É£ Cleanup
      - name: Cleanup
        if: always()
        run: |
          Write-Host "=========================================="
          Write-Host "Cleaning up..."
          Write-Host "=========================================="
          
          Remove-Item "C:\temp\deployment-backup\*" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$env:TEMP\publish" -Recurse -Force -ErrorAction SilentlyContinue
          
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "   ‚úÖ DEPLOYMENT COMPLETED!" -ForegroundColor Green
          Write-Host "=========================================="
          Write-Host "‚úÖ Tests: PASSED" -ForegroundColor Green
          Write-Host "‚úÖ Build: Separate for Test & Deploy" -ForegroundColor Cyan
          Write-Host "‚úÖ Database Migration: Applied (if needed)" -ForegroundColor Green
          Write-Host "‚úÖ API Protection:" -ForegroundColor Cyan
          Write-Host "   - appsettings.json: PRESERVED" -ForegroundColor Green
          Write-Host "   - web.config: PRESERVED" -ForegroundColor Green
          Write-Host "   - wwwroot (user files): PRESERVED" -ForegroundColor Green
          Write-Host ""
          Write-Host "‚ö†Ô∏è Dashboard Deployment: DISABLED (temporarily commented out)" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "‚úÖ App Pools: RESTARTED (API only)" -ForegroundColor Green
          Write-Host "‚úÖ Health Check: PASSED (API only)" -ForegroundColor Green
          Write-Host "=========================================="