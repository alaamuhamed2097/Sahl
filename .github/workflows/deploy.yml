name: üöÄ CI/CD - Build, Test, Migrate & Deploy to IIS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]  # ÿ®ÿ≥ ŸÑŸÖÿß Ÿäÿ™ÿπŸÖŸÑ ÿ™ÿπÿØŸäŸÑ ÿπŸÑŸâ ÿßŸÑŸÄ PR
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: Build and Test (ÿ®Ÿäÿ¥ÿ™ÿ∫ŸÑ ÿπŸÑŸâ PR Ÿà Push)
  # ============================================
  build-and-test:
    name: üß™ Build & Test
    runs-on: [self-hosted, windows, iis]
    
    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2Ô∏è‚É£ Setup .NET
      - name: Setup .NET
        run: echo "Using preinstalled .NET SDK on server"
      
      # 3Ô∏è‚É£ Restore dependencies
      - name: Restore dependencies
        run: |
          Write-Host "=========================================="
          Write-Host "Restoring NuGet packages..."
          Write-Host "=========================================="
          dotnet restore "$env:GITHUB_WORKSPACE\Sahl.slnx"
      
      # 4Ô∏è‚É£ Build solution (ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑!)
      - name: Build Solution
        run: |
          Write-Host "=========================================="
          Write-Host "Building solution in Release mode..."
          Write-Host "=========================================="
          dotnet build "$env:GITHUB_WORKSPACE\Sahl.slnx" -c Release --no-restore
      
      # 5Ô∏è‚É£ Run Unit Tests
      - name: Run Unit Tests
        run: |
          Write-Host "=========================================="
          Write-Host "Running Unit Tests..."
          Write-Host "=========================================="
          dotnet test "$env:GITHUB_WORKSPACE\tests\UnitTests\UnitTests.csproj" `
            --configuration Release `
            --no-build `
            --verbosity normal `
            --logger "trx;LogFileName=unit-test-results.trx" `
            --logger "console;verbosity=detailed" `
            --collect:"XPlat Code Coverage" `
            --results-directory "$env:TEMP\TestResults\Unit"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Unit tests failed!" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Unit tests passed!" -ForegroundColor Green
      
      # 6Ô∏è‚É£ Run Integration Tests
      - name: Run Integration Tests
        run: |
          Write-Host "=========================================="
          Write-Host "Running Integration Tests..."
          Write-Host "=========================================="
          dotnet test "$env:GITHUB_WORKSPACE\tests\IntegrationTests\IntegrationTests.csproj" `
            --configuration Release `
            --no-build `
            --verbosity normal `
            --logger "trx;LogFileName=integration-test-results.trx" `
            --logger "console;verbosity=detailed" `
            --collect:"XPlat Code Coverage" `
            --results-directory "$env:TEMP\TestResults\Integration"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Integration tests failed!" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Integration tests passed!" -ForegroundColor Green
      
      # 7Ô∏è‚É£ Test Summary
      - name: Test Summary
        if: always()
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "           TEST SUMMARY" -ForegroundColor Cyan
          Write-Host "=========================================="
          
          if (Test-Path "$env:TEMP\TestResults\Unit\unit-test-results.trx") {
            [xml]$unitResults = Get-Content "$env:TEMP\TestResults\Unit\unit-test-results.trx"
            $unitTotal = $unitResults.TestRun.ResultSummary.Counters.total
            $unitPassed = $unitResults.TestRun.ResultSummary.Counters.passed
            $unitFailed = $unitResults.TestRun.ResultSummary.Counters.failed
            
            Write-Host "Unit Tests:" -ForegroundColor White
            Write-Host "  Total:  $unitTotal" -ForegroundColor White
            Write-Host "  Passed: $unitPassed" -ForegroundColor Green
            Write-Host "  Failed: $unitFailed" -ForegroundColor $(if ($unitFailed -gt 0) { "Red" } else { "Green" })
          }
          
          if (Test-Path "$env:TEMP\TestResults\Integration\integration-test-results.trx") {
            [xml]$integrationResults = Get-Content "$env:TEMP\TestResults\Integration\integration-test-results.trx"
            $intTotal = $integrationResults.TestRun.ResultSummary.Counters.total
            $intPassed = $integrationResults.TestRun.ResultSummary.Counters.passed
            $intFailed = $integrationResults.TestRun.ResultSummary.Counters.failed
            
            Write-Host ""
            Write-Host "Integration Tests:" -ForegroundColor White
            Write-Host "  Total:  $intTotal" -ForegroundColor White
            Write-Host "  Passed: $intPassed" -ForegroundColor Green
            Write-Host "  Failed: $intFailed" -ForegroundColor $(if ($intFailed -gt 0) { "Red" } else { "Green" })
          }
          
          Write-Host "=========================================="
      
      # 8Ô∏è‚É£ Upload test results
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            ${{ runner.temp }}/TestResults/**/*.trx
            ${{ runner.temp }}/TestResults/**/coverage.cobertura.xml
          retention-days: 30
      
      # 9Ô∏è‚É£ Publish API (ÿ®ÿØŸàŸÜ build ÿ™ÿßŸÜŸä!)
      - name: Publish API
        run: |
          Write-Host "=========================================="
          Write-Host "Publishing API..."
          Write-Host "=========================================="
          dotnet publish "$env:GITHUB_WORKSPACE\src\Presentation\Api\Api.csproj" `
            -c Release `
            -o "$env:TEMP\publish\api" `
            --no-build `
            --no-restore
          
          Write-Host "‚úÖ API published successfully!" -ForegroundColor Green
      
      # üîü Verify Blazor WASM workload
      - name: Verify Blazor Workload
        run: |
          Write-Host "Checking Blazor workloads..."
          $wasm = dotnet workload list | Select-String "wasm-tools"
          if (-not $wasm) {
            Write-Host "Installing wasm-tools workload..."
            dotnet workload install wasm-tools --ignore-failed-sources
          } else {
            Write-Host "‚úÖ wasm-tools workload already installed"
          }
      
      # 1Ô∏è‚É£1Ô∏è‚É£ Publish Dashboard (ÿ®ÿØŸàŸÜ build ÿ™ÿßŸÜŸä!)
      - name: Publish Dashboard
        run: |
          Write-Host "=========================================="
          Write-Host "Publishing Blazor WASM Dashboard..."
          Write-Host "=========================================="
          
          dotnet publish "$env:GITHUB_WORKSPACE\src\Presentation\Dashboard\Dashboard.csproj" `
            -c Release `
            -o "$env:TEMP\publish\dashboard" `
            --no-build `
            --no-restore
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Dashboard publish failed!" -ForegroundColor Red
            exit 1
          }
          
          # Verify WASM files
          $wasmFiles = Get-ChildItem "$env:TEMP\publish\dashboard\wwwroot\_framework" -Filter "*.wasm" -ErrorAction SilentlyContinue
          if ($wasmFiles.Count -gt 0) {
            Write-Host "‚úÖ Found $($wasmFiles.Count) WASM files" -ForegroundColor Green
          } else {
            Write-Host "‚ùå No WASM files found!" -ForegroundColor Red
            exit 1
          }
      
      # 1Ô∏è‚É£2Ô∏è‚É£ Upload published artifacts (ŸÅŸÇÿ∑ ŸÑŸà ŸáŸäÿ™ÿπŸÖŸÑ Deploy)
      - name: Upload Published Artifacts
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: published-apps
          path: |
            ${{ runner.temp }}/publish/api
            ${{ runner.temp }}/publish/dashboard
          retention-days: 1

  # ============================================
  # Job 2: Deploy to IIS (ŸÅŸÇÿ∑ ÿπŸÑŸâ Push ŸÑŸÄ mainÿå ŸÖÿ¥ PR!)
  # ============================================
  deploy:
    name: üöÄ Deploy to IIS
    runs-on: [self-hosted, windows, iis]
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      # 1Ô∏è‚É£ Checkout code (for scripts only)
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2Ô∏è‚É£ Download published artifacts (ÿ®ÿØŸÑ ŸÖÿß ŸÜÿπŸÖŸÑ build ÿ™ÿßŸÜŸä!)
      - name: Download Published Artifacts
        uses: actions/download-artifact@v4
        with:
          name: published-apps
          path: ${{ runner.temp }}/publish
      
      # 3Ô∏è‚É£ Verify downloaded artifacts
      - name: Verify Downloaded Artifacts
        run: |
          Write-Host "=========================================="
          Write-Host "Verifying downloaded artifacts..."
          Write-Host "=========================================="
          
          if (Test-Path "$env:TEMP\publish\api\Api.dll") {
            Write-Host "‚úÖ API artifacts downloaded" -ForegroundColor Green
          } else {
            Write-Host "‚ùå API artifacts missing!" -ForegroundColor Red
            exit 1
          }
          
          if (Test-Path "$env:TEMP\publish\dashboard\wwwroot\index.html") {
            Write-Host "‚úÖ Dashboard artifacts downloaded" -ForegroundColor Green
          } else {
            Write-Host "‚ùå Dashboard artifacts missing!" -ForegroundColor Red
            exit 1
          }
      
      # 4Ô∏è‚É£ Install EF Core Tools (for migrations)
      - name: Install EF Core Tools
        run: |
          Write-Host "=========================================="
          Write-Host "Installing/Updating EF Core Tools..."
          Write-Host "=========================================="
          dotnet tool install --global dotnet-ef --version 8.* 2>$null
          if ($LASTEXITCODE -ne 0) {
            dotnet tool update --global dotnet-ef --version 8.*
          }
          dotnet ef --version
      
      # 5Ô∏è‚É£ Backup Database
      - name: Backup Database
        run: |
          Write-Host "=========================================="
          Write-Host "Creating Database Backup..."
          Write-Host "=========================================="
          
          $appsettingsPath = "C:\0ALI\WebSites\BasitApi\appsettings.json"
          if (Test-Path $appsettingsPath) {
            $appsettings = Get-Content $appsettingsPath | ConvertFrom-Json
            $connectionString = $appsettings.ConnectionStrings.DefaultConnection
            
            if ($connectionString -match "Server=([^;]+)") { $serverName = $matches[1].Trim() }
            if ($connectionString -match "Database=([^;]+)") { $databaseName = $matches[1].Trim() }
            if ($connectionString -match "user id=([^;]+)") { $userId = $matches[1].Trim() }
            if ($connectionString -match "password=([^;]+)") { $password = $matches[1].Trim() }
            
            if ($serverName -and $databaseName -and $userId -and $password) {
              $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
              $backupPath = "C:\temp\db-backups\${databaseName}_${timestamp}.bak"
              
              if (!(Test-Path "C:\temp\db-backups")) {
                New-Item -ItemType Directory -Force -Path "C:\temp\db-backups" | Out-Null
              }
              
              Write-Host "Database: $databaseName"
              Write-Host "Backup Path: $backupPath"
              
              try {
                $backupQuery = "BACKUP DATABASE [$databaseName] TO DISK = N'$backupPath' WITH FORMAT, INIT, NAME = N'$databaseName-Backup', SKIP, NOREWIND, NOUNLOAD, COMPRESSION, STATS = 10"
                sqlcmd -S $serverName -U $userId -P $password -Q $backupQuery
                
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "‚úÖ Database backup created!" -ForegroundColor Green
                  echo "DB_BACKUP_PATH=$backupPath" >> $env:GITHUB_ENV
                  echo "DB_SERVER=$serverName" >> $env:GITHUB_ENV
                  echo "DB_NAME=$databaseName" >> $env:GITHUB_ENV
                  echo "DB_USER=$userId" >> $env:GITHUB_ENV
                  echo "DB_PASSWORD=$password" >> $env:GITHUB_ENV
                }
              } catch {
                Write-Host "‚ö†Ô∏è Backup warning: $($_.Exception.Message)" -ForegroundColor Yellow
              }
              
              # Cleanup old backups (7+ days)
              Get-ChildItem "C:\temp\db-backups\*.bak" | Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-7) } | Remove-Item -Force
            }
          }

      # 6Ô∏è‚É£ Check for Pending Migrations
      - name: Check Pending Migrations
        id: check-migrations
        run: |
          Write-Host "=========================================="
          Write-Host "Checking for Pending Migrations..."
          Write-Host "=========================================="
          
          $appsettingsPath = "C:\0ALI\WebSites\BasitApi\appsettings.json"
          
          if (Test-Path $appsettingsPath) {
            $appsettings = Get-Content $appsettingsPath | ConvertFrom-Json
            $connectionString = $appsettings.ConnectionStrings.DefaultConnection
            
            # Build DAL & API for migrations check
            dotnet build "$env:GITHUB_WORKSPACE\src\Infrastructure\DAL\DAL.csproj" -c Release
            dotnet build "$env:GITHUB_WORKSPACE\src\Presentation\Api\Api.csproj" -c Release
            
            $migrationsOutput = dotnet ef migrations list `
              --project "$env:GITHUB_WORKSPACE\src\Infrastructure\DAL" `
              --startup-project "$env:GITHUB_WORKSPACE\src\Presentation\Api" `
              --connection "$connectionString" `
              --configuration Release `
              2>&1
            
            $hasPending = $false
            foreach ($line in $migrationsOutput) {
              if ($line -match "Pending" -or $line -match "\(Pending\)") {
                $hasPending = $true
                Write-Host "‚ö†Ô∏è Found pending migration: $line" -ForegroundColor Yellow
              }
            }
            
            if ($hasPending) {
              Write-Host "‚ö†Ô∏è There are pending migrations" -ForegroundColor Yellow
              echo "HAS_PENDING_MIGRATIONS=true" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "‚úÖ No pending migrations" -ForegroundColor Green
              echo "HAS_PENDING_MIGRATIONS=false" >> $env:GITHUB_OUTPUT
            }
          }
      
      # 7Ô∏è‚É£ Apply Database Migrations
      - name: Apply Database Migrations
        if: steps.check-migrations.outputs.HAS_PENDING_MIGRATIONS == 'true'
        id: apply-migrations
        run: |
          Write-Host "=========================================="
          Write-Host "Applying Database Migrations..."
          Write-Host "=========================================="
          
          $appsettingsPath = "C:\0ALI\WebSites\BasitApi\appsettings.json"
          $appsettings = Get-Content $appsettingsPath | ConvertFrom-Json
          $connectionString = $appsettings.ConnectionStrings.DefaultConnection
          
          try {
            dotnet ef database update `
              --project "$env:GITHUB_WORKSPACE\src\Infrastructure\DAL" `
              --startup-project "$env:GITHUB_WORKSPACE\src\Presentation\Api" `
              --connection "$connectionString" `
              --configuration Release `
              --verbose
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host "‚úÖ Migrations applied successfully!" -ForegroundColor Green
              echo "MIGRATION_SUCCESS=true" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "‚ùå Migration failed!" -ForegroundColor Red
              echo "MIGRATION_SUCCESS=false" >> $env:GITHUB_OUTPUT
              exit 1
            }
          } catch {
            Write-Host "‚ùå Migration error: $($_.Exception.Message)" -ForegroundColor Red
            echo "MIGRATION_SUCCESS=false" >> $env:GITHUB_OUTPUT
            exit 1
          }
      
      # 8Ô∏è‚É£ Prepare temp directory
      - name: Prepare temp directory
        run: |
          if (!(Test-Path "C:\temp\deployment-backup")) { 
            New-Item -ItemType Directory -Force -Path "C:\temp\deployment-backup" 
          }
      
      # 9Ô∏è‚É£ Deploy API to IIS
      - name: Deploy API to IIS
        run: |
          Write-Host "=========================================="
          Write-Host "Deploying API..."
          Write-Host "=========================================="
          
          # Backup configs
          if (Test-Path "C:\0ALI\WebSites\BasitApi\appsettings.json") {
            Copy-Item "C:\0ALI\WebSites\BasitApi\appsettings.json" "C:\temp\deployment-backup\" -Force
          }
          Get-ChildItem "C:\0ALI\WebSites\BasitApi\appsettings.*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "C:\temp\deployment-backup\" -Force
          }
          if (Test-Path "C:\0ALI\WebSites\BasitApi\web.config") {
            Copy-Item "C:\0ALI\WebSites\BasitApi\web.config" "C:\temp\deployment-backup\" -Force
          }
          
          # Backup wwwroot
          if (Test-Path "C:\0ALI\WebSites\BasitApi\wwwroot") {
            robocopy "C:\0ALI\WebSites\BasitApi\wwwroot" "C:\temp\deployment-backup\api-wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
            if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
            $global:LASTEXITCODE = 0
          }
          
          # Maintenance mode
          Copy-Item "$env:GITHUB_WORKSPACE\.github\workflows\maintenance.html" "C:\0ALI\WebSites\BasitApi\app_offline.htm" -Force
          Start-Sleep -Seconds 2
          
          # Deploy
          robocopy "$env:TEMP\publish\api" "C:\0ALI\WebSites\BasitApi" /E /R:2 /W:2 /NP
          if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
          $global:LASTEXITCODE = 0
          
          # Restore configs
          Get-ChildItem "C:\temp\deployment-backup\appsettings*.json" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "C:\0ALI\WebSites\BasitApi\" -Force
          }
          if (Test-Path "C:\temp\deployment-backup\web.config") {
            Copy-Item "C:\temp\deployment-backup\web.config" "C:\0ALI\WebSites\BasitApi\" -Force
          }
          
          # Restore wwwroot
          if (Test-Path "C:\temp\deployment-backup\api-wwwroot") {
            robocopy "C:\temp\deployment-backup\api-wwwroot" "C:\0ALI\WebSites\BasitApi\wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
            if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
            $global:LASTEXITCODE = 0
          }
          
          # Remove maintenance mode
          Remove-Item "C:\0ALI\WebSites\BasitApi\app_offline.htm" -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ API deployed!" -ForegroundColor Green
      
      # üîü Deploy Dashboard to IIS
      - name: Deploy Dashboard to IIS
        run: |
          Write-Host "=========================================="
          Write-Host "Deploying Dashboard..."
          Write-Host "=========================================="
          
          # Backup configs
          if (Test-Path "C:\0ALI\WebSites\BasitDashboard\web.config") {
            Copy-Item "C:\0ALI\WebSites\BasitDashboard\web.config" "C:\temp\deployment-backup\dash-web.config" -Force
          }
          
          # Maintenance mode
          Copy-Item "$env:GITHUB_WORKSPACE\.github\workflows\maintenance.html" "C:\0ALI\WebSites\BasitDashboard\app_offline.htm" -Force
          Start-Sleep -Seconds 2
          
          # Clean old _framework
          if (Test-Path "C:\0ALI\WebSites\BasitDashboard\_framework") {
            Remove-Item "C:\0ALI\WebSites\BasitDashboard\_framework" -Recurse -Force
          }
          
          # Deploy
          robocopy "$env:TEMP\publish\dashboard\wwwroot" "C:\0ALI\WebSites\BasitDashboard" /E /R:2 /W:2 /NP
          if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }
          $global:LASTEXITCODE = 0
          
          # Copy web.config
          if (Test-Path "$env:TEMP\publish\dashboard\web.config") {
            Copy-Item "$env:TEMP\publish\dashboard\web.config" "C:\0ALI\WebSites\BasitDashboard\" -Force
          }
          
          # Restore custom web.config if exists
          if (Test-Path "C:\temp\deployment-backup\dash-web.config") {
            $backupConfig = Get-Content "C:\temp\deployment-backup\dash-web.config" -Raw
            if ($backupConfig -match "<!-- CUSTOM CONFIG -->") {
              Copy-Item "C:\temp\deployment-backup\dash-web.config" "C:\0ALI\WebSites\BasitDashboard\web.config" -Force
            }
          }
          
          # Verify WASM files
          $wasmFiles = Get-ChildItem "C:\0ALI\WebSites\BasitDashboard\_framework" -Filter "*.wasm" -ErrorAction SilentlyContinue
          if ($wasmFiles.Count -eq 0) {
            Write-Host "‚ùå No WASM files deployed!" -ForegroundColor Red
            exit 1
          }
          
          # Remove maintenance mode
          Remove-Item "C:\0ALI\WebSites\BasitDashboard\app_offline.htm" -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ Dashboard deployed!" -ForegroundColor Green
      
      # 1Ô∏è‚É£1Ô∏è‚É£ Restart Application Pools
      - name: Restart Application Pools
        run: |
          Write-Host "Restarting Application Pools..."
          $sites = @("BasitApi", "BasitDashboard")
          foreach ($site in $sites) {
            try {
              $appPool = (Get-Website -Name $site).applicationPool
              if ($appPool) {
                Restart-WebAppPool -Name $appPool
                Write-Host "‚úÖ Restarted $site" -ForegroundColor Green
                Start-Sleep -Seconds 3
              }
            } catch {
              Write-Host "‚ö†Ô∏è Could not restart $site" -ForegroundColor Yellow
            }
          }
      
      # 1Ô∏è‚É£2Ô∏è‚É£ Health Check
      - name: Health Check
        run: |
          Write-Host "=========================================="
          Write-Host "Health Checks..."
          Write-Host "=========================================="
          
          Start-Sleep -Seconds 5
          
          try {
            $response = Invoke-WebRequest -Uri "http://localhost/api/health" -UseBasicParsing -TimeoutSec 30
            if ($response.StatusCode -eq 200) {
              Write-Host "‚úÖ API is healthy" -ForegroundColor Green
            }
          } catch {
            Write-Host "‚ùå API health check failed" -ForegroundColor Red
            exit 1
          }
          
          try {
            $response = Invoke-WebRequest -Uri "http://localhost/dashboard" -UseBasicParsing -TimeoutSec 30
            if ($response.StatusCode -eq 200) {
              Write-Host "‚úÖ Dashboard is healthy" -ForegroundColor Green
            }
          } catch {
            Write-Host "‚ö†Ô∏è Dashboard check failed" -ForegroundColor Yellow
          }
      
      # 1Ô∏è‚É£3Ô∏è‚É£ Cleanup
      - name: Cleanup
        if: always()
        run: |
          Remove-Item "C:\temp\deployment-backup\*" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$env:TEMP\publish" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "‚úÖ Deployment Complete!" -ForegroundColor Green