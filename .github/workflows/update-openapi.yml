name: 🚀 Deploy ASP.NET API & Blazor Dashboard to IIS
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, windows, iis]
    steps:
      # 1️⃣ تحميل الكود من GitHub
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2️⃣ استخدام الـ .NET المثبت مسبقًا
      - name: Setup .NET
        run: echo "Using preinstalled .NET SDK on server"
      
      # 3️⃣ استرجاع الـ NuGet Packages
      - name: Restore dependencies
        run: dotnet restore
        
      # 4️⃣ تثبيت Blazor Workload
      - name: Install Blazor Workload
        run: dotnet workload restore
      
      # 5️⃣ بناء مشروع الـ API
      - name: Build API
        run: dotnet build ./src/Presentation/Api -c Release --no-restore
      
      # 6️⃣ بناء مشروع الـ Blazor Dashboard
      - name: Build Blazor Dashboard
        run: dotnet build ./src/Presentation/Dashboard -c Release --no-restore
        
      # 7️⃣ نشر (Publish) الـ API
      - name: Publish API
        run: |
          if (!(Test-Path "C:\publish")) { New-Item -ItemType Directory -Force -Path "C:\publish" }
          dotnet publish ./src/Presentation/Api -c Release -o "C:\publish\SahlApi"
      
      # 8️⃣ نشر (Publish) الـ Dashboard
      - name: Publish Dashboard
        run: dotnet publish ./src/Presentation/Dashboard -c Release -o "C:\publish\SahlDashboard"
      
      # 9️⃣ حذف الملفات الحساسة قبل النشر
      - name: Remove sensitive files
        run: |
          Remove-Item "C:\publish\SahlApi\appsettings.json" -ErrorAction SilentlyContinue
          Remove-Item "C:\publish\SahlApi\appsettings.*.json" -ErrorAction SilentlyContinue
          Remove-Item "C:\publish\SahlApi\web.config" -ErrorAction SilentlyContinue
          Remove-Item "C:\publish\SahlDashboard\appsettings.json" -ErrorAction SilentlyContinue
          Remove-Item "C:\publish\SahlDashboard\appsettings.*.json" -ErrorAction SilentlyContinue
          Remove-Item "C:\publish\SahlDashboard\web.config" -ErrorAction SilentlyContinue
          echo "✅ Sensitive files removed"
      
      # 🔟 نسخ الملفات المتغيرة فقط + استثناء الملفات الحساسة
      - name: Deploy to IIS (incremental)
        run: |
          echo "Deploying only changed files to IIS..."
          
          # تأكد من وجود المجلدات
          if (!(Test-Path "C:\0ALI\WebSites\SahlApi")) { 
            New-Item -ItemType Directory -Force -Path "C:\0ALI\WebSites\SahlApi" 
          }
          if (!(Test-Path "C:\0ALI\WebSites\SahlDashboard")) { 
            New-Item -ItemType Directory -Force -Path "C:\0ALI\WebSites\SahlDashboard" 
          }
          
          # ⚡ نسخ الملفات المتغيرة فقط واستثناء appsettings و web.config
          # /XO = استثناء الملفات الأقدم (ينسخ الأحدث بس)
          # /XF = استثناء ملفات معينة
          # /NP = بدون progress (عشان الـ log يكون نظيف)
          # /NDL = بدون قائمة المجلدات
          # /NFL = بدون قائمة الملفات
          
          robocopy "C:\publish\SahlApi" "C:\0ALI\WebSites\SahlApi" `
            /XO `
            /XF "appsettings.json" "appsettings.*.json" "web.config" `
            /NP /NDL /R:3 /W:5
          
          robocopy "C:\publish\SahlDashboard" "C:\0ALI\WebSites\SahlDashboard" `
            /XO `
            /XF "appsettings.json" "appsettings.*.json" "web.config" `
            /NP /NDL /R:3 /W:5
          
          echo "✅ Files synced successfully"
          
          # إعادة تشغيل IIS
          iisreset
      
      # 1️⃣1️⃣ تأكيد النجاح
      - name: Done
        run: |
          echo "✅ Deployment completed successfully!"
          echo "📊 Only modified files were deployed"
          echo "🔒 Config files preserved on server"