name: 🚀 Deploy ASP.NET API & Blazor Dashboard to IIS
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, windows, iis]
    steps:
      # 1️⃣ تحميل الكود من GitHub
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2️⃣ استخدام الـ .NET المثبت مسبقًا
      - name: Setup .NET
        run: echo "Using preinstalled .NET SDK on server"
      
      # 3️⃣ استرجاع الـ NuGet Packages
      - name: Restore dependencies
        run: dotnet restore
        
      # 4️⃣ التحقق من Blazor Workload (بدون إعادة تثبيت)
      - name: Verify Blazor Workload
        run: |
          Write-Host "✅ Using preinstalled Blazor workload"
          dotnet workload list
      
      # 5️⃣ بناء مشروع الـ API (Incremental Build)
      - name: Build API
        run: dotnet build ./src/Presentation/Api -c Release --no-restore /p:UseIncrementalBuild=true
      
      # 6️⃣ بناء مشروع الـ Blazor Dashboard (Incremental Build)
      - name: Build Blazor Dashboard
        run: dotnet build ./src/Presentation/Dashboard -c Release --no-restore /p:UseIncrementalBuild=true
      
      # 7️⃣ تجهيز مجلد مؤقت للـ backup
      - name: Prepare temp directory
        run: |
          if (!(Test-Path "C:\temp\deployment-backup")) { 
            New-Item -ItemType Directory -Force -Path "C:\temp\deployment-backup" 
          }
          Write-Host "✅ Temp directory ready"
      
      # 8️⃣ نشر الـ API مع حماية الملفات الحساسة
      - name: Deploy API to IIS
        run: |
          Write-Host "🚀 Deploying SahlApi..."
          
          # 1. Backup config files + wwwroot
          Write-Host "📦 Backing up sensitive files..."
          Copy-Item "C:\0ALI\WebSites\SahlApi\appsettings.json" "C:\temp\deployment-backup\api-appsettings.json" -ErrorAction SilentlyContinue
          Copy-Item "C:\0ALI\WebSites\SahlApi\appsettings.*.json" "C:\temp\deployment-backup\" -ErrorAction SilentlyContinue
          Copy-Item "C:\0ALI\WebSites\SahlApi\web.config" "C:\temp\deployment-backup\api-web.config" -ErrorAction SilentlyContinue
          
          # 2. Backup wwwroot (ملفات المستخدمين)
          if (Test-Path "C:\0ALI\WebSites\SahlApi\wwwroot") {
            Write-Host "💾 Backing up wwwroot (user files)..."
            robocopy "C:\0ALI\WebSites\SahlApi\wwwroot" "C:\temp\deployment-backup\api-wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
          }
          
          # 3. وضع الموقع في Maintenance Mode
          Write-Host "🔧 Enabling maintenance mode..."
          @'
          <!DOCTYPE html>
          <html dir="rtl" lang="ar">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>تحت الصيانة</title>
              <style>
                  body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f0f0f0; }
                  h1 { color: #333; }
                  p { color: #666; }
              </style>
          </head>
          <body>
              <h1>🔧 الموقع تحت الصيانة</h1>
              <p>سنعود قريباً... يرجى المحاولة بعد قليل</p>
              <p style="font-size: 12px; margin-top: 30px;">Updating to latest version...</p>
          </body>
          </html>
          '@ | Out-File "C:\0ALI\WebSites\SahlApi\app_offline.htm" -Encoding UTF8
          
          Start-Sleep -Seconds 2
          
          # 4. Publish مباشرة للموقع
          Write-Host "📤 Publishing new version..."
          dotnet publish ./src/Presentation/Api -c Release -o "C:\0ALI\WebSites\SahlApi" --no-build
          
          # 5. Restore config files
          Write-Host "♻️ Restoring config files..."
          Copy-Item "C:\temp\deployment-backup\api-appsettings.json" "C:\0ALI\WebSites\SahlApi\appsettings.json" -ErrorAction SilentlyContinue
          Copy-Item "C:\temp\deployment-backup\appsettings.*.json" "C:\0ALI\WebSites\SahlApi\" -ErrorAction SilentlyContinue
          Copy-Item "C:\temp\deployment-backup\api-web.config" "C:\0ALI\WebSites\SahlApi\web.config" -ErrorAction SilentlyContinue
          
          # 6. Restore wwwroot (ملفات المستخدمين)
          if (Test-Path "C:\temp\deployment-backup\api-wwwroot") {
            Write-Host "📁 Restoring wwwroot (user files)..."
            robocopy "C:\temp\deployment-backup\api-wwwroot" "C:\0ALI\WebSites\SahlApi\wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
          }
          
          # 7. إزالة Maintenance Mode
          Write-Host "✅ Disabling maintenance mode..."
          Remove-Item "C:\0ALI\WebSites\SahlApi\app_offline.htm" -ErrorAction SilentlyContinue
          
          Write-Host "✅ SahlApi deployed successfully!"
      
      # 9️⃣ نشر الـ Dashboard مع حماية الملفات الحساسة
      - name: Deploy Dashboard to IIS
        run: |
          Write-Host "🚀 Deploying SahlDashboard..."
          
          # 1. Backup config files + wwwroot
          Write-Host "📦 Backing up sensitive files..."
          Copy-Item "C:\0ALI\WebSites\SahlDashboard\appsettings.json" "C:\temp\deployment-backup\dash-appsettings.json" -ErrorAction SilentlyContinue
          Copy-Item "C:\0ALI\WebSites\SahlDashboard\appsettings.*.json" "C:\temp\deployment-backup\" -ErrorAction SilentlyContinue
          Copy-Item "C:\0ALI\WebSites\SahlDashboard\web.config" "C:\temp\deployment-backup\dash-web.config" -ErrorAction SilentlyContinue
          
          # 2. Backup wwwroot (ملفات المستخدمين)
          if (Test-Path "C:\0ALI\WebSites\SahlDashboard\wwwroot") {
            Write-Host "💾 Backing up wwwroot (user files)..."
            robocopy "C:\0ALI\WebSites\SahlDashboard\wwwroot" "C:\temp\deployment-backup\dash-wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
          }
          
          # 3. وضع الموقع في Maintenance Mode
          Write-Host "🔧 Enabling maintenance mode..."
          @'
          <!DOCTYPE html>
          <html dir="rtl" lang="ar">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>تحت الصيانة</title>
              <style>
                  body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f0f0f0; }
                  h1 { color: #333; }
                  p { color: #666; }
              </style>
          </head>
          <body>
              <h1>🔧 لوحة التحكم تحت الصيانة</h1>
              <p>سنعود قريباً... يرجى المحاولة بعد قليل</p>
              <p style="font-size: 12px; margin-top: 30px;">Updating dashboard...</p>
          </body>
          </html>
          '@ | Out-File "C:\0ALI\WebSites\SahlDashboard\app_offline.htm" -Encoding UTF8
          
          Start-Sleep -Seconds 2
          
          # 4. Publish مباشرة للموقع
          Write-Host "📤 Publishing new version..."
          dotnet publish ./src/Presentation/Dashboard -c Release -o "C:\0ALI\WebSites\SahlDashboard" --no-build
          
          # 5. Restore config files
          Write-Host "♻️ Restoring config files..."
          Copy-Item "C:\temp\deployment-backup\dash-appsettings.json" "C:\0ALI\WebSites\SahlDashboard\appsettings.json" -ErrorAction SilentlyContinue
          Copy-Item "C:\temp\deployment-backup\appsettings.*.json" "C:\0ALI\WebSites\SahlDashboard\" -ErrorAction SilentlyContinue
          Copy-Item "C:\temp\deployment-backup\dash-web.config" "C:\0ALI\WebSites\SahlDashboard\web.config" -ErrorAction SilentlyContinue
          
          # 6. Restore wwwroot (ملفات المستخدمين)
          if (Test-Path "C:\temp\deployment-backup\dash-wwwroot") {
            Write-Host "📁 Restoring wwwroot (user files)..."
            robocopy "C:\temp\deployment-backup\dash-wwwroot" "C:\0ALI\WebSites\SahlDashboard\wwwroot" /E /R:2 /W:2 /NP /NDL /NFL
          }
          
          # 7. إزالة Maintenance Mode
          Write-Host "✅ Disabling maintenance mode..."
          Remove-Item "C:\0ALI\WebSites\SahlDashboard\app_offline.htm" -ErrorAction SilentlyContinue
          
          Write-Host "✅ SahlDashboard deployed successfully!"
      
      # 🔟 إعادة تشغيل Application Pools
      - name: Restart Application Pools
        run: |
          Write-Host "🔄 Restarting Application Pools..."
          
          $sites = @("SahlApi", "SahlDashboard")
          
          foreach ($site in $sites) {
            try {
              $appPool = (Get-Website -Name $site).applicationPool
              if ($appPool) {
                Restart-WebAppPool -Name $appPool
                Write-Host "✅ Restarted $site (App Pool: $appPool)"
              }
            } catch {
              Write-Host "⚠️ Could not auto-detect pool for $site, trying direct restart..."
              try {
                Restart-WebAppPool -Name $site
                Write-Host "✅ Restarted pool: $site"
              } catch {
                Write-Host "❌ Manual restart may be needed for $site"
              }
            }
          }
      
      # 1️⃣1️⃣ تنظيف الملفات المؤقتة
      - name: Cleanup
        run: |
          Write-Host "🧹 Cleaning up backup files..."
          Remove-Item "C:\temp\deployment-backup\*" -Recurse -Force -ErrorAction SilentlyContinue
          
          Write-Host ""
          Write-Host "======================================"
          Write-Host "✅ Deployment Completed Successfully!"
          Write-Host "======================================"
          Write-Host "📊 Deployed with incremental build"
          Write-Host "🔒 Config files preserved"
          Write-Host "📁 wwwroot (user files) protected"
          Write-Host "🔄 App Pools restarted"
          Write-Host "⚡ Zero downtime deployment"
          Write-Host "======================================"