name: 🚀 Deploy ASP.NET API & Blazor Dashboard to IIS
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, windows, iis]
    steps:
      # 1️⃣ تحميل الكود من GitHub
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2️⃣ استخدام الـ .NET المثبت مسبقًا
      - name: Setup .NET
        run: echo "Using preinstalled .NET SDK on server"
      
      # 3️⃣ استرجاع الـ NuGet Packages
      - name: Restore dependencies
        run: dotnet restore
        
      # 4️⃣ تثبيت Blazor Workload
      - name: Install Blazor Workload
        run: dotnet workload restore
      
      # 5️⃣ بناء مشروع الـ API
      - name: Build API
        run: dotnet build ./src/Presentation/Api -c Release --no-restore
      
      # 6️⃣ بناء مشروع الـ Blazor Dashboard
      - name: Build Blazor Dashboard
        run: dotnet build ./src/Presentation/Dashboard -c Release --no-restore
        
      # 7️⃣ نشر (Publish) الـ API
      - name: Publish API
        run: |
          if (!(Test-Path "C:\publish")) { New-Item -ItemType Directory -Force -Path "C:\publish" }
          dotnet publish ./src/Presentation/Api -c Release -o "C:\publish\SahlApi"
      
      # 8️⃣ نشر (Publish) الـ Dashboard
      - name: Publish Dashboard
        run: dotnet publish ./src/Presentation/Dashboard -c Release -o "C:\publish\SahlDashboard"
      
      # 9️⃣ حذف الملفات الحساسة قبل النشر
      - name: Remove sensitive files
        run: |
          Remove-Item "C:\publish\SahlApi\appsettings.json" -ErrorAction SilentlyContinue
          Remove-Item "C:\publish\SahlApi\appsettings.*.json" -ErrorAction SilentlyContinue
          Remove-Item "C:\publish\SahlApi\web.config" -ErrorAction SilentlyContinue
          Remove-Item "C:\publish\SahlDashboard\appsettings.json" -ErrorAction SilentlyContinue
          Remove-Item "C:\publish\SahlDashboard\appsettings.*.json" -ErrorAction SilentlyContinue
          Remove-Item "C:\publish\SahlDashboard\web.config" -ErrorAction SilentlyContinue
          echo "✅ Sensitive files removed"
      
      # 🔟 نسخ الملفات المتغيرة فقط + استثناء الملفات الحساسة
      - name: Deploy to IIS (incremental)
        run: |
          echo "Deploying only changed files to IIS..."
          
          # تأكد من وجود المجلدات
          if (!(Test-Path "C:\0ALI\WebSites\SahlApi")) { 
            New-Item -ItemType Directory -Force -Path "C:\0ALI\WebSites\SahlApi" 
          }
          if (!(Test-Path "C:\0ALI\WebSites\SahlDashboard")) { 
            New-Item -ItemType Directory -Force -Path "C:\0ALI\WebSites\SahlDashboard" 
          }
          
          # ⚡ نسخ الملفات المتغيرة فقط واستثناء appsettings و web.config
          robocopy "C:\publish\SahlApi" "C:\0ALI\WebSites\SahlApi" `
            /XO `
            /XF "appsettings.json" "appsettings.*.json" "web.config" `
            /NP /NDL /R:3 /W:5
          
          robocopy "C:\publish\SahlDashboard" "C:\0ALI\WebSites\SahlDashboard" `
            /XO `
            /XF "appsettings.json" "appsettings.*.json" "web.config" `
            /NP /NDL /R:3 /W:5
          
          echo "✅ Files synced successfully"
      
      # 1️⃣1️⃣ إعادة تشغيل Application Pools بس (بدون توقيف كل IIS)
      - name: Restart Application Pools
        run: |
          Write-Host "🔄 Restarting Application Pools..."
          
          # الطريقة الذكية: جيب اسم الـ App Pool تلقائياً من الـ Website
          $sites = @("SahlApi", "SahlDashboard")
          
          foreach ($site in $sites) {
            try {
              $appPool = (Get-Website -Name $site).applicationPool
              if ($appPool) {
                Restart-WebAppPool -Name $appPool
                Write-Host "✅ Restarted $site (App Pool: $appPool)"
              } else {
                Write-Host "⚠️ Could not find App Pool for $site"
              }
            } catch {
              Write-Host "⚠️ Error restarting $site : $_"
              Write-Host "💡 Trying alternative method..."
              
              # بديل: حاول تعيد تشغيل بالاسم المباشر
              try {
                Restart-WebAppPool -Name $site
                Write-Host "✅ Restarted using pool name: $site"
              } catch {
                Write-Host "❌ Could not restart $site - may need manual restart"
              }
            }
          }
          
          Write-Host ""
          Write-Host "✅ Deployment completed successfully!"
          Write-Host "📊 Only modified files were deployed"
          Write-Host "🔒 Config files preserved on server"
          Write-Host "🔄 Application Pools restarted (not entire IIS)"