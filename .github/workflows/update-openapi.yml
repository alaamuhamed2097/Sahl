name: 🚀 Deploy ASP.NET API & Blazor Dashboard to IIS

on:
  push:
    branches:
      - main  # يشتغل لما تعمل push على main
  workflow_dispatch:  # تقدر تشغله يدويًا من GitHub Actions

jobs:
  deploy:
    runs-on: [self-hosted, windows, iis]  # ✅ نفس اللابلز اللي حطيتها في runner

    steps:
      # 1️⃣ تحميل الكود من GitHub
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2️⃣ استخدام الـ .NET المثبت مسبقًا
      - name: Setup .NET
        run: echo "Using preinstalled .NET SDK on server"

      # 3️⃣ استرجاع الـ NuGet Packages
      - name: Restore dependencies
        run: dotnet restore
        
      # 4️⃣ تثبيت Blazor Workload (مرة واحدة)
      - name: Install Blazor Workload
        run: dotnet workload restore

      # 5️⃣ بناء مشروع الـ API
      - name: Build API
        run: dotnet build ./src/Presentation/Api -c Release --no-restore

      # 6️⃣ بناء مشروع الـ Blazor Dashboard
      - name: Build Blazor Dashboard
        run: dotnet build ./src/Presentation/Dashboard -c Release --no-restore
        
      # 7️⃣ نشر (Publish) الـ API
      - name: Publish API
        run: |
          if (!(Test-Path "C:\publish")) { New-Item -ItemType Directory -Force -Path "C:\publish" }
          dotnet publish ./src/Presentation/Api -c Release -o "C:\publish\SahlApi"

      # 8️⃣ نشر (Publish) الـ Dashboard
      - name: Publish Dashboard
        run: dotnet publish ./src/Presentation/Dashboard -c Release -o "C:\publish\SahlDashboard"

      # 9️⃣ نسخ الملفات للمسارات الفعلية على السيرفر
      - name: Deploy to IIS
        run: |
          echo "Deploying API and Dashboard to IIS..."
          if (!(Test-Path "C:\0ALI\WebSites\SahlApi")) { New-Item -ItemType Directory -Force -Path "C:\0ALI\WebSites\SahlApi" }
          if (!(Test-Path "C:\0ALI\WebSites\SahlDashboard")) { New-Item -ItemType Directory -Force -Path "C:\0ALI\WebSites\SahlDashboard" }
          robocopy "C:\publish\SahlApi" "C:\0ALI\WebSites\SahlApi" /MIR
          robocopy "C:\publish\SahlDashboard" "C:\0ALI\WebSites\SahlDashboard" /MIR
          iisreset

      # 10 تأكيد النجاح
      - name: Done
        run: echo "✅ Deployment completed successfully!"
